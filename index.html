<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game Control</title>
<style>
  body{font-family:Arial, sans-serif;margin:0;background:#1e1e1e;color:#f5f5f5;text-align:center}
  header{display:flex;align-items:center;justify-content:center;background:#333;padding:10px 0;position:relative}
  header h1{margin:0;font-size:1.5em;text-align:center}
  .top-buttons{position:absolute;right:10px;top:8px;display:flex;gap:8px}
  .top-buttons button{background:none;border:none;font-size:22px;color:#fff;cursor:pointer}

  #teamInputs{display:flex;justify-content:center;align-items:center;gap:10px;margin:10px}
  #teamInputs input{padding:6px 10px;border-radius:6px;border:none;font-size:16px;text-align:center}
  .scoreBubble{
    display:inline-flex;align-items:center;justify-content:center;
    min-width:34px;height:34px;padding:0 8px;margin:0 6px;
    border-radius:8px;background:#111;color:#fff;font-weight:800;font-size:20px;
  }
  body.light-mode .scoreBubble{background:#e7e7e7;color:#111}

  .timer-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:6px 0 0 0}
  #timer{font-size:3em}
  .half-badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#444;color:#fff;font-size:12px;letter-spacing:.3px}

  .controls{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;background:#2e2e2e;padding:10px}
  .controls button{padding:6px 10px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer}

  /* Caixas grandes e m√°x 5/linha */
  #players{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:18px;width:95%;max-width:1300px;margin:12px auto;justify-items:center}
  .player{
    width:100%;max-width:260px;height:240px;border-radius:14px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;transition:.2s;background:#c0392b;color:#fff;position:relative;overflow:hidden
  }
  .player.active{background:#2ecc71;color:#000}
  .player strong{font-size:20px;margin-bottom:8px}
  .player .time{font-size:40px;font-weight:bold;line-height:1}
  .player .last{font-size:12px;opacity:.9;margin-top:6px}

  /* Badges */
  .gk-badge{
    position:absolute;top:8px;left:8px;width:28px;height:28px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);
    backdrop-filter:saturate(120%) blur(2px);font-size:16px;line-height:1
  }
  .card-badges{position:absolute;top:8px;right:8px;display:flex;gap:6px;align-items:center}
  .badge-fouls{min-width:22px;height:22px;border-radius:999px;background:#444;color:#fff;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;padding:0 6px}
  .badge-yc,.badge-rc{width:16px;height:22px;border-radius:3px;border:1px solid rgba(0,0,0,.35)}
  .badge-yc{background:#f1c40f}
  .badge-rc{background:#e74c3c}

  /* Fadiga (n√£o para GR) */
  .fatigue{position:absolute;left:8px;right:8px;bottom:8px;height:8px;border-radius:6px;background:rgba(255,255,255,0.25)}
  .fatigue-fill{height:100%;border-radius:6px;width:0%}

  .player.limit{outline:3px solid #ff4d4d;box-shadow:0 0 0 3px rgba(255,77,77,0.35)}
  .selectable{outline:3px dashed #fff; outline-offset:-4px}

  @media (max-width:1200px){#players{grid-template-columns:repeat(4,minmax(0,1fr));}}
  @media (max-width:900px){#players{grid-template-columns:repeat(3,minmax(0,1fr));}}
  @media (max-width:600px){#players{grid-template-columns:repeat(2,minmax(0,1fr));}}

  /* Tabela */
  .summary{width:90%;max-width:1100px;margin:18px auto;padding:0;background:#242424;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);overflow:hidden}
  .summary h3{margin:0;padding:12px 16px;background:#2f2f2f;border-bottom:1px solid #3a3a3a;text-align:left}
  .summary table{width:100%;border-collapse:separate;border-spacing:0}
  .summary thead th{position:sticky;top:0;background:#303030;z-index:1;text-transform:uppercase;font-size:12px;letter-spacing:.4px;color:#ddd;border-bottom:1px solid #3a3a3a;padding:10px 12px}
  .summary tbody td{padding:10px 12px;border-bottom:1px solid #333}
  .summary tbody tr:nth-child(even){background:rgba(255,255,255,0.03)}
  .summary tbody tr:hover{background:rgba(255,255,255,0.06)}
  .summary td:nth-child(1){text-align:left;font-weight:600}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700}
  .pill.work-pos{color:#2ecc71;background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.35)}
  .pill.work-neg{color:#e74c3c;background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.35)}

  /* Editar nomes (direita) */
  #editPanel{position:fixed; right:-420px; top:20%; width:380px; height:60%;
    background:rgba(0,0,0,0.92); border-left:2px solid #555; border-radius:10px 0 0 10px;
    padding:15px; box-shadow:-4px 0 8px rgba(0,0,0,.4); transition:right .2s; z-index:999; overflow-y:auto}
  #editPanel.open{ right:0; }
  #editPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  #editPanel .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  #editPanel .row input[type="text"]{flex:1;padding:6px;border-radius:6px;border:1px solid #777;background:#1f1f1f;color:#fff}
  #editPanel .row label{display:flex;align-items:center;gap:6px;color:#ddd;font-size:13px;white-space:nowrap}
  #editPanel .save-btn{width:100%; padding:8px; border:none; border-radius:6px; background:#0078d7; color:#fff; cursor:pointer; margin-top:8px}
  #editPanel h3{ margin:0 0 10px 0; }

  /* Hist√≥rico (esquerda) */
  #historyPanel{position:fixed; left:-420px; top:10%; width:380px; height:80%;
    background:rgba(0,0,0,0.92); border-right:2px solid #555; border-radius:0 10px 10px 0;
    padding:15px; box-shadow:4px 0 8px rgba(0,0,0,.4); transition:left .2s; z-index:999; overflow-y:auto}
  #historyPanel.open{ left:0; }
  #historyPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  .hist-item{background:#1f1f1f;border:1px solid #444;border-radius:8px;padding:8px;margin-bottom:8px;text-align:left}
  .hist-actions{display:flex;gap:6px;margin-top:6px}
  .hist-actions button{padding:6px 8px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer;font-size:12px}

  /* Timeline (s√≥ bot√µes) */
  #timelineBar{position:fixed;left:0;right:0;bottom:0;background:#222;border-top:1px solid #333;z-index:900;padding:8px 10px;box-shadow:0 -6px 16px rgba(0,0,0,.25)}
  #timelineBar .tl-actions{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:0}
  #timelineBar .tl-btn{background:#3a3a3a;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:13px}
  #tlClear{background:#a33;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
  #timelineFeed{display:none}
  .tl-gf{color:#2ecc71}.tl-ga{color:#e74c3c}.tl-fk{color:#f1c40f}.tl-yc{color:#f1c40f}.tl-rc{color:#e74c3c}
</style>
</head>
<body>
<header>
  <h1>Game Control</h1>
  <div class="top-buttons">
    <button id="themeToggle" title="Tema">üåô</button>
    <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
    <button id="editNamesBtn" title="Editar nomes">üë•</button>
    <button id="printBtn" title="Exportar PNG">üì∏</button>
  </div>
</header>

<!-- Equipas com marcador (bubbles) -->
<div id="teamInputs">
  <span class="scoreBubble" id="scoreA">0</span>
  <input id="teamA" placeholder="Equipa A" />
  <span style="font-weight:bold;">vs</span>
  <input id="teamB" placeholder="Equipa B" />
  <span class="scoreBubble" id="scoreB">0</span>
</div>

<div class="timer-row">
  <div id="timer">20:00</div>
  <span id="halfBadge" class="half-badge">1¬™ Parte</span>
</div>

<div class="controls">
  <input id="setMinutes" type="number" value="20" min="1" style="width:60px;">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausar</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">‚àí</button>
  <button id="saveGameBtn">Guardar Jogo</button>
  <button id="historyBtn">Hist√≥rico</button>
</div>

<div id="players"></div>

<div class="summary">
  <h3>Resumo de Jogo</h3>
  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>1¬™ Parte</th>
        <th>2¬™ Parte</th>
        <th>Total em Campo</th>
        <th>Tempo Fora</th>
        <th>Rota√ß√µes</th>
        <th>M√©dia</th>
        <th>% Jogo</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>

<!-- Painel editar nomes -->
<div id="editPanel">
  <button class="close-btn" id="closePanel">‚ùå</button>
  <h3>Editar Jogadores</h3>
  <div id="editList"></div>
  <button class="save-btn" id="saveNamesBtn">Guardar Altera√ß√µes</button>
</div>

<!-- Hist√≥rico -->
<div id="historyPanel">
  <button class="close-btn" id="closeHistory">‚ùå</button>
  <h3>Hist√≥rico de Jogos</h3>
  <div id="historyList"></div>
  <div style="margin-top:8px;display:flex;gap:6px;justify-content:center">
    <button id="exportAllCsvBtn">Exportar CSV (tudo)</button>
    <button id="clearHistoryBtn" style="background:#a33">Apagar Hist√≥rico</button>
  </div>
</div>

<!-- Timeline (s√≥ bot√µes) -->
<div id="timelineBar">
  <div class="tl-actions">
    <button class="tl-btn" data-type="GF_A" title="Golo a favor">‚öΩ +</button>
    <button class="tl-btn" data-type="GA_A" title="Golo sofrido">‚öΩ ‚àí</button>
    <button class="tl-btn tl-player" data-type="FK_P" title="Falta (seleciona jogador)">‚ùå Falta</button>
    <button class="tl-btn tl-player" data-type="YC_P" title="Amarelo (seleciona jogador)">üü® Amarelo</button>
    <button class="tl-btn tl-player" data-type="RC_P" title="Vermelho (seleciona jogador)">üü• Vermelho</button>
    <button id="tlClear" title="Limpar eventos">üßπ</button>
  </div>
  <div id="timelineFeed"></div>
</div>

<script>
/* ===== Estado base ===== */
let duration = 20*60, remaining = duration, running = false, firstHalf = true;
let players = [], theme = "dark", timerInterval=null, _lastTick=null;
let scoreA = 0, scoreB = 0;
const STORAGE_KEY="gameControlData_gcStable", HISTORY_KEY="gameControlHistory_v1";
const TL_KEY="gameControlTimeline_v1"; let timeline=[];
let pendingPlayerEvent=null; // FK_P | YC_P | RC_P

/* Fadiga */
const FATIGUE_K_UP=0.012, FATIGUE_K_DOWN=0.025, RED_THRESHOLD_SEC=180, YELLOW_THRESHOLD_SEC=90;

/* Modelo jogador */
const PLAYER_DEFAULTS={id:0,name:"",active:false,isGK:false,seconds:0,secondsOut:0,part1:0,part2:0,rotations:0,lastRotation:0,startTime:0,rotationTime:0,rotationOutTime:0,fatigue:0,plusMinus:0,fouls:0,yc:false,rc:false};

/* Utils */
const pad=n=>String(n).padStart(2,"0");
function formatTime(sec){sec=Math.max(0,Math.floor(sec));return `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;}
function updateTimerDisplay(){timer.textContent=formatTime(remaining);}
function updateHalfBadge(){halfBadge.textContent=firstHalf?"1¬™ Parte":"2¬™ Parte";}
function updateScoreUI(){ document.getElementById('scoreA').textContent = scoreA; document.getElementById('scoreB').textContent = scoreB; }
function fatigueColor(p){if(p.active){if(p.rotationTime>=RED_THRESHOLD_SEC)return"#e74c3c";if(p.rotationTime>=YELLOW_THRESHOLD_SEC)return"#e6b800";return"#2ecc71";}else{if(p.fatigue>=0.66)return"#e74c3c";if(p.fatigue>=0.33)return"#e6b800";return"#2ecc71";}}

/* DOM jogadores */
function buildPlayersDOM(){
  const pDiv=document.getElementById("players"); pDiv.innerHTML="";
  players.forEach(p=>{
    const d=document.createElement("div");
    d.id="player"+p.id; d.className="player "+(p.active?"active":"inactive");
    const ds=p.active?p.rotationTime:p.rotationOutTime;
    const gk=p.isGK?'<span class="gk-badge">üß§</span>':'';
    const fat=p.isGK?'':`<div class="fatigue"><div class="fatigue-fill" id="fatigue${p.id}" style="width:0%"></div></div>`;
    const yc=p.yc?'<span class="badge-yc" title="Amarelo"></span>':'';
    const rc=p.rc?'<span class="badge-rc" title="Vermelho"></span>':'';
    const fl=p.fouls>0?`<span class="badge-fouls" title="Faltas">${p.fouls}</span>`:'';
    d.innerHTML=`${gk}<div class="card-badges">${fl}${yc}${rc}</div>
      <strong>${p.name}</strong>
      <div class="time">${formatTime(ds)}</div>
      <div class="last">${!p.active&&p.lastRotation>0?"√ölt. rota√ß√£o: "+formatTime(p.lastRotation):""}</div>
      ${fat}`;
    d.onclick=()=>onPlayerClick(p.id);
    pDiv.appendChild(d);
  });
}
function updatePlayersUI(){
  players.forEach(p=>{
    const d=document.getElementById("player"+p.id); if(!d) return;
    d.className="player "+(p.active?"active":"inactive")+(pendingPlayerEvent?" selectable":"");
    const ds=p.active?p.rotationTime:p.rotationOutTime;
    d.querySelector(".time").textContent=formatTime(ds);
    d.querySelector(".last").textContent=(!p.active&&p.lastRotation>0)?("√ölt. rota√ß√£o: "+formatTime(p.lastRotation)):"";
    d.querySelector("strong").textContent=p.name;
    const badges=d.querySelector(".card-badges");
    badges.innerHTML=(p.fouls>0?`<span class="badge-fouls" title="Faltas">${p.fouls}</span>`:'')+(p.yc?'<span class="badge-yc" title="Amarelo"></span>':'')+(p.rc?'<span class="badge-rc" title="Vermelho"></span>':'');
    if(!p.isGK){const ff=document.getElementById("fatigue"+p.id); if(ff){ff.style.width=Math.round((p.fatigue||0)*100)+"%"; ff.style.background=fatigueColor(p);}}
    let gkb=d.querySelector(".gk-badge");
    if(p.isGK){ if(!gkb){gkb=document.createElement("span"); gkb.className="gk-badge"; gkb.textContent="üß§"; d.prepend(gkb);} }
    else if(gkb){ gkb.remove(); }
  });
}

/* Contagem jogadores */
function ensurePlayerCount(n){
  while(players.length<n){const id=players.length?(Math.max(...players.map(x=>x.id))+1):1; players.push({...PLAYER_DEFAULTS,id,name:"Jogador "+id});}
  while(players.length>n){players.pop();}
  buildPlayersDOM(); updatePlayersUI(); updateSummary(); saveData();
}
function activeCount(){return players.reduce((a,p)=>a+(p.active?1:0),0)}
function flashLimit(id){const d=document.getElementById("player"+id); if(!d)return; d.classList.add("limit"); setTimeout(()=>d.classList.remove("limit"),600);}

/* Tabela */
function updateSummary(){
  const tb=summaryBody; tb.innerHTML="";
  players.forEach(p=>{
    const total=p.part1+p.part2, avg=p.rotations>0?Math.floor(total/p.rotations):0;
    const percent=((total/(duration*(firstHalf?1:2)))*100).toFixed(1);
    const wl=p.seconds-p.secondsOut, cls=wl>=0?"work-pos":"work-neg", wlTxt=`${wl>=0?"+":""}${(wl/60).toFixed(1)}m`;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.name}${p.isGK?' üß§':''}</td>
      <td>${formatTime(p.part1)}</td><td>${formatTime(p.part2)}</td>
      <td>${formatTime(total)}</td><td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td><td>${formatTime(avg)}</td><td>${percent}%</td>
      <td><span class="pill ${cls}">${wlTxt}</span></td>`;
    tb.appendChild(tr);
  });
}

/* Cron√≥metro */
function tick(){
  const now=Date.now(); if(_lastTick===null)_lastTick=now;
  const delta=Math.max(0,Math.floor((now-_lastTick)/1000));
  if(delta>0){
    remaining=Math.max(0,remaining-delta);
    for(let i=0;i<delta;i++){
      players.forEach(p=>{
        if(p.active){
          p.seconds++; p.rotationTime++; if(firstHalf) p.part1++; else p.part2++;
          if(!p.isGK){p.fatigue+=FATIGUE_K_UP*(1-p.fatigue); if(p.fatigue>1)p.fatigue=1;}
        }else{
          p.secondsOut++; p.rotationOutTime++;
          if(!p.isGK){p.fatigue-=FATIGUE_K_DOWN*p.fatigue; if(p.fatigue<0)p.fatigue=0;}
        }
      });
    }
    _lastTick=now;
    updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
    if(remaining<=0) pauseTimer();
  }
}
function startTimer(){ if(running) return; running=true; _lastTick=Date.now(); clearInterval(timerInterval); timerInterval=setInterval(tick,250); saveData(); }
function pauseTimer(){ running=false; clearInterval(timerInterval); saveData(); }
function resetTimer(){
  pauseTimer();
  const m=parseInt(setMinutes.value)||20; duration=m*60; remaining=duration; firstHalf=true;
  players.forEach(p=>{p.seconds=0;p.secondsOut=0;p.part1=0;p.part2=0;p.rotations=0;p.lastRotation=0;p.rotationTime=0;p.rotationOutTime=0;if(!p.isGK)p.fatigue=0;p.plusMinus=0;p.fouls=0;p.yc=false;p.rc=false;});
  timeline=[]; scoreA=0; scoreB=0; updateScoreUI(); tlSave();
  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}
function intervalTimer(){
  pauseTimer(); firstHalf=false;
  const mins=parseInt(setMinutes.value)||20; duration=mins*60; remaining=duration;
  players.forEach(p=>{p.rotationTime=0;p.rotationOutTime=0; if(!p.isGK)p.fatigue=Math.max(0,p.fatigue*0.30);});
  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* Intera√ß√£o jogador + eventos individuais */
function onPlayerClick(id){
  if(pendingPlayerEvent){ addPlayerEvent(pendingPlayerEvent,id); pendingPlayerEvent=null; updatePlayersUI(); return; }
  const p=players.find(x=>x.id===id); if(!p) return;
  if(!p.active && activeCount()>=5){flashLimit(id); return;}
  p.active=!p.active;
  if(p.active){p.rotations++; p.startTime=Date.now(); p.rotationTime=0; p.rotationOutTime=0;}
  else{p.lastRotation=p.rotationTime; p.rotationTime=0; p.rotationOutTime=0;}
  updatePlayersUI(); updateSummary(); saveData();
}
function addPlayerEvent(type, playerId){
  const p=players.find(x=>x.id===playerId); if(!p) return;
  if(type==="FK_P") p.fouls++;
  if(type==="YC_P") p.yc=true;
  if(type==="RC_P") p.rc=true;
  timeline.unshift({t:Date.now(),clock:formatTime(remaining),type,playerId});
  tlSave(); updatePlayersUI(); saveData();
}
function setPending(type){ pendingPlayerEvent=type; updatePlayersUI(); }

/* Persist√™ncia */
function saveData(){
  const data={teamA:teamA.value||"",teamB:teamB.value||"",duration,remaining,firstHalf,running,theme,players,lastSaved:Date.now(),scoreA,scoreB};
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  tlSave(); updateScoreUI();
}
function loadData(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ players=[]; ensurePlayerCount(14); updateScoreUI(); updateTimerDisplay(); updateHalfBadge(); updateSummary(); tlLoad(); return; }
    const d=JSON.parse(raw);
    teamA.value=d.teamA||""; teamB.value=d.teamB||"";
    duration=typeof d.duration==="number"?d.duration:duration;
    remaining=typeof d.remaining==="number"?d.remaining:remaining;
    firstHalf=typeof d.firstHalf==="boolean"?d.firstHalf:firstHalf;
    running=!!d.running; theme=d.theme||theme;
    scoreA = typeof d.scoreA === "number" ? d.scoreA : 0;
    scoreB = typeof d.scoreB === "number" ? d.scoreB : 0;

    players=(Array.isArray(d.players)?d.players:[]).map((p,i)=>({...PLAYER_DEFAULTS,id:p.id??(i+1),name:p.name||`Jogador ${p.id??(i+1)}`,...p}));

    if(players.length===0) ensurePlayerCount(14); else {buildPlayersDOM();}

    const lastSaved=typeof d.lastSaved==="number"?d.lastSaved:Date.now();
    if(running){
      const e=Math.max(0,Math.floor((Date.now()-lastSaved)/1000));
      if(e>0){
        remaining=Math.max(0,remaining-e);
        players.forEach(p=>{
          if(p.active){p.seconds+=e;p.rotationTime+=e;if(firstHalf)p.part1+=e;else p.part2+=e; if(!p.isGK){p.fatigue+=FATIGUE_K_UP*(1-p.fatigue)*e; if(p.fatigue>1)p.fatigue=1;}}
          else{p.secondsOut+=e;p.rotationOutTime+=e; if(!p.isGK){p.fatigue-=FATIGUE_K_DOWN*p.fatigue*e; if(p.fatigue<0)p.fatigue=0;}}
        });
      }
    }

    updatePlayersUI(); updateSummary(); updateTimerDisplay(); updateHalfBadge(); updateScoreUI();
    if(running && remaining>0){ startTimer(); }
    tlLoad();
  }catch(e){
    players=[]; ensurePlayerCount(14); updateTimerDisplay(); updateHalfBadge(); updateSummary(); timeline=[]; tlSave(); scoreA=0; scoreB=0; updateScoreUI();
  }
}
window.addEventListener("beforeunload", saveData);
setInterval(saveData,3000);

/* Hist√≥rico */
function getHistory(){return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]")}
function setHistory(a){localStorage.setItem(HISTORY_KEY,JSON.stringify(a))}
function saveGameToHistory(){
  const snap={when:new Date().toISOString(),teamA:(teamA.value||"").trim(),teamB:(teamB.value||"").trim(),duration,scoreA,scoreB,
    totals:players.map(p=>({id:p.id,name:p.name,isGK:!!p.isGK,seconds:p.seconds,secondsOut:p.secondsOut,rotations:p.rotations,part1:p.part1,part2:p.part2,workload:p.seconds-p.secondsOut,plusMinus:p.plusMinus||0,fouls:p.fouls||0,yc:!!p.yc,rc:!!p.rc})),
    events:timeline.slice(0,300)};
  const hist=getHistory(); hist.unshift(snap); setHistory(hist); renderHistoryList();
}
function renderHistoryList(){
  const list=document.getElementById("historyList"); const hist=getHistory();
  if(hist.length===0){list.innerHTML='<div class="hist-item">Sem jogos guardados.</div>';return;}
  list.innerHTML="";
  hist.forEach((h,i)=>{
    const div=document.createElement("div"); div.className="hist-item";
    const d=new Date(h.when).toLocaleString();
    const title=`${h.teamA||'Equipa A'} ${typeof h.scoreA==='number'?h.scoreA:0}‚Äì${typeof h.scoreB==='number'?h.scoreB:0} ${h.teamB||'Equipa B'}`;
    div.innerHTML=`<div><strong>${title}</strong><br><small>${d}</small></div>
      <div class="hist-actions">
        <button onclick="exportCsv(${i})">CSV</button>
        <button onclick="exportPngFromHistory(${i})">PNG</button>
        <button onclick="deleteHistoryItem(${i})" style="background:#a33">Apagar</button>
      </div>`;
    list.appendChild(div);
  });
}
function deleteHistoryItem(i){const h=getHistory();h.splice(i,1);setHistory(h);renderHistoryList();}
function clearHistory(){setHistory([]);renderHistoryList();}
function exportCsv(idx){
  const h=getHistory()[idx]; if(!h)return;
  const rows=[["Jogador","GR","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload","+/-","Faltas","YC","RC"]];
  h.totals.forEach(t=>{
    const total=t.part1+t.part2, avg=t.rotations>0?Math.floor(total/t.rotations):0, percent=((total/(duration*2))*100).toFixed(1)+"%";
    rows.push([t.name,t.isGK?"Sim":"N√£o",formatTime(t.part1),formatTime(t.part2),formatTime(total),formatTime(t.secondsOut),t.rotations,formatTime(avg),percent,(t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m",t.plusMinus||0,t.fouls||0,t.yc?"Sim":"N√£o",t.rc?"Sim":"N√£o"]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const a=document.createElement("a"); const ts=new Date(h.when).toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`Resumo_${(h.teamA||'EquipaA')}_vs_${(h.teamB||'EquipaB')}_${ts}.csv`; a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.click();
}

/* Timeline + Score */
function tlSave(){localStorage.setItem(TL_KEY,JSON.stringify(timeline))}
function tlLoad(){timeline=JSON.parse(localStorage.getItem(TL_KEY)||"[]");}
function tlLabel(type, teamName){
  const A = teamName || (document.getElementById('teamA').value || 'Equipa A');
  const map = { GF_A:`Golo ${A}`, GA_A:`Golo Sofrido ${A}`, FK_P:"Falta", YC_P:"Amarelo", RC_P:"Vermelho" };
  return map[type] || type;
}
function tlAddTeam(type){
  const activeIds=players.filter(p=>p.active).map(p=>p.id);
  if(type==="GF_A"){ players.forEach(p=>{if(p.active)p.plusMinus=(p.plusMinus||0)+1;}); scoreA++; }
  if(type==="GA_A"){ players.forEach(p=>{if(p.active)p.plusMinus=(p.plusMinus||0)-1;}); scoreB++; }
  updateScoreUI();
  timeline.unshift({t:Date.now(),clock:formatTime(remaining),type,activeIds}); tlSave(); updateSummary(); saveData();
}

/* Export PNG (tabela + timeline textual, com t√≠tulo que inclui resultado) */
function printScreen(){ exportPngFromCurrent(); }
function exportPngFromCurrent(){
  const nameA=(teamA.value||"Equipa A").trim(), nameB=(teamB.value||"Equipa B").trim();
  const title = `${nameA} ${scoreA}‚Äì${scoreB} ${nameB}`;
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows=players.map(p=>{const total=p.part1+p.part2, avg=p.rotations>0?Math.floor(total/p.rotations):0, percent=((total/(duration*(firstHalf?1:2)))*100).toFixed(1)+"%", wl=p.seconds-p.secondsOut, wlt=`${wl>=0?"+":""}${(wl/60).toFixed(1)}m`;
    return [p.name+(p.isGK?' üß§':''),formatTime(p.part1),formatTime(p.part2),formatTime(total),formatTime(p.secondsOut),String(p.rotations),formatTime(avg),percent,wlt];});
  const events=(timeline||[]).map(ev=>{
    const label=tlLabel(ev.type, nameA), base=`${ev.clock} ‚Ä¢ ${label}`;
    if(ev.type==="GF_A"||ev.type==="GA_A"){
      const names=(ev.activeIds||[]).map(id=>{const P=players.find(p=>p.id===id);return (P?P.name:`#${id}`)+(P&&P.isGK?' üß§':'');});
      return names.length?`${base} ‚Äî Em campo: ${names.join(", ")}`:base;
    }
    if(ev.type.endsWith("_P")){
      const P=players.find(x=>x.id===ev.playerId); const nm=P?(P.name+(P.isGK?' üß§':'')):`#${ev.playerId}`; return `${base} ‚Äî ${nm}`;
    }
    return base;
  });
  renderReportPng(title,headers,rows,events,`Resumo_${nameA}_vs_${nameB}`);
}
function exportPngFromHistory(i){
  const h=getHistory()[i]; if(!h)return;
  const nameA=h.teamA||"Equipa A", nameB=h.teamB||"Equipa B";
  const title = `${nameA} ${typeof h.scoreA==='number'?h.scoreA:0}‚Äì${typeof h.scoreB==='number'?h.scoreB:0} ${nameB}`;
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows=h.totals.map(t=>{const total=t.part1+t.part2, avg=t.rotations>0?Math.floor(total/t.rotations):0, percent=((total/(duration*2))*100).toFixed(1)+"%"; const wlt=(t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m";
    return [t.name+(t.isGK?' üß§':''),formatTime(t.part1),formatTime(t.part2),formatTime(total),formatTime(t.secondsOut),String(t.rotations),formatTime(avg),percent,wlt];});
  const events=(h.events||[]).map(ev=>{
    const base=`${ev.clock} ‚Ä¢ ${tlLabel(ev.type, nameA)}`;
    if(ev.type==="GF_A"||ev.type==="GA_A"){
      const names=(ev.activeIds||[]).map(id=>{const T=h.totals.find(x=>x.id===id); return (T?T.name:`#${id}`)+((T&&T.isGK)?' üß§':'');});
      return names.length?`${base} ‚Äî Em campo: ${names.join(", ")}`:base;
    }
    if(ev.type.endsWith("_P")){
      const T=h.totals.find(x=>x.id===ev.playerId); const nm=T?(T.name+(T.isGK?' üß§':'')):`#${ev.playerId}`; return `${base} ‚Äî ${nm}`;
    }
    return base;
  });
  renderReportPng(title,headers,rows,events,`Resumo_${nameA}_vs_${nameB}`);
}
function renderReportPng(title,headers,rows,events,basename){
  const colWidths=[280,120,120,150,150,90,100,90,140], tableWidth=colWidths.reduce((a,b)=>a+b,0);
  const margin=20, innerPad=12, titleFont="bold 20px Arial, sans-serif", headFont="bold 14px Arial, sans-serif", rowFont="14px Arial, sans-serif", smallFont="13px Arial, sans-serif";
  const rowH=34, headerH=36, titleH=28;

  const tableCardW=tableWidth+innerPad*2, tableCardH=innerPad+headerH+rows.length*rowH+innerPad;

  const canvasMeasure=document.createElement("canvas").getContext("2d"); canvasMeasure.font=smallFont;
  const wrap=(text,maxW)=>{const w=text.split(" ");let line="",out=[];for(const t of w){const test=line?line+" "+t:t; if(canvasMeasure.measureText(test).width<=maxW) line=test; else {if(line)out.push(line); line=t;}} if(line)out.push(line); return out;};

  const timelineTitleH=24, timelineCardW=Math.max(tableCardW,700), tInnerW=timelineCardW-innerPad*2;
  const evLines=[]; const maxEv=Math.min(events.length,200);
  for(let i=0;i<maxEv;i++){evLines.push(...wrap(events[i],tInnerW-8));}
  const lineH=20, tlBodyH=evLines.length*lineH, tlCardH=innerPad+timelineTitleH+6+tlBodyH+innerPad;

  const contentW=Math.max(tableCardW,timelineCardW), canvasW=Math.max(contentW+margin*2,900);
  const canvasH=margin+titleH+8+innerPad+tableCardH+16+tlCardH+margin;

  const c=document.createElement("canvas"); c.width=canvasW; c.height=canvasH; const ctx=c.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvasW,canvasH);
  ctx.fillStyle="#000"; ctx.font=titleFont; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(title,canvasW/2,margin+titleH/2);

  let cardX=(canvasW-tableCardW)/2, cardY=margin+titleH+8; const r=10;
  ctx.fillStyle="#fff"; ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(cardX+r,cardY); ctx.lineTo(cardX+tableCardW-r,cardY); ctx.quadraticCurveTo(cardX+tableCardW,cardY,cardX+tableCardW,cardY+r);
  ctx.lineTo(cardX+tableCardW,cardY+tableCardH-r); ctx.quadraticCurveTo(cardX+tableCardW,cardY+tableCardH,cardX+tableCardW-r,cardY+tableCardH);
  ctx.lineTo(cardX+r,cardY+tableCardH); ctx.quadraticCurveTo(cardX,cardY+tableCardH,cardX,cardY+tableCardH-r);
  ctx.lineTo(cardX,cardY+r); ctx.quadraticCurveTo(cardX,cardY,cardX+r,cardY); ctx.closePath(); ctx.fill(); ctx.stroke();

  let x=cardX+innerPad, y=cardY+innerPad;
  ctx.fillStyle="#eee"; ctx.fillRect(x-1,y,tableWidth+2,headerH);
  ctx.fillStyle="#000"; ctx.font=headFont; ctx.textAlign="left"; ctx.textBaseline="middle";
  let cx=x; headers.forEach((h,i)=>{ctx.fillText(h,cx+8,y+headerH/2); cx+=colWidths[i];});
  ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+tableWidth,y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x,y+headerH); ctx.lineTo(x+tableWidth,y+headerH); ctx.stroke();

  ctx.font=rowFont; let rowY=y+headerH;
  for(const row of rows){
    ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(x,rowY+rowH); ctx.lineTo(x+tableWidth,rowY+rowH); ctx.stroke();
    let cxx=x;
    for(let i=0;i<row.length;i++){
      const cell=String(row[i]??""); const maxW=colWidths[i]-14;
      ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.textBaseline="middle";
      ctx.save(); let txt=cell; while(ctx.measureText(txt).width>maxW){ if(txt.length<=1)break; txt=txt.slice(0,-1);} if(txt!==cell) txt=txt.slice(0,-1)+"‚Ä¶";
      ctx.fillText(txt,cxx+7,rowY+rowH/2); ctx.restore();
      ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(cxx,rowY); ctx.lineTo(cxx,rowY+rowH); ctx.stroke();
      cxx+=colWidths[i];
    }
    ctx.beginPath(); ctx.moveTo(x+tableWidth,rowY); ctx.lineTo(x+tableWidth,rowY+rowH); ctx.stroke();
    rowY+=rowH;
  }
  ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.strokeRect(x-1,y,tableWidth+2,headerH+rows.length*rowH);

  const tlW=Math.max(tableCardW,700), tlX=(canvasW-tlW)/2, tlY=cardY+tableCardH+16; const r2=10;
  ctx.fillStyle="#fff"; ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(tlX+r2,tlY); ctx.lineTo(tlX+tlW-r2,tlY); ctx.quadraticCurveTo(tlX+tlW,tlY,tlX+tlW,tlY+r2);
  ctx.lineTo(tlX+tlW,tlY+tlCardH-r2); ctx.quadraticCurveTo(tlX+tlW,tlY+tlCardH,tlX+tlW-r2,tlY+tlCardH);
  ctx.lineTo(tlX+r2,tlY+tlCardH); ctx.quadraticCurveTo(tlX,tlY+tlCardH,tlX,tlY+tlCardH-r2);
  ctx.lineTo(tlX,tlY+r2); ctx.quadraticCurveTo(tlX,tlY,tlX+r2,tlY); ctx.closePath(); ctx.fill(); ctx.stroke();

  let tx=tlX+innerPad, ty=tlY+innerPad; ctx.font=headFont; ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.textBaseline="middle";
  ctx.fillText("Timeline",tx,ty+24/2);

  ctx.font=smallFont; ctx.fillStyle="#000"; let lY=ty+24+6;
  if(events.length===0){ ctx.fillText("‚Äî sem eventos ‚Äî",tx,lY+20/2); }
  else {
    const wrap2=(line,maxW)=>{const words=String(line).split(" ");let cur="",out=[];for(const w of words){const t=cur?cur+" "+w:w; if(canvasMeasure.measureText(t).width<=maxW)cur=t; else{if(cur)out.push(cur); cur=w;}} if(cur)out.push(cur); return out;};
    events.forEach(line=>{ wrap2(line, tlW-innerPad*2-8).forEach(w=>{ ctx.fillText(w,tx,lY+20/2); lY+=20; }); });
  }

  const a=document.createElement("a"); const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`${basename}_${ts}.png`; a.href=c.toDataURL("image/png"); a.click();
}

/* Tema/Fullscreen */
function toggleTheme(){document.body.classList.toggle("light-mode"); theme=document.body.classList.contains("light-mode")?"light":"dark"; themeToggle.textContent=theme==="dark"?"üåô":"üåû"; saveData();}
fullscreenBtn.onclick=()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();}

/* Editar nomes */
const editPanel=document.getElementById("editPanel"), editList=document.getElementById("editList");
editNamesBtn.onclick=()=>{
  editList.innerHTML=""; players.forEach(p=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML=`<span style="color:#aaa;width:26px;text-align:right">${p.id}.</span>
      <input type="text" id="nameEdit${p.id}" value="${p.name}">
      <label><input type="checkbox" id="gkEdit${p.id}" ${p.isGK?'checked':''}> üß§ GR</label>`;
    editList.appendChild(row);
  });
  editPanel.classList.add("open");
};
closePanel.onclick=()=>editPanel.classList.remove("open");
saveNamesBtn.onclick=()=>{
  players.forEach(p=>{const v=document.getElementById("nameEdit"+p.id).value.trim(); const gk=document.getElementById("gkEdit"+p.id).checked; if(v)p.name=v; p.isGK=!!gk; if(p.isGK)p.fatigue=0;});
  editPanel.classList.remove("open"); buildPlayersDOM(); updatePlayersUI(); updateSummary(); saveData();
};

/* Liga bot√µes UI e timeline */
startBtn.onclick=startTimer; pauseBtn.onclick=pauseTimer; resetBtn.onclick=resetTimer; intervalBtn.onclick=intervalTimer;
addBtn.onclick=()=>ensurePlayerCount(players.length+1);
removeBtn.onclick=()=>{if(players.length>1){players.pop();buildPlayersDOM();updatePlayersUI();updateSummary();saveData();}}
printBtn.onclick=printScreen; themeToggle.onclick=toggleTheme;
document.querySelectorAll("#timelineBar .tl-btn").forEach(btn=>{
  if(btn.classList.contains("tl-player")) btn.addEventListener("click",()=>setPending(btn.dataset.type));
  else btn.addEventListener("click",()=>tlAddTeam(btn.dataset.type));
});
tlClear.onclick=()=>{if(confirm("Limpar eventos?")){timeline=[];tlSave();}}

historyBtn.onclick=()=>{renderHistoryList();historyPanel.classList.add("open");};
closeHistory.onclick=()=>historyPanel.classList.remove("open");
saveGameBtn.onclick=saveGameToHistory;
clearHistoryBtn.onclick=clearHistory;
exportAllCsvBtn.onclick=()=>{
  const hist=getHistory(); if(hist.length===0)return;
  let csv="Data,EquipaA,EquipaB,Jogador,GR,1aParte,2aParte,Total,TempoFora,Rotacoes,Media,Percent,Workload,PlusMinus,Faltas,YC,RC\n";
  hist.forEach(h=>{
    const d=new Date(h.when).toISOString();
    h.totals.forEach(t=>{
      const total=t.part1+t.part2, avg=t.rotations>0?Math.floor(total/t.rotations):0, percent=((total/(duration*2))*100).toFixed(1)+"%";
      csv+=[d,JSON.stringify(h.teamA||""),JSON.stringify(h.teamB||""),JSON.stringify(t.name),t.isGK?"Sim":"N√£o",formatTime(t.part1),formatTime(t.part2),formatTime(total),formatTime(t.secondsOut),t.rotations,formatTime(avg),percent,(t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m",t.plusMinus||0,t.fouls||0,t.yc?"Sim":"N√£o",t.rc?"Sim":"N√£o"].join(",")+"\n";
    });
  });
  const a=document.createElement("a"); a.download="historico_gamecontrol.csv"; a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.click();
};

/* Boot */
updateTimerDisplay(); updateHalfBadge(); updateScoreUI();
loadData();
if(players.length===0){ ensurePlayerCount(14); }
</script>
</body>
</html>
