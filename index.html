<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Game Control</title>
<style>
:root {
  --bg-dark:#2c2c2c; --bg-light:#f4f4f4;
  --text-dark:#fff;  --text-light:#111;
  --green:#4caf50;   --red:#c0392b; --gray:#999;
}
*{box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:var(--bg-dark); color:var(--text-dark);
  margin:0; overflow-x:hidden; display:flex; flex-direction:column; align-items:center;
  transition:background .3s,color .3s;
}
body.light{ background:var(--bg-light); color:var(--text-light); }

/* Barra superior */
.topbar{
  width:100%; background:#3b3b3b; color:#fff; padding:10px 20px;
  display:flex; align-items:center; justify-content:center; position:relative;
}
body.light .topbar{background:#ddd;color:#000}
.topbar h1{margin:0; font-size:24px; font-weight:bold; text-align:center}
.topbar .icons{position:absolute; right:20px; display:flex; gap:15px}
.topbar .icons button{
  background:none; border:none; color:inherit; font-size:22px; cursor:pointer;
}

/* Equipas */
.team-names{display:flex; justify-content:center; align-items:center; gap:10px; margin:10px 0 5px}
.team-names input{
  background:#222; color:#fff; border:1px solid #555; border-radius:6px;
  padding:5px 10px; font-size:16px; width:160px; text-align:center;
}
body.light .team-names input{background:#fff;color:#000;border:1px solid #aaa}
.team-names span{font-weight:bold; color:#ccc}

/* CronÃ³metro + controlos */
.timer{font-size:72px; margin:15px 0; font-weight:bold}
.controls{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:20px}
.controls button{
  padding:10px 16px; font-size:15px; border:none; border-radius:6px; background:#555; color:#fff; cursor:pointer;
}
.controls button:hover{background:#666}
body.light .controls button{background:#ccc;color:#000}

/* Jogadores */
.players{display:grid; grid-template-columns:repeat(5,1fr); gap:15px; margin:10px 20px; width:90%}
.player{
  border-radius:16px; padding:20px; text-align:center; color:#fff; cursor:pointer; transition:transform .2s;
}
.player:hover{transform:scale(1.04)}
.player.active{background:var(--green)}
.player.inactive{background:var(--red)}
.player strong{display:block; font-size:18px; margin-bottom:10px}
.player .time{font-size:36px; font-weight:bold}
.player .last{font-size:14px; color:var(--gray); margin-top:4px}

/* Resumo */
.summary{width:90%; background:#3b3b3b; color:#fff; border-radius:10px; padding:10px; margin-bottom:40px}
body.light .summary{background:#eee;color:#000}
.summary table{width:100%; border-collapse:collapse; font-size:14px; text-align:center}
.summary th,.summary td{border:1px solid #666; padding:6px}
.work-pos{color:var(--green); font-weight:bold}
.work-neg{color:var(--red); font-weight:bold}

/* Painel lateral (editar nomes) */
.sidepanel{
  position:fixed; top:0; right:-300px; width:300px; height:100%;
  background:#444; color:#fff; box-shadow:-3px 0 6px rgba(0,0,0,.3);
  transition:right .3s ease; padding:20px; z-index:1000;
}
body.light .sidepanel{background:#ddd; color:#000}
.sidepanel.open{right:0}
.sidepanel input{
  width:100%; margin-bottom:10px; border:none; border-radius:6px; padding:8px; font-size:15px;
}

/* Pseudo fullscreen */
.fullscreen-mode .topbar, .fullscreen-mode .team-names{display:none}
.fullscreen-mode{margin-top:0}
.wrapper{width:100%}
.fullscreen-mode .wrapper{min-height:100svh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start}
</style>
</head>
<body>
<div class="topbar">
  <h1>Game Control</h1>
  <div class="icons">
    <button id="printBtn">ðŸ“¸</button>
    <button id="themeToggle">ðŸŒ™</button>
    <button id="fullscreenBtn">â›¶</button>
  </div>
</div>

<div class="team-names">
  <input id="teamA" placeholder="Equipa" />
  <span>vs</span>
  <input id="opponent" placeholder="AdversÃ¡rio" />
</div>

<div class="wrapper">
  <div class="timer" id="timer">20:00</div>
  <div class="controls">
    <input type="number" id="setMinutes" value="20" min="1" style="width:60px;"> min
    <button id="startBtn">Iniciar</button>
    <button id="pauseBtn">Pausar</button>
    <button id="intervalBtn">Intervalo</button>
    <button id="resetBtn">Reset</button>
    <button id="addBtn">âž•</button>
    <button id="removeBtn">âž–</button>
    <button id="editPlayersBtn">ðŸ‘¥ Jogadores</button>
  </div>

  <div class="players" id="players"></div>

  <div class="summary">
    <h3 style="text-align:center;">Resumo do Jogo</h3>
    <table>
      <thead>
        <tr>
          <th>Jogador</th>
          <th>Tempo Campo</th>
          <th>Tempo Banco</th>
          <th>RotaÃ§Ãµes</th>
          <th>MÃ©dia RotaÃ§Ã£o</th>
          <th>% Jogo</th>
          <th>Workload</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>
</div>

<!-- Painel lateral -->
<div class="sidepanel" id="sidepanel"></div>

<script>
/* ================== ESTADO ================== */
let duration = 20 * 60;
let remaining = duration;
let timerInterval;
let running = false;
let firstHalf = true;
let theme = "dark";
let players = []; // [{id,name,active,seconds,secondsOut,part1,part2,rotations,lastRotation,startTime}]

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
function formatTime(sec) {
  const s = Math.max(0, Math.abs(sec));
  const m = Math.floor(s / 60), r = s % 60;
  return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
}
function updateTimerDisplay(){ $("#timer").textContent = formatTime(remaining); }

/* ===== CronÃ³metro ===== */
function tick(){
  remaining--;
  updateTimerDisplay();
  players.forEach(p=>{
    if(p.active){
      p.seconds++;
      if(firstHalf) p.part1++; else p.part2++;
    } else {
      p.secondsOut++;
    }
  });
  renderPlayers();
  renderSummary();
  autosave();
}
function startTimer(){ if(running) return; running=true; timerInterval=setInterval(tick,1000); }
function pauseTimer(){ running=false; clearInterval(timerInterval); }
function resetTimer(){
  pauseTimer();
  duration = (parseInt($("#setMinutes").value)||20)*60;
  remaining = duration;
  players.forEach(p=>{
    p.active=false; p.seconds=0; p.secondsOut=0; p.part1=0; p.part2=0; p.rotations=0; p.lastRotation=0; p.startTime=0;
  });
  firstHalf = true;
  updateTimerDisplay(); renderPlayers(); renderSummary(); autosave();
}
function intervalTimer(){
  pauseTimer();
  firstHalf = false;
  remaining = (parseInt($("#setMinutes").value)||20)*60;
  updateTimerDisplay(); autosave();
}

/* ===== Jogadores ===== */
function defaultPlayer(i){
  return { id:i, name:"Jogador "+i, active:false,
    seconds:0, secondsOut:0, part1:0, part2:0, rotations:0, lastRotation:0, startTime:0 };
}
function ensurePlayers(n){
  if(players.length===0){ for(let i=1;i<=n;i++) players.push(defaultPlayer(i)); return; }
  while(players.length<n){ players.push(defaultPlayer(players.length+1)); }
  while(players.length>n){ players.pop(); }
}
function togglePlayer(id){
  const p = players.find(x=>x.id===id); if(!p) return;
  p.active = !p.active;
  if(p.active){ p.startTime = Date.now(); p.rotations++; }
  else { p.lastRotation = Math.floor((Date.now()- (p.startTime||Date.now()))/1000); }
  renderPlayers(); renderSummary(); autosave();
}
function renderPlayers(){
  const container = $("#players");
  // se o DOM nÃ£o corresponde ao nÂº, reconstruir
  if(container.children.length !== players.length){
    container.innerHTML = "";
    players.forEach(p=>{
      const div = document.createElement("div");
      div.id = "player"+p.id;
      div.className = "player "+(p.active?"active":"inactive");
      div.innerHTML = `<strong>${p.name}</strong><div class="time">${formatTime(p.active?p.seconds:p.secondsOut)}</div><div class="last">${!p.active&&p.lastRotation>0?("Ãšltima rotaÃ§Ã£o: "+formatTime(p.lastRotation)):""}</div>`;
      div.onclick = ()=>togglePlayer(p.id);
      container.appendChild(div);
    });
  } else {
    // atualizar existentes
    players.forEach(p=>{
      const div = $("#player"+p.id);
      if(!div) return;
      div.className = "player "+(p.active?"active":"inactive");
      div.querySelector("strong").textContent = p.name;
      div.querySelector(".time").textContent = p.active?formatTime(p.seconds):formatTime(p.secondsOut);
      div.querySelector(".last").textContent = (!p.active && p.lastRotation>0) ? ("Ãšltima rotaÃ§Ã£o: "+formatTime(p.lastRotation)) : "";
    });
  }
}

/* ===== Resumo ===== */
function renderSummary(){
  const tbody = $("#summaryBody");
  tbody.innerHTML = "";
  players.forEach(p=>{
    const total = p.part1 + p.part2;
    const avg = p.rotations>0 ? Math.floor(total/p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf?1:2))) * 100).toFixed(1);
    const workload = p.seconds - p.secondsOut;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${formatTime(p.seconds)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td class="${workload>=0?'work-pos':'work-neg'}">${workload>=0?'+':''}${(workload/60).toFixed(1)}m</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Painel lateral: editar nomes ===== */
function buildSidePanel(){
  const panel = $("#sidepanel"); panel.innerHTML = "";
  players.forEach(p=>{
    const inp = document.createElement("input");
    inp.value = p.name;
    inp.oninput = ()=>{ p.name = inp.value; renderPlayers(); renderSummary(); autosave(); };
    panel.appendChild(inp);
  });
}

/* ===== Print ===== */
function doPrint(){
  const header = `<h2 style="text-align:center;">${$("#teamA").value||'Equipa'} vs ${$("#opponent").value||'AdversÃ¡rio'}</h2>`;
  const table = $(".summary").innerHTML;
  const w = window.open("", "", "width=900,height=700");
  w.document.write(`<html><head><title>Game Control</title></head><body>${header}${table}</body></html>`);
  w.document.close(); w.print();
}

/* ===== Tema ===== */
function setTheme(t){ theme=t; document.body.classList.toggle("light", theme==="light"); $("#themeToggle").textContent = theme==="light"?"ðŸŒž":"ðŸŒ™"; }
function toggleTheme(){ setTheme(theme==="light"?"dark":"light"); autosave(); }

/* ===== Fullscreen (real + fallback) ===== */
let pseudoFull=false;
async function toggleFull(){
  try{
    if(!document.fullscreenElement){
      if(document.documentElement.requestFullscreen){
        await document.documentElement.requestFullscreen();
      } else { throw new Error("no fs"); }
    } else {
      await document.exitFullscreen();
    }
  }catch(e){
    // fallback pseudo
    pseudoFull = !pseudoFull;
    document.body.classList.toggle("fullscreen-mode", pseudoFull);
  }
}

/* ===== PersistÃªncia ===== */
function dataKey(){ return "gameControlData_vFinal"; }
function autosave(){
  const data = {
    teamA: $("#teamA").value || "",
    opponent: $("#opponent").value || "",
    duration, remaining, firstHalf, theme,
    players
  };
  localStorage.setItem(dataKey(), JSON.stringify(data));
}
function load(){
  const raw = localStorage.getItem(dataKey());
  if(raw){
    const data = JSON.parse(raw);
    $("#teamA").value = data.teamA || "";
    $("#opponent").value = data.opponent || "";
    duration = data.duration || duration;
    remaining = (typeof data.remaining==="number") ? data.remaining : duration;
    firstHalf = (typeof data.firstHalf==="boolean") ? data.firstHalf : true;
    setTheme(data.theme || "dark");
    players = Array.isArray(data.players) ? data.players : [];
  }
  // se nÃ£o houver jogadores guardados, cria 12
  ensurePlayers(players.length || 12);
  renderPlayers(); renderSummary(); buildSidePanel(); updateTimerDisplay();
}

/* ===== Eventos ===== */
$("#startBtn").onclick = startTimer;
$("#pauseBtn").onclick = pauseTimer;
$("#resetBtn").onclick = resetTimer;
$("#intervalBtn").onclick = intervalTimer;
$("#printBtn").onclick = doPrint;
$("#themeToggle").onclick = toggleTheme;
$("#fullscreenBtn").onclick = toggleFull;
$("#addBtn").onclick = ()=>{ ensurePlayers(players.length+1); renderPlayers(); renderSummary(); buildSidePanel(); autosave(); };
$("#removeBtn").onclick = ()=>{ if(players.length>1){ ensurePlayers(players.length-1); renderPlayers(); renderSummary(); buildSidePanel(); autosave(); } };
$("#editPlayersBtn").onclick = ()=> $("#sidepanel").classList.toggle("open");
$("#teamA").oninput = autosave;
$("#opponent").oninput = autosave;

/* Auto-guardar periÃ³dico enquanto o relÃ³gio corre */
setInterval(()=>{ if(running) autosave(); }, 3000);

/* Init */
load();
</script>
</body>
</html>
