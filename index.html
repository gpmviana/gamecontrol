<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Game Control</title>
<style>
:root {
  --bg-dark:#2c2c2c; --bg-light:#f4f4f4;
  --text-dark:#fff;  --text-light:#111;
  --green:#4caf50;   --red:#c0392b; --gray:#999;
}
*{box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:var(--bg-dark); color:var(--text-dark);
  margin:0; overflow-x:hidden;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  transition:background .3s,color .3s;
}
body.light{ background:var(--bg-light); color:var(--text-light); }

/* Barra superior */
.topbar{
  width:100%; background:#3b3b3b; color:#fff; padding:10px 20px;
  display:flex; align-items:center; justify-content:center; position:relative;
}
body.light .topbar{background:#ddd;color:#000}
.topbar h1{margin:0; font-size:24px; font-weight:bold; text-align:center}
.topbar .icons{position:absolute; right:20px; display:flex; gap:15px}
.topbar .icons button{background:none;border:none;color:inherit;font-size:22px;cursor:pointer}

/* Equipas */
.team-names{display:flex; justify-content:center; align-items:center; gap:10px; margin:10px 0 5px}
.team-names input{
  background:#222; color:#fff; border:1px solid #555; border-radius:6px;
  padding:5px 10px; font-size:16px; width:160px; text-align:center;
}
body.light .team-names input{background:#fff;color:#000;border:1px solid #aaa}
.team-names span{font-weight:bold; color:#ccc}

/* CronÃ³metro + controlos */
.timer{font-size:72px; margin:15px 0; font-weight:bold; text-align:center}
.controls{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:20px; text-align:center}
.controls button{
  padding:10px 16px; font-size:15px; border:none; border-radius:6px; background:#555; color:#fff; cursor:pointer;
}
.controls button:hover{background:#666}
body.light .controls button{background:#ccc;color:#000}

/* Jogadores */
.players{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:20px;
  margin:20px auto;
  width:100%;
  max-width:1100px;
  justify-items:center;
}
.player{
  width:100%;
  height:170px;
  border-radius:18px; padding:15px;
  text-align:center; color:#fff; cursor:pointer; transition:transform .2s;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
}
.player:hover{transform:scale(1.05)}
.player.active{background:var(--green)}
.player.inactive{background:var(--red)}
.player strong{font-size:18px; margin-bottom:8px}
.player .time{font-size:44px; font-weight:bold; line-height:1}
.player .last{font-size:14px; color:var(--gray); margin-top:4px}

/* Resumo */
.summary{
  width:95%; max-width:1100px;
  background:#3b3b3b; color:#fff;
  border-radius:10px; padding:10px; margin:20px auto 40px;
}
body.light .summary{background:#eee;color:#000}
.summary table{width:100%; border-collapse:collapse; font-size:14px; text-align:center}
.summary th,.summary td{border:1px solid #666; padding:6px}
.work-pos{color:var(--green); font-weight:bold}
.work-neg{color:var(--red); font-weight:bold}

/* Painel lateral */
.sidepanel{
  position:fixed; top:0; right:-300px; width:300px; height:100%;
  background:#444; color:#fff; box-shadow:-3px 0 6px rgba(0,0,0,.3);
  transition:right .3s ease; padding:20px; z-index:1000;
}
body.light .sidepanel{background:#ddd;color:#000}
.sidepanel.open{right:0}
.sidepanel input{
  width:100%; margin-bottom:10px; border:none; border-radius:6px; padding:8px; font-size:15px;
}

/* Fullscreen */
.fullscreen-mode .topbar, .fullscreen-mode .team-names{display:none}
.fullscreen-mode .wrapper{
  width:100%; max-width:1100px;
  display:flex; flex-direction:column;
  align-items:center; justify-content:flex-start;
  min-height:100svh; margin:0 auto;
}
</style>
</head>
<body>
<div class="topbar">
  <h1>Game Control</h1>
  <div class="icons">
    <button id="printBtn">ðŸ“¸</button>
    <button id="themeToggle">ðŸŒ™</button>
    <button id="fullscreenBtn">â›¶</button>
  </div>
</div>

<div class="team-names">
  <input id="teamA" placeholder="Equipa" />
  <span>vs</span>
  <input id="opponent" placeholder="AdversÃ¡rio" />
</div>

<div class="wrapper">
  <div class="timer" id="timer">20:00</div>
  <div class="controls">
    <input type="number" id="setMinutes" value="20" min="1" style="width:60px;"> min
    <button id="startBtn">Iniciar</button>
    <button id="pauseBtn">Pausar</button>
    <button id="intervalBtn">Intervalo</button>
    <button id="resetBtn">Reset</button>
    <button id="addBtn">âž•</button>
    <button id="removeBtn">âž–</button>
    <button id="editPlayersBtn">ðŸ‘¥ Jogadores</button>
  </div>

  <div class="players" id="players"></div>

  <div class="summary">
    <table>
      <thead>
        <tr>
          <th>Jogador</th>
          <th>Tempo Campo</th>
          <th>Tempo Banco</th>
          <th>RotaÃ§Ãµes</th>
          <th>MÃ©dia RotaÃ§Ã£o</th>
          <th>% Jogo</th>
          <th>Workload</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>
</div>

<!-- Painel lateral -->
<div class="sidepanel" id="sidepanel"></div>
<script>
let duration = 20 * 60;
let remaining = duration;
let timerInterval;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";

/* ---------- FunÃ§Ãµes utilitÃ¡rias ---------- */
function formatTime(sec) {
  const s = Math.max(0, Math.abs(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2, "0")}:${String(r).padStart(2, "0")}`;
}
function updateTimerDisplay() {
  document.getElementById("timer").textContent = formatTime(remaining);
}

/* ---------- CronÃ³metro principal ---------- */
function tick() {
  remaining--;
  updateTimerDisplay();
  players.forEach(p => {
    if (p.active) {
      p.seconds++;
      if (firstHalf) p.part1++;
      else p.part2++;
    } else p.secondsOut++;
  });
  updateSummary();
  updatePlayersUI();
}

function startTimer() {
  if (running) return;
  running = true;
  timerInterval = setInterval(tick, 1000);
}
function pauseTimer() {
  running = false;
  clearInterval(timerInterval);
}
function resetTimer() {
  pauseTimer();
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;
  players.forEach(p => {
    p.seconds = 0; p.secondsOut = 0; p.part1 = 0; p.part2 = 0;
    p.rotations = 0; p.lastRotation = 0;
  });
  firstHalf = true;
  updateTimerDisplay(); updateSummary(); updatePlayersUI(); saveData();
}
function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  remaining = parseInt(document.getElementById("setMinutes").value) * 60;
  updateTimerDisplay();
}

/* ---------- Jogadores ---------- */
function togglePlayer(id) {
  const p = players.find(x => x.id === id);
  if (!p) return;
  p.active = !p.active;
  if (p.active) {
    p.startTime = Date.now();
    p.rotations++;
  } else {
    const last = Math.floor((Date.now() - p.startTime) / 1000);
    p.lastRotation = last;
  }
  updatePlayersUI();
  updateSummary();
  saveData();
}

function updatePlayersUI() {
  players.forEach(p => {
    const div = document.getElementById("player" + p.id);
    div.className = "player " + (p.active ? "active" : "inactive");
    div.querySelector(".time").textContent = p.active
      ? formatTime(p.seconds)
      : formatTime(p.secondsOut);
    div.querySelector(".last").textContent =
      !p.active && p.lastRotation > 0
        ? `Ãšltima rotaÃ§Ã£o: ${formatTime(p.lastRotation)}`
        : "";
  });
}

function createPlayers(count = 12) {
  const container = document.getElementById("players");
  container.innerHTML = "";
  players = [];
  for (let i = 1; i <= count; i++) {
    const p = {
      id: i,
      name: "Jogador " + i,
      active: false,
      seconds: 0,
      secondsOut: 0,
      part1: 0,
      part2: 0,
      rotations: 0,
      lastRotation: 0,
      startTime: 0,
    };
    players.push(p);

    const div = document.createElement("div");
    div.id = "player" + i;
    div.className = "player inactive";
    div.innerHTML = `<strong>${p.name}</strong><div class="time">00:00</div><div class="last"></div>`;
    div.onclick = () => togglePlayer(i);
    container.appendChild(div);
  }
  updatePlayersUI();
}

/* ---------- Painel lateral (nomes) ---------- */
function openEditPanel() {
  const panel = document.getElementById("sidepanel");
  panel.innerHTML = "<h3>Editar Jogadores</h3>";
  players.forEach(p => {
    const inp = document.createElement("input");
    inp.value = p.name;
    inp.oninput = () => { p.name = inp.value; updateSummary(); saveData(); };
    panel.appendChild(inp);
  });
  const close = document.createElement("button");
  close.textContent = "Fechar";
  close.style.marginTop = "10px";
  close.onclick = () => panel.classList.remove("open");
  panel.appendChild(close);
  panel.classList.add("open");
}

/* ---------- Tabela resumo ---------- */
function updateSummary() {
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = "";
  players.forEach(p => {
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? total / p.rotations : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1);
    const workload = p.seconds - p.secondsOut;
    const workClass = workload >= 0 ? "work-pos" : "work-neg";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${formatTime(p.seconds)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td class="${workClass}">${workload >= 0 ? "+" : ""}${(workload / 60).toFixed(1)}m</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- Guardar / carregar ---------- */
function saveData() {
  const data = {
    teamA: document.getElementById("teamA").value,
    opponent: document.getElementById("opponent").value,
    players, firstHalf, remaining, duration, theme
  };
  localStorage.setItem("gameControlData", JSON.stringify(data));
}
function loadData() {
  const data = JSON.parse(localStorage.getItem("gameControlData") || "null");
  if (!data) return createPlayers();
  document.getElementById("teamA").value = data.teamA || "";
  document.getElementById("opponent").value = data.opponent || "";
  duration = data.duration; remaining = data.remaining;
  firstHalf = data.firstHalf; theme = data.theme || "dark";
  players = data.players || [];
  createPlayers(players.length || 12);
  players.forEach(p => {
    const ref = document.getElementById("player" + p.id);
    if (ref) ref.querySelector("strong").textContent = p.name;
  });
  if (theme === "light") toggleTheme(false);
  updateSummary(); updatePlayersUI(); updateTimerDisplay();
}

/* ---------- Screenshot (sÃ³ equipas + tabela) ---------- */
function printScreen() {
  const canvas = document.createElement("canvas");
  const el = document.querySelector(".summary");
  const names = `<h2 style="text-align:center;">${document.getElementById("teamA").value} vs ${document.getElementById("opponent").value}</h2>`;
  html2canvas(el, {backgroundColor:"#fff"}).then(c => {
    const link = document.createElement("a");
    const img = c.toDataURL("image/png");
    const win = window.open("");
    win.document.write(`<html><body style='background:#fff;text-align:center;color:#000;'>${names}<img src='${img}' style='width:90%;max-width:900px;border:1px solid #ccc;'></body></html>`);
  });
}

/* ---------- Tema / fullscreen ---------- */
function toggleTheme(save = true) {
  const body = document.body, btn = document.getElementById("themeToggle");
  if (body.classList.contains("light")) {
    body.classList.remove("light"); btn.textContent = "ðŸŒ™"; theme = "dark";
  } else {
    body.classList.add("light"); btn.textContent = "ðŸŒž"; theme = "light";
  }
  if (save) saveData();
}
function toggleFullscreen() {
  const el = document.documentElement;
  if (!document.fullscreenElement && el.requestFullscreen) el.requestFullscreen();
  else if (document.exitFullscreen) document.exitFullscreen();
}

/* ---------- BotÃµes ---------- */
document.getElementById("startBtn").onclick = startTimer;
document.getElementById("pauseBtn").onclick = pauseTimer;
document.getElementById("resetBtn").onclick = resetTimer;
document.getElementById("intervalBtn").onclick = intervalTimer;
document.getElementById("printBtn").onclick = printScreen;
document.getElementById("themeToggle").onclick = () => toggleTheme(true);
document.getElementById("fullscreenBtn").onclick = toggleFullscreen;
document.getElementById("addBtn").onclick = () => { createPlayers(players.length + 1); saveData(); };
document.getElementById("removeBtn").onclick = () => { if (players.length > 1) createPlayers(players.length - 1); saveData(); };
document.getElementById("editPlayersBtn").onclick = openEditPanel;

/* ---------- Autosave ---------- */
setInterval(() => { if (running) saveData(); }, 3000);

/* ---------- Inicializar ---------- */
window.onload = () => {
  createPlayers();
  loadData();
  updateTimerDisplay();
};

/* html2canvas import */
const script = document.createElement("script");
script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
document.head.appendChild(script);
</script>
</body>
</html>
