<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game Control</title>
<style>
  body{font-family:Arial, sans-serif;margin:0;background:#1e1e1e;color:#f5f5f5;text-align:center}
  header{display:flex;align-items:center;justify-content:center;background:#333;padding:10px 0;position:relative}
  header h1{margin:0;font-size:1.5em;text-align:center}
  .top-buttons{position:absolute;right:10px;top:8px;display:flex;gap:8px}
  .top-buttons button{background:none;border:none;font-size:22px;color:#fff;cursor:pointer}

  #teamInputs{display:flex;justify-content:center;align-items:center;gap:10px;margin:10px}
  #teamInputs input{padding:6px 10px;border-radius:6px;border:none;font-size:16px;text-align:center}

  .timer-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0 0 0}
  #timer{font-size:3em}
  .half-badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#444;color:#fff;font-size:12px;letter-spacing:.3px}

  .controls{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;background:#2e2e2e;padding:10px}
  .controls button{padding:6px 10px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer}

  /* Caixas: 260x240, m√°x 5 por linha */
  #players{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:18px;width:95%;max-width:1300px;margin:12px auto;justify-items:center}
  .player{
    width:100%;max-width:260px;height:240px;border-radius:14px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;transition:.2s;background:#c0392b;color:#fff;position:relative;overflow:hidden
  }
  .player.active{background:#2ecc71;color:#000}
  .player strong{font-size:20px;margin-bottom:8px}
  .player .time{font-size:40px;font-weight:bold;line-height:1}
  .player .last{font-size:12px;opacity:.9;margin-top:6px}

  /* Badge GR (emoji luva) */
  .gk-badge{
    position:absolute;top:8px;left:8px;
    width:28px;height:28px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.35);backdrop-filter:saturate(120%) blur(2px);
    font-size:16px;line-height:1
  }

  /* Barra de fadiga (s√≥ jogadores de campo) */
  .fatigue{position:absolute;left:8px;right:8px;bottom:8px;height:8px;border-radius:6px;background:rgba(255,255,255,0.25)}
  .fatigue-fill{height:100%;border-radius:6px;width:0%}

  /* feedback quando tenta 6¬∫ em campo */
  .player.limit{outline:3px solid #ff4d4d;box-shadow:0 0 0 3px rgba(255,77,77,0.35)}

  @media (max-width:1200px){#players{grid-template-columns:repeat(4,minmax(0,1fr));}}
  @media (max-width:900px){#players{grid-template-columns:repeat(3,minmax(0,1fr));}}
  @media (max-width:600px){#players{grid-template-columns:repeat(2,minmax(0,1fr));}}

  /* ‚Äî‚Äî‚Äî TABELA | Visual polido ‚Äî‚Äî‚Äî */
  .summary{
    width: 90%;
    max-width: 1100px;
    margin: 18px auto;
    padding: 0;
    background: #242424;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
    overflow: hidden;
  }
  .summary h3{
    margin: 0;
    padding: 12px 16px;
    background: #2f2f2f;
    border-bottom: 1px solid #3a3a3a;
    text-align: left;
  }
  .summary table{width: 100%; border-collapse: separate; border-spacing: 0;}
  .summary thead th{
    position: sticky; top: 0;
    background: #303030; z-index: 1;
    text-transform: uppercase; font-size: 12px; letter-spacing: .4px; color: #ddd;
    border-bottom: 1px solid #3a3a3a; padding: 10px 12px;
  }
  .summary tbody td{padding: 10px 12px; border-bottom: 1px solid #333;}
  .summary tbody tr:nth-child(even){ background: rgba(255,255,255,0.03); }
  .summary tbody tr:hover{ background: rgba(255,255,255,0.06); }
  .summary td:nth-child(1){ text-align: left; font-weight: 600; }
  .summary td:nth-child(4),
  .summary td:nth-child(5),
  .summary td:nth-child(6),
  .summary td:nth-child(7){ font-variant-numeric: tabular-nums; }

  /* P√≠lulas para Workload (+/-) */
  .pill{
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }
  .pill.work-pos{ color:#2ecc71; background: rgba(46,204,113,.12); border: 1px solid rgba(46,204,113,.35); }
  .pill.work-neg{ color:#e74c3c; background: rgba(231,76,60,.12); border: 1px solid rgba(231,76,60,.35); }

  /* Modo claro */
  .light-mode{background:#f4f4f4;color:#000}
  .light-mode header{background:#ddd}
  .light-mode .controls{background:#ddd}
  .light-mode .player.active{background:#27ae60;color:#fff}
  .light-mode .player.inactive{background:#e74c3c;color:#fff}
  .light-mode .fatigue{background:rgba(0,0,0,0.15)}
  .light-mode .summary{ background:#ffffff; box-shadow:0 8px 24px rgba(0,0,0,.10); }
  .light-mode .summary h3{ background:#f0f0f0; border-bottom:1px solid #e5e5e5; }
  .light-mode .summary thead th{ background:#f7f7f7; color:#333; border-bottom:1px solid #e5e5e5; }
  .light-mode .summary tbody td{ border-bottom:1px solid #eee; }
  .light-mode .summary tbody tr:nth-child(even){ background:#fafafa; }
  .light-mode .summary tbody tr:hover{ background:#f2f2f2; }
  .light-mode .pill.work-pos{ background:rgba(39,174,96,.10); border-color:rgba(39,174,96,.30); color:#1e824c; }
  .light-mode .pill.work-neg{ background:rgba(231,76,60,.10); border-color:rgba(231,76,60,.30); color:#b3392e; }

  /* Painel lateral editar nomes (direita) */
  #editPanel{
    position:fixed; right:-420px; top:20%; width:380px; height:60%;
    background:rgba(0,0,0,0.92); border-left:2px solid #555; border-radius:10px 0 0 10px;
    padding:15px; box-shadow:-4px 0 8px rgba(0,0,0,.4); transition:right .2s; z-index:999; overflow-y:auto
  }
  #editPanel.open{ right:0; }
  #editPanel h3{ margin:0 0 10px 0; }
  #editPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  #editPanel .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  #editPanel .row input[type="text"]{flex:1;padding:6px;border-radius:6px;border:1px solid #777;background:#1f1f1f;color:#fff}
  #editPanel .row label{display:flex;align-items:center;gap:6px;color:#ddd;font-size:13px;white-space:nowrap}
  #editPanel .save-btn{width:100%; padding:8px; border:none; border-radius:6px; background:#0078d7; color:#fff; cursor:pointer; margin-top:8px}

  /* Painel Hist√≥rico (esquerda) */
  #historyPanel{
    position:fixed; left:-420px; top:10%; width:380px; height:80%;
    background:rgba(0,0,0,0.92); border-right:2px solid #555; border-radius:0 10px 10px 0;
    padding:15px; box-shadow:4px 0 8px rgba(0,0,0,.4); transition:left .2s; z-index:999; overflow-y:auto
  }
  #historyPanel.open{ left:0; }
  #historyPanel h3{ margin:0 0 10px 0; }
  #historyPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  .hist-item{background:#1f1f1f;border:1px solid #444;border-radius:8px;padding:8px;margin-bottom:8px;text-align:left}
  .hist-item .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .hist-item .meta{font-size:12px;opacity:.9}
  .hist-actions{display:flex;gap:6px;margin-top:6px}
  .hist-actions button{padding:6px 8px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Game Control</h1>
  <div class="top-buttons">
    <button id="themeToggle" title="Tema">üåô</button>
    <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
    <button id="editNamesBtn" title="Editar nomes">üë•</button>
    <button id="printBtn" title="Exportar PNG">üì∏</button>
  </div>
</header>

<div id="teamInputs">
  <input id="teamA" placeholder="Equipa A" />
  <span style="font-weight:bold;">vs</span>
  <input id="teamB" placeholder="Equipa B" />
</div>

<div class="timer-row">
  <div id="timer">20:00</div>
  <span id="halfBadge" class="half-badge">1¬™ Parte</span>
</div>

<div class="controls">
  <input id="setMinutes" type="number" value="20" min="1" style="width:60px;">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausar</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">‚àí</button>
  <button id="saveGameBtn">Guardar Jogo</button>
  <button id="historyBtn">Hist√≥rico</button>
</div>

<div id="players"></div>

<div class="summary">
  <h3>Resumo de Jogo</h3>
  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>1¬™ Parte</th>
        <th>2¬™ Parte</th>
        <th>Total em Campo</th>
        <th>Tempo Fora</th>
        <th>Rota√ß√µes</th>
        <th>M√©dia</th>
        <th>% Jogo</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>

<!-- Painel de edi√ß√£o de nomes -->
<div id="editPanel">
  <button class="close-btn" id="closePanel">‚ùå</button>
  <h3>Editar Jogadores</h3>
  <div id="editList"></div>
  <button class="save-btn" id="saveNamesBtn">Guardar Altera√ß√µes</button>
</div>

<!-- Painel Hist√≥rico -->
<div id="historyPanel">
  <button class="close-btn" id="closeHistory">‚ùå</button>
  <h3>Hist√≥rico de Jogos</h3>
  <div id="historyList"></div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button id="exportAllCsvBtn">Exportar CSV (tudo)</button>
    <button id="clearHistoryBtn" style="background:#a33">Apagar Hist√≥rico</button>
  </div>
</div>

<script>
/* ===== ESTADO ===== */
let duration = 20*60;
let remaining = duration;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";
let timerInterval = null;
let _lastTick = null;
const STORAGE_KEY = "gameControlData_gcStable";
const HISTORY_KEY = "gameControlHistory_v1";

/* Fadiga: jogadores de campo (GR sem fadiga visual) */
const FATIGUE_K_UP = 0.012;     // por segundo (campo) ‚Äì a subir
const FATIGUE_K_DOWN = 0.025;   // por segundo (campo) ‚Äì a descer (banco)
const RED_THRESHOLD_SEC = 180;   // >= 3:00 ‚Üí vermelho (em jogo)
const YELLOW_THRESHOLD_SEC = 90; // >= 1:30 ‚Üí amarelo (em jogo)

/* Campos padr√£o */
const PLAYER_DEFAULTS = {
  id: 0, name: "",
  active: false,
  isGK: false,           // Guarda-Redes?
  seconds: 0, secondsOut: 0,
  part1: 0, part2: 0,
  rotations: 0, lastRotation: 0,
  startTime: 0,
  rotationTime: 0,   // tempo da rota√ß√£o atual (em campo)
  rotationOutTime: 0,// tempo fora atual
  fatigue: 0         // 0..1 (n√£o usado se isGK=true)
};

/* ===== UTIL ===== */
const pad = n => String(n).padStart(2,"0");
function formatTime(sec){sec=Math.max(0,Math.floor(sec));return `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;}
function updateTimerDisplay(){document.getElementById("timer").textContent = formatTime(remaining);}
function updateHalfBadge(){document.getElementById("halfBadge").textContent = firstHalf ? "1¬™ Parte" : "2¬™ Parte";}

/* Cor da fadiga (campo apenas) */
function fatigueColor(p){
  if(p.active){
    if(p.rotationTime >= RED_THRESHOLD_SEC) return "#e74c3c";    // vermelho
    if(p.rotationTime >= YELLOW_THRESHOLD_SEC) return "#e6b800"; // amarelo
    return "#2ecc71";                                            // verde
  }else{
    if(p.fatigue >= 0.66) return "#e74c3c";
    if(p.fatigue >= 0.33) return "#e6b800";
    return "#2ecc71";
  }
}

/* ===== RENDER CAIXAS ===== */
function buildPlayersDOM(){
  const pDiv=document.getElementById("players");
  pDiv.innerHTML="";
  players.forEach(p=>{
    const d=document.createElement("div");
    d.id="player"+p.id;
    d.className="player "+(p.active?"active":"inactive");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime;

    const gkBadge = p.isGK ? '<span class="gk-badge">üß§</span>' : '';
    const fatigueBar = p.isGK ? '' :
      `<div class="fatigue"><div class="fatigue-fill" id="fatigue${p.id}" style="width:0%"></div></div>`;

    d.innerHTML=`${gkBadge}
                 <strong>${p.name}</strong>
                 <div class="time">${formatTime(displaySec)}</div>
                 <div class="last">${!p.active&&p.lastRotation>0?"√ölt. rota√ß√£o: "+formatTime(p.lastRotation):""}</div>
                 ${fatigueBar}`;
    d.onclick=()=>togglePlayer(p.id);
    pDiv.appendChild(d);
  });
}
function updatePlayersUI(){
  players.forEach(p=>{
    const d=document.getElementById("player"+p.id);
    if(!d) return;
    d.className="player "+(p.active?"active":"inactive");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime;
    d.querySelector(".time").textContent = formatTime(displaySec);
    d.querySelector(".last").textContent = (!p.active && p.lastRotation>0) ? ("√ölt. rota√ß√£o: "+formatTime(p.lastRotation)) : "";
    d.querySelector("strong").textContent = p.name;

    // Badge üß§
    let badge = d.querySelector(".gk-badge");
    if(p.isGK){
      if(!badge){
        badge = document.createElement("span");
        badge.className="gk-badge"; badge.textContent="üß§";
        d.prepend(badge);
      }
    }else if(badge){
      badge.remove();
    }

    // Barra de fadiga s√≥ para jogadores de campo
    if(!p.isGK){
      const ff=document.getElementById("fatigue"+p.id);
      if(ff){
        ff.style.width = Math.round((p.fatigue||0)*100) + "%";
        ff.style.background = fatigueColor(p);
      }
    }
  });
}

/* ===== LIMITE/CONTAGEM DE JOGADORES ===== */
function ensurePlayerCount(n){
  while(players.length < n){
    const id = players.length ? Math.max(...players.map(x=>x.id))+1 : 1;
    players.push({...PLAYER_DEFAULTS, id, name:"Jogador "+id});
  }
  while(players.length > n){ players.pop(); }
  buildPlayersDOM(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== TABELA ===== */
function updateSummary(){
  const tb = document.getElementById("summaryBody");
  tb.innerHTML = "";
  players.forEach(p=>{
    const total   = p.part1 + p.part2;
    const avg     = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1);
    const workload = p.seconds - p.secondsOut;
    const cls = workload >= 0 ? "work-pos" : "work-neg";
    const wlText = `${workload >= 0 ? "+" : ""}${(workload/60).toFixed(1)}m`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}${p.isGK?' üß§':''}</td>
      <td>${formatTime(p.part1)}</td>
      <td>${formatTime(p.part2)}</td>
      <td>${formatTime(total)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td><span class="pill ${cls}">${wlText}</span></td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== CONTAGEM ATIVOS (m√°x 5) ===== */
function activeCount(){ return players.reduce((n,p)=> n + (p.active?1:0), 0); }
function flashLimit(id){
  const d = document.getElementById("player"+id);
  if(!d) return;
  d.classList.add("limit");
  setTimeout(()=>d.classList.remove("limit"), 600);
}

/* ===== CRON√ìMETRO ===== */
function tick(){
  const now=Date.now(); if(_lastTick===null)_lastTick=now;
  const delta=Math.max(0,Math.floor((now-_lastTick)/1000));
  if(delta>0){
    remaining=Math.max(0,remaining-delta);
    for(let i=0;i<delta;i++){
      players.forEach(p=>{
        if(p.active){
          p.seconds++; p.rotationTime++; if(firstHalf) p.part1++; else p.part2++;
          if(!p.isGK){
            p.fatigue += FATIGUE_K_UP * (1 - p.fatigue);
            if(p.fatigue>1) p.fatigue=1;
          }
        }else{
          p.secondsOut++; p.rotationOutTime++;
          if(!p.isGK){
            p.fatigue -= FATIGUE_K_DOWN * p.fatigue;
            if(p.fatigue<0) p.fatigue=0;
          }
        }
      });
    }
    _lastTick=now;
    updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
    if(remaining<=0) pauseTimer();
  }
}
function startTimer(){ if(running) return; running=true; _lastTick=Date.now(); clearInterval(timerInterval); timerInterval=setInterval(tick,250); saveData(); }
function pauseTimer(){ running=false; clearInterval(timerInterval); saveData(); }
function resetTimer(){
  pauseTimer();
  const m=parseInt(document.getElementById("setMinutes").value)||20;
  duration=m*60; remaining=duration; firstHalf=true;
  players.forEach(p=>{
    p.seconds=0; p.secondsOut=0; p.part1=0; p.part2=0; p.rotations=0; p.lastRotation=0;
    p.rotationTime=0; p.rotationOutTime=0; if(!p.isGK) p.fatigue=0;
  });
  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== INTERVALO ===== */
function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;

  players.forEach(p => {
    p.rotationTime = 0;
    p.rotationOutTime = 0;
    if(!p.isGK) p.fatigue = Math.max(0, p.fatigue * 0.30); // recupera√ß√£o forte no intervalo
  });

  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== INTERA√á√ÉO JOGADOR (limit 5) ===== */
function togglePlayer(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  if(!p.active && activeCount() >= 5){ flashLimit(id); return; }
  p.active=!p.active;
  if(p.active){
    p.rotations++; p.startTime=Date.now(); p.rotationTime=0; p.rotationOutTime=0;
  }else{
    p.lastRotation=p.rotationTime; p.rotationTime=0; p.rotationOutTime=0;
  }
  updatePlayersUI(); updateSummary(); saveData();
}

/* ===== PERSIST√äNCIA ===== */
function saveData(){
  const data = {
    teamA: teamA.value||"", teamB: teamB.value||"",
    duration, remaining, firstHalf, running, theme,
    players, lastSaved: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadData(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){ players=[]; ensurePlayerCount(14); updateTimerDisplay(); updateHalfBadge(); updateSummary(); return; }
  const d=JSON.parse(raw);
  teamA.value=d.teamA||""; teamB.value=d.teamB||"";
  duration  = typeof d.duration  === "number" ? d.duration  : duration;
  remaining = typeof d.remaining === "number" ? d.remaining : remaining;
  firstHalf = typeof d.firstHalf === "boolean" ? d.firstHalf : firstHalf;
  running   = !!d.running;
  theme     = d.theme || theme;

  players = (Array.isArray(d.players)?d.players:[]).map((p,i)=>({
    ...PLAYER_DEFAULTS,
    id:p.id ?? (i+1),
    name:p.name || `Jogador ${p.id ?? (i+1)}`,
    ...p
  }));

  const lastSaved = typeof d.lastSaved === "number" ? d.lastSaved : Date.now();
  if(running){
    const e=Math.max(0,Math.floor((Date.now()-lastSaved)/1000));
    if(e>0){
      remaining=Math.max(0,remaining-e);
      players.forEach(p=>{
        if(p.active){ 
          p.seconds+=e; p.rotationTime+=e; if(firstHalf) p.part1+=e; else p.part2+=e;
          if(!p.isGK){
            p.fatigue += FATIGUE_K_UP * (1 - p.fatigue) * e;
            if(p.fatigue>1) p.fatigue=1;
          }
        }else{ 
          p.secondsOut+=e; p.rotationOutTime+=e;
          if(!p.isGK){
            p.fatigue -= FATIGUE_K_DOWN * p.fatigue * e;
            if(p.fatigue<0) p.fatigue=0;
          }
        }
      });
    }
  }
  if(players.length===0) ensurePlayerCount(14); else buildPlayersDOM();
  updatePlayersUI(); updateSummary(); updateTimerDisplay(); updateHalfBadge();
  if(running && remaining>0) startTimer();
}
window.addEventListener("beforeunload", saveData);
setInterval(saveData, 3000);

/* ===== HIST√ìRICO LOCAL ===== */
function getHistory(){ return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
function saveGameToHistory(){
  const snapshot = {
    when: new Date().toISOString(),
    teamA: (teamA.value||"").trim(),
    teamB: (teamB.value||"").trim(),
    duration,
    totals: players.map(p=>({
      id:p.id, name:p.name, isGK: !!p.isGK,
      seconds:p.seconds, secondsOut:p.secondsOut,
      rotations:p.rotations, part1:p.part1, part2:p.part2,
      workload:p.seconds - p.secondsOut
    }))
  };
  const hist=getHistory(); hist.unshift(snapshot); setHistory(hist);
  renderHistoryList();
}
function renderHistoryList(){
  const list=document.getElementById("historyList");
  const hist=getHistory();
  if(hist.length===0){ list.innerHTML='<div class="hist-item">Sem jogos guardados.</div>'; return; }
  list.innerHTML="";
  hist.forEach((h,idx)=>{
    const div=document.createElement("div");
    const d=new Date(h.when);
    const title=`${h.teamA||'Equipa A'} vs ${h.teamB||'Equipa B'}`;
    div.className="hist-item";
    div.innerHTML=`<div class="row"><div>
        <div><strong>${title}</strong></div>
        <div class="meta">${d.toLocaleString()}</div>
      </div></div>
      <div class="hist-actions">
        <button onclick="exportCsv(${idx})">CSV</button>
        <button onclick="exportPngFromHistory(${idx})">PNG</button>
        <button onclick="deleteHistoryItem(${idx})" style="background:#a33">Apagar</button>
      </div>`;
    list.appendChild(div);
  });
}
function deleteHistoryItem(i){ const hist=getHistory(); hist.splice(i,1); setHistory(hist); renderHistoryList(); }
function clearHistory(){ setHistory([]); renderHistoryList(); }
function exportCsv(index){
  const h=getHistory()[index]; if(!h) return;
  const rows=[["Jogador","GR","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"]];
  h.totals.forEach(t=>{
    const total = t.part1 + t.part2;
    const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
    const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
    rows.push([
      t.name, t.isGK?"Sim":"N√£o",
      formatTime(t.part1), formatTime(t.part2),
      formatTime(total), formatTime(t.secondsOut),
      t.rotations, formatTime(avg), percent,
      (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m"
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const a=document.createElement("a");
  const ts=new Date(h.when).toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`Resumo_${(h.teamA||'EquipaA')}_vs_${(h.teamB||'EquipaB')}_${ts}.csv`;
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.click();
}

/* ===== PRINT ‚Üí PNG (canvas) ===== */
function printScreen(){ exportPngFromCurrent(); }
function exportPngFromCurrent(){
  const nameA=(document.getElementById("teamA").value || "Equipa A").trim();
  const nameB=(document.getElementById("teamB").value || "Equipa B").trim();
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = players.map(p=>{
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1) + "%";
    const workload = p.seconds - p.secondsOut;
    const workloadText = `${workload >= 0 ? "+" : ""}${(workload/60).toFixed(1)}m`;
    return [
      p.name + (p.isGK?' üß§':''), formatTime(p.part1), formatTime(p.part2),
      formatTime(total), formatTime(p.secondsOut),
      String(p.rotations), formatTime(avg), percent, workloadText
    ];
  });
  renderTablePng(nameA,nameB,headers,rows, `Resumo_${nameA}_vs_${nameB}`);
}
function exportPngFromHistory(index){
  const h=getHistory()[index]; if(!h) return;
  const nameA=h.teamA||"Equipa A", nameB=h.teamB||"Equipa B";
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = h.totals.map(t=>{
    const total = t.part1 + t.part2;
    const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
    const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
    const workloadText = (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m";
    return [
      t.name + (t.isGK?' üß§':''), formatTime(t.part1), formatTime(t.part2),
      formatTime(total), formatTime(t.secondsOut),
      String(t.rotations), formatTime(avg), percent, workloadText
    ];
  });
  renderTablePng(nameA,nameB,headers,rows, `Resumo_${nameA}_vs_${nameB}`);
}
function renderTablePng(nameA,nameB,headers,rows, basename){
  const title = `${nameA} vs ${nameB}`;
  const colWidths = headers.map((h,i)=>[280,120,120,150,150,90,100,90,140][i]||120);
  const tableWidth = colWidths.reduce((a,b)=>a+b, 0);
  const margin=20, titleFont="bold 20px Arial, sans-serif", headFont="bold 14px Arial, sans-serif", rowFont="14px Arial, sans-serif";
  const rowH=34, headerH=36, titleH=28, innerPad=10;
  const contentWidth = tableWidth + innerPad*2;
  const canvasWidth = Math.max(contentWidth + margin*2, 700);
  const canvasHeight = margin + titleH + 8 + innerPad + headerH + rows.length*rowH + innerPad + margin;

  const canvas=document.createElement("canvas");
  canvas.width=canvasWidth; canvas.height=canvasHeight;
  const ctx=canvas.getContext("2d");

  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvasWidth,canvasHeight);
  ctx.fillStyle="#000"; ctx.font=titleFont; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(title, canvasWidth/2, margin + titleH/2);

  const cardX=(canvasWidth - contentWidth)/2, cardY=margin + titleH + 8, cardW=contentWidth, cardH=innerPad + headerH + rows.length*rowH + innerPad;
  ctx.fillStyle="#fff"; ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
  const r=10; ctx.beginPath();
  ctx.moveTo(cardX + r, cardY); ctx.lineTo(cardX + cardW - r, cardY); ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + r);
  ctx.lineTo(cardX + cardW, cardY + cardH - r); ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - r, cardY + cardH);
  ctx.lineTo(cardX + r, cardY + cardH); ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - r);
  ctx.lineTo(cardX, cardY + r); ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY); ctx.closePath(); ctx.fill(); ctx.stroke();

  let x=cardX + innerPad, y=cardY + innerPad;
  ctx.fillStyle="#eee"; ctx.fillRect(x - 1, y, tableWidth + 2, headerH);
  ctx.fillStyle="#000"; ctx.font=headFont; ctx.textAlign="left"; ctx.textBaseline="middle";
  let colX=x; headers.forEach((h,i)=>{ ctx.fillText(h, colX + 8, y + headerH/2); colX += colWidths[i]; });

  ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x + tableWidth, y); ctx.moveTo(x,y + headerH); ctx.lineTo(x + tableWidth, y + headerH); ctx.stroke();

  ctx.font=rowFont; let rowY=y + headerH;
  for(let rI=0;rI<rows.length;rI++){
    const row=rows[rI];
    ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(x, rowY + rowH); ctx.lineTo(x + tableWidth, rowY + rowH); ctx.stroke();
    let cx=x;
    for(let c=0;c<row.length;c++){
      const cell=String(row[c] ?? ""); const maxW = colWidths[c] - 14;
      ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.textBaseline="middle";
      ctx.save(); let text=cell;
      while(ctx.measureText(text).width > maxW){ if(text.length<=1) break; text = text.slice(0,-1); }
      if(text !== cell) text = text.slice(0,-1) + "‚Ä¶";
      ctx.fillText(text, cx + 7, rowY + rowH/2); ctx.restore();
      ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(cx, rowY); ctx.lineTo(cx, rowY + rowH); ctx.stroke();
      cx += colWidths[c];
    }
    ctx.beginPath(); ctx.moveTo(x + tableWidth, rowY); ctx.lineTo(x + tableWidth, rowY + rowH); ctx.stroke();
    rowY += rowH;
  }
  ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.strokeRect(x - 1, y, tableWidth + 2, headerH + rows.length*rowH);

  const a=document.createElement("a");
  const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`${basename}_${ts}.png`; a.href=canvas.toDataURL("image/png"); a.click();
}

/* ===== TEMA / FULLSCREEN ===== */
function toggleTheme(){
  const btn=themeToggle;
  document.body.classList.toggle("light-mode");
  theme=document.body.classList.contains("light-mode")?"light":"dark";
  btn.textContent=theme==="dark"?"üåô":"üåû";
  saveData();
}

/* ===== PAINEL DE NOMES (com GR) ===== */
const editPanel=document.getElementById("editPanel"), editList=document.getElementById("editList");
editNamesBtn.onclick=()=>{
  editList.innerHTML="";
  players.forEach(p=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <span style="color:#aaa;width:26px;text-align:right">${p.id}.</span>
      <input type="text" id="nameEdit${p.id}" value="${p.name}">
      <label><input type="checkbox" id="gkEdit${p.id}" ${p.isGK?'checked':''}> üß§ GR</label>
    `;
    editList.appendChild(row);
  });
  editPanel.classList.add("open");
};
closePanel.onclick=()=>editPanel.classList.remove("open");
saveNamesBtn.onclick=()=>{
  players.forEach(p=>{
    const v=document.getElementById("nameEdit"+p.id).value.trim();
    const gk=document.getElementById("gkEdit"+p.id).checked;
    if(v) p.name=v;
    p.isGK = !!gk;
    if(p.isGK){ p.fatigue=0; }
  });
  editPanel.classList.remove("open");
  buildPlayersDOM(); // recria DOM p/ adicionar/remover barra consoante isGK
  updatePlayersUI(); updateSummary(); saveData();
};

/* ===== HIST√ìRICO UI ===== */
const historyPanel=document.getElementById("historyPanel");
document.getElementById("historyBtn").onclick=()=>{ renderHistoryList(); historyPanel.classList.add("open"); };
document.getElementById("closeHistory").onclick=()=>historyPanel.classList.remove("open");
document.getElementById("saveGameBtn").onclick=saveGameToHistory;
document.getElementById("clearHistoryBtn").onclick=clearHistory;
document.getElementById("exportAllCsvBtn").onclick=()=>{
  const hist=getHistory(); if(hist.length===0) return;
  let csv="Data,EquipaA,EquipaB,Jogador,GR,1aParte,2aParte,Total,TempoFora,Rotacoes,Media,Percent,Workload\n";
  hist.forEach(h=>{
    const d=new Date(h.when).toISOString();
    h.totals.forEach(t=>{
      const total = t.part1 + t.part2;
      const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
      const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
      csv += [
        d, JSON.stringify(h.teamA||""), JSON.stringify(h.teamB||""),
        JSON.stringify(t.name), t.isGK?"Sim":"N√£o",
        formatTime(t.part1), formatTime(t.part2),
        formatTime(total), formatTime(t.secondsOut),
        t.rotations, formatTime(avg), percent,
        (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m"
      ].join(",") + "\n";
    });
  });
  const a=document.createElement("a"); a.download="historico_gamecontrol.csv";
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.click();
};

/* ===== BOT√ïES ===== */
document.getElementById("startBtn").onclick=startTimer;
document.getElementById("pauseBtn").onclick=pauseTimer;
document.getElementById("resetBtn").onclick=resetTimer;
document.getElementById("intervalBtn").onclick=intervalTimer;
document.getElementById("addBtn").onclick=()=>ensurePlayerCount(players.length+1);
document.getElementById("removeBtn").onclick=()=>{if(players.length>1){players.pop();buildPlayersDOM();updatePlayersUI();updateSummary();saveData();}}
document.getElementById("printBtn").onclick=printScreen;
document.getElementById("themeToggle").onclick=toggleTheme;
document.getElementById("fullscreenBtn").onclick=()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();};

/* ===== START ===== */
updateTimerDisplay();
updateHalfBadge();
loadData();
</script>
</body>
</html>
