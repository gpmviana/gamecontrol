<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game Control</title>
<style>
  body{font-family:Arial, sans-serif;margin:0;background:#1e1e1e;color:#f5f5f5;text-align:center}
  header{display:flex;align-items:center;justify-content:center;background:#333;padding:10px 0;position:relative}
  header h1{margin:0;font-size:1.5em;text-align:center}
  .top-buttons{position:absolute;right:10px;top:8px;display:flex;gap:8px}
  .top-buttons button{background:none;border:none;font-size:22px;color:#fff;cursor:pointer}

  #teamInputs{display:flex;justify-content:center;align-items:center;gap:10px;margin:10px}
  #teamInputs input{padding:6px 10px;border-radius:6px;border:none;font-size:16px;text-align:center}

  .timer-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0 0 0}
  #timer{font-size:3em}
  .half-badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#444;color:#fff;font-size:12px;letter-spacing:.3px}

  .controls{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;background:#2e2e2e;padding:10px}
  .controls button{padding:6px 10px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer}

  /* Caixas: 260x240, m√°x 5 por linha */
  #players{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:18px;width:95%;max-width:1300px;margin:12px auto;justify-items:center}
  .player{
    width:100%;max-width:260px;height:240px;border-radius:14px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;transition:.2s;background:#c0392b;color:#fff;position:relative;overflow:hidden
  }
  .player.active{background:#2ecc71;color:#000}
  .player strong{font-size:20px;margin-bottom:8px}
  .player .time{font-size:40px;font-weight:bold;line-height:1}
  .player .last{font-size:12px;opacity:.9;margin-top:6px}

  /* Badges no cart√£o */
  .gk-badge{
    position:absolute;top:8px;left:8px;width:28px;height:28px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);
    backdrop-filter:saturate(120%) blur(2px);font-size:16px;line-height:1
  }
  .card-badges{
    position:absolute;top:8px;right:8px;display:flex;gap:6px;align-items:center
  }
  .badge-fouls{min-width:22px;height:22px;border-radius:999px;background:#444;color:#fff;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;padding:0 6px}
  .badge-yc,.badge-rc{
    width:16px;height:22px;border-radius:3px;border:1px solid rgba(0,0,0,.35)
  }
  .badge-yc{background:#f1c40f}
  .badge-rc{background:#e74c3c}

  /* Barra de fadiga (s√≥ jogadores de campo) */
  .fatigue{position:absolute;left:8px;right:8px;bottom:8px;height:8px;border-radius:6px;background:rgba(255,255,255,0.25)}
  .fatigue-fill{height:100%;border-radius:6px;width:0%}

  /* feedback quando tenta 6¬∫ em campo */
  .player.limit{outline:3px solid #ff4d4d;box-shadow:0 0 0 3px rgba(255,77,77,0.35)}

  /* destaque quando est√° em modo de selecionar jogador para evento */
  .selectable{outline:3px dashed #fff; outline-offset:-4px}

  @media (max-width:1200px){#players{grid-template-columns:repeat(4,minmax(0,1fr));}}
  @media (max-width:900px){#players{grid-template-columns:repeat(3,minmax(0,1fr));}}
  @media (max-width:600px){#players{grid-template-columns:repeat(2,minmax(0,1fr));}}

  /* ‚Äî‚Äî‚Äî TABELA | Visual polido ‚Äî‚Äî‚Äî */
  .summary{
    width:90%;max-width:1100px;margin:18px auto;padding:0;background:#242424;border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);overflow:hidden
  }
  .summary h3{margin:0;padding:12px 16px;background:#2f2f2f;border-bottom:1px solid #3a3a3a;text-align:left}
  .summary table{width:100%;border-collapse:separate;border-spacing:0}
  .summary thead th{
    position:sticky;top:0;background:#303030;z-index:1;text-transform:uppercase;font-size:12px;letter-spacing:.4px;color:#ddd;
    border-bottom:1px solid #3a3a3a;padding:10px 12px
  }
  .summary tbody td{padding:10px 12px;border-bottom:1px solid #333}
  .summary tbody tr:nth-child(even){background:rgba(255,255,255,0.03)}
  .summary tbody tr:hover{background:rgba(255,255,255,0.06)}
  .summary td:nth-child(1){text-align:left;font-weight:600}
  .summary td:nth-child(4),.summary td:nth-child(5),.summary td:nth-child(6),.summary td:nth-child(7){font-variant-numeric:tabular-nums}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-variant-numeric:tabular-nums}
  .pill.work-pos{color:#2ecc71;background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.35)}
  .pill.work-neg{color:#e74c3c;background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.35)}

  /* Modo claro */
  .light-mode{background:#f4f4f4;color:#000}
  .light-mode header{background:#ddd}
  .light-mode .controls{background:#ddd}
  .light-mode .player.active{background:#27ae60;color:#fff}
  .light-mode .player.inactive{background:#e74c3c;color:#fff}
  .light-mode .fatigue{background:rgba(0,0,0,0.15)}
  .light-mode .summary{ background:#ffffff; box-shadow:0 8px 24px rgba(0,0,0,.10); }
  .light-mode .summary h3{ background:#f0f0f0; border-bottom:1px solid #e5e5e5; }
  .light-mode .summary thead th{ background:#f7f7f7; color:#333; border-bottom:1px solid #e5e5e5; }
  .light-mode .summary tbody td{ border-bottom:1px solid #eee; }
  .light-mode .summary tbody tr:nth-child(even){ background:#fafafa; }
  .light-mode .summary tbody tr:hover{ background:#f2f2f2; }
  .light-mode .pill.work-pos{ background:rgba(39,174,96,.10); border-color:rgba(39,174,96,.30); color:#1e824c; }
  .light-mode .pill.work-neg{ background:rgba(231,76,60,.10); border-color:rgba(231,76,60,.30); color:#b3392e; }

  /* Painel lateral editar nomes (direita) */
  #editPanel{
    position:fixed; right:-420px; top:20%; width:380px; height:60%;
    background:rgba(0,0,0,0.92); border-left:2px solid #555; border-radius:10px 0 0 10px;
    padding:15px; box-shadow:-4px 0 8px rgba(0,0,0,.4); transition:right .2s; z-index:999; overflow-y:auto
  }
  #editPanel.open{ right:0; }
  #editPanel h3{ margin:0 0 10px 0; }
  #editPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  #editPanel .row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  #editPanel .row input[type="text"]{flex:1;padding:6px;border-radius:6px;border:1px solid #777;background:#1f1f1f;color:#fff}
  #editPanel .row label{display:flex;align-items:center;gap:6px;color:#ddd;font-size:13px;white-space:nowrap}
  #editPanel .save-btn{width:100%; padding:8px; border:none; border-radius:6px; background:#0078d7; color:#fff; cursor:pointer; margin-top:8px}

  /* Painel Hist√≥rico (esquerda) */
  #historyPanel{
    position:fixed; left:-420px; top:10%; width:380px; height:80%;
    background:rgba(0,0,0,0.92); border-right:2px solid #555; border-radius:0 10px 10px 0;
    padding:15px; box-shadow:4px 0 8px rgba(0,0,0,.4); transition:left .2s; z-index:999; overflow-y:auto
  }
  #historyPanel.open{ left:0; }
  #historyPanel h3{ margin:0 0 10px 0; }
  #historyPanel .close-btn{position:absolute; top:6px; right:8px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer}
  .hist-item{background:#1f1f1f;border:1px solid #444;border-radius:8px;padding:8px;margin-bottom:8px;text-align:left}
  .hist-item .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .hist-item .meta{font-size:12px;opacity:.9}
  .hist-actions{display:flex;gap:6px;margin-top:6px}
  .hist-actions button{padding:6px 8px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer;font-size:12px}

  /* ===== TIMELINE ===== */
  #timelineBar{
    position:fixed; left:0; right:0; bottom:0;
    background:#222; border-top:1px solid #333; z-index:900;
    padding:8px 10px; box-shadow:0 -6px 16px rgba(0,0,0,.25);
  }
  #timelineBar .tl-actions{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:6px; }
  #timelineBar .tl-btn{ background:#3a3a3a; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:13px }
  #timelineBar #tlClear{ background:#a33; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
  #timelineFeed{ max-height:120px; overflow:auto; display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
  .tl-chip{
    background:#2b2b2b; border:1px solid #444; color:#eee;
    padding:4px 8px; border-radius:999px; font-size:12px; white-space:nowrap
  }
  .tl-gf{ border-color:rgba(46,204,113,.5); color:#2ecc71; }
  .tl-ga{ border-color:rgba(231,76,60,.6); color:#e74c3c; }
  .tl-fk{ border-color:rgba(241,196,15,.5); color:#f1c40f; }
  .tl-yc{ border-color:rgba(241,196,15,.5); color:#f1c40f; }
  .tl-rc{ border-color:rgba(231,76,60,.6); color:#e74c3c; }
  .tl-to{ border-color:rgba(52,152,219,.6); color:#3498db; }

  .light-mode #timelineBar{ background:#fafafa; border-top:1px solid #e5e5e5 }
  .light-mode .tl-btn{ background:#e9e9e9; color:#111 }
  .light-mode #tlClear{ background:#d9534f }
  .light-mode .tl-chip{ background:#fff; border-color:#ddd; color:#333 }
</style>
</head>
<body>
<header>
  <h1>Game Control</h1>
  <div class="top-buttons">
    <button id="themeToggle" title="Tema">üåô</button>
    <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
    <button id="editNamesBtn" title="Editar nomes">üë•</button>
    <button id="printBtn" title="Exportar PNG">üì∏</button>
  </div>
</header>

<div id="teamInputs">
  <input id="teamA" placeholder="Equipa A" />
  <span style="font-weight:bold;">vs</span>
  <input id="teamB" placeholder="Equipa B" />
</div>

<div class="timer-row">
  <div id="timer">20:00</div>
  <span id="halfBadge" class="half-badge">1¬™ Parte</span>
</div>

<div class="controls">
  <input id="setMinutes" type="number" value="20" min="1" style="width:60px;">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausar</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">‚àí</button>
  <button id="saveGameBtn">Guardar Jogo</button>
  <button id="historyBtn">Hist√≥rico</button>
</div>

<div id="players"></div>

<div class="summary">
  <h3>Resumo de Jogo</h3>
  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>1¬™ Parte</th>
        <th>2¬™ Parte</th>
        <th>Total em Campo</th>
        <th>Tempo Fora</th>
        <th>Rota√ß√µes</th>
        <th>M√©dia</th>
        <th>% Jogo</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>

<!-- Painel de edi√ß√£o de nomes -->
<div id="editPanel">
  <button class="close-btn" id="closePanel">‚ùå</button>
  <h3>Editar Jogadores</h3>
  <div id="editList"></div>
  <button class="save-btn" id="saveNamesBtn">Guardar Altera√ß√µes</button>
</div>

<!-- Painel Hist√≥rico -->
<div id="historyPanel">
  <button class="close-btn" id="closeHistory">‚ùå</button>
  <h3>Hist√≥rico de Jogos</h3>
  <div id="historyList"></div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button id="exportAllCsvBtn">Exportar CSV (tudo)</button>
    <button id="clearHistoryBtn" style="background:#a33">Apagar Hist√≥rico</button>
  </div>
</div>

<!-- TIMELINE -->
<div id="timelineBar">
  <div class="tl-actions">
    <!-- Equipa A: golos -->
    <button class="tl-btn" data-type="GF_A" title="Golo Equipa A">‚öΩ A+</button>
    <button class="tl-btn" data-type="GA_A" title="Golo Sofrido A">‚öΩ A‚àí</button>
    <!-- Eventos por jogador (selecionar e depois tocar no jogador) -->
    <button class="tl-btn tl-player" data-type="FK_P" title="Falta (seleciona jogador)">‚ùå Falta</button>
    <button class="tl-btn tl-player" data-type="YC_P" title="Amarelo (seleciona jogador)">üü® Amarelo</button>
    <button class="tl-btn tl-player" data-type="RC_P" title="Vermelho (seleciona jogador)">üü• Vermelho</button>
    <!-- Time-out Equipa A -->
    <button class="tl-btn" data-type="TO_A" title="Time-out A">‚è±Ô∏è A</button>
    <button id="tlClear" title="Limpar timeline">üßπ</button>
  </div>
  <div id="timelineFeed"></div>
</div>

<script>
/* ===== ESTADO ===== */
let duration = 20*60;
let remaining = duration;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";
let timerInterval = null;
let _lastTick = null;
const STORAGE_KEY = "gameControlData_gcStable";
const HISTORY_KEY = "gameControlHistory_v1";

/* Timeline */
const TL_KEY = "gameControlTimeline_v1";
let timeline = []; // {t, clock, type, activeIds:[...], playerId?}

/* Sele√ß√£o de evento por jogador */
let pendingPlayerEvent = null; // "FK_P" | "YC_P" | "RC_P"

/* Fadiga: jogadores de campo (GR sem fadiga visual) */
const FATIGUE_K_UP = 0.012;     // por segundo (campo) ‚Äì a subir
const FATIGUE_K_DOWN = 0.025;   // por segundo (campo) ‚Äì a descer (banco)
const RED_THRESHOLD_SEC = 180;   // >= 3:00 ‚Üí vermelho (em jogo)
const YELLOW_THRESHOLD_SEC = 90; // >= 1:30 ‚Üí amarelo (em jogo)

/* Campos padr√£o */
const PLAYER_DEFAULTS = {
  id: 0, name: "",
  active: false,
  isGK: false,           // Guarda-Redes?
  seconds: 0, secondsOut: 0,
  part1: 0, part2: 0,
  rotations: 0, lastRotation: 0,
  startTime: 0,
  rotationTime: 0,   // tempo da rota√ß√£o atual (em campo)
  rotationOutTime: 0,// tempo fora atual
  fatigue: 0,        // 0..1 (n√£o usado se isGK=true)
  plusMinus: 0,      // saldo golos quando estava em campo
  fouls: 0,          // faltas pessoais
  yc: false,         // amarelo
  rc: false          // vermelho
};

/* ===== UTIL ===== */
const pad = n => String(n).padStart(2,"0");
function formatTime(sec){sec=Math.max(0,Math.floor(sec));return `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;}
function updateTimerDisplay(){document.getElementById("timer").textContent = formatTime(remaining);}
function updateHalfBadge(){document.getElementById("halfBadge").textContent = firstHalf ? "1¬™ Parte" : "2¬™ Parte";}
function fatigueColor(p){
  if(p.active){
    if(p.rotationTime >= RED_THRESHOLD_SEC) return "#e74c3c";
    if(p.rotationTime >= YELLOW_THRESHOLD_SEC) return "#e6b800";
    return "#2ecc71";
  }else{
    if(p.fatigue >= 0.66) return "#e74c3c";
    if(p.fatigue >= 0.33) return "#e6b800";
    return "#2ecc71";
  }
}

/* ===== RENDER CAIXAS ===== */
function buildPlayersDOM(){
  const pDiv=document.getElementById("players");
  pDiv.innerHTML="";
  players.forEach(p=>{
    const d=document.createElement("div");
    d.id="player"+p.id;
    d.className="player "+(p.active?"active":"inactive");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime;

    const gkBadge = p.isGK ? '<span class="gk-badge">üß§</span>' : '';
    const fatigueBar = p.isGK ? '' :
      `<div class="fatigue"><div class="fatigue-fill" id="fatigue${p.id}" style="width:0%"></div></div>`;

    const ycEl = p.yc ? '<span class="badge-yc" title="Amarelo"></span>' : '';
    const rcEl = p.rc ? '<span class="badge-rc" title="Vermelho"></span>' : '';
    const foulEl = p.fouls>0 ? `<span class="badge-fouls" title="Faltas">${p.fouls}</span>` : '';

    d.innerHTML=`${gkBadge}
                 <div class="card-badges">${foulEl}${ycEl}${rcEl}</div>
                 <strong>${p.name}</strong>
                 <div class="time">${formatTime(displaySec)}</div>
                 <div class="last">${!p.active&&p.lastRotation>0?"√ölt. rota√ß√£o: "+formatTime(p.lastRotation):""}</div>
                 ${fatigueBar}`;
    d.onclick=()=>onPlayerClick(p.id);
    pDiv.appendChild(d);
  });
}
function updatePlayersUI(){
  players.forEach(p=>{
    const d=document.getElementById("player"+p.id);
    if(!d) return;
    d.className="player "+(p.active?"active":"inactive") + (pendingPlayerEvent? " selectable" : "");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime;
    d.querySelector(".time").textContent = formatTime(displaySec);
    d.querySelector(".last").textContent = (!p.active && p.lastRotation>0) ? ("√ölt. rota√ß√£o: "+formatTime(p.lastRotation)) : "";
    d.querySelector("strong").textContent = p.name;

    // (re)desenhar badges
    const badges = d.querySelector(".card-badges");
    badges.innerHTML = (p.fouls>0? `<span class="badge-fouls" title="Faltas">${p.fouls}</span>` : '')
                     + (p.yc? '<span class="badge-yc" title="Amarelo"></span>' : '')
                     + (p.rc? '<span class="badge-rc" title="Vermelho"></span>' : '');

    // Badge üß§
    let badge = d.querySelector(".gk-badge");
    if(p.isGK){
      if(!badge){
        badge = document.createElement("span");
        badge.className="gk-badge"; badge.textContent="üß§";
        d.prepend(badge);
      }
    }else if(badge){
      badge.remove();
    }

    // Barra de fadiga s√≥ para jogadores de campo
    if(!p.isGK){
      const ff=document.getElementById("fatigue"+p.id);
      if(ff){
        ff.style.width = Math.round((p.fatigue||0)*100) + "%";
        ff.style.background = fatigueColor(p);
      }
    }
  });
}

/* ===== LIMITE/CONTAGEM DE JOGADORES ===== */
function ensurePlayerCount(n){
  while(players.length < n){
    const id = players.length ? Math.max(...players.map(x=>x.id))+1 : 1;
    players.push({...PLAYER_DEFAULTS, id, name:"Jogador "+id});
  }
  while(players.length > n){ players.pop(); }
  buildPlayersDOM(); updatePlayersUI(); updateSummary(); saveData();
}
function activeCount(){ return players.reduce((n,p)=> n + (p.active?1:0), 0); }
function flashLimit(id){
  const d = document.getElementById("player"+id);
  if(!d) return;
  d.classList.add("limit");
  setTimeout(()=>d.classList.remove("limit"), 600);
}

/* ===== TABELA ===== */
function updateSummary(){
  const tb = document.getElementById("summaryBody");
  tb.innerHTML = "";
  players.forEach(p=>{
    const total   = p.part1 + p.part2;
    const avg     = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1);
    const workload = p.seconds - p.secondsOut;
    const cls = workload >= 0 ? "work-pos" : "work-neg";
    const wlText = `${workload >= 0 ? "+" : ""}${(workload/60).toFixed(1)}m`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}${p.isGK?' üß§':''}</td>
      <td>${formatTime(p.part1)}</td>
      <td>${formatTime(p.part2)}</td>
      <td>${formatTime(total)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td><span class="pill ${cls}">${wlText}</span></td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== CRON√ìMETRO ===== */
function tick(){
  const now=Date.now(); if(_lastTick===null)_lastTick=now;
  const delta=Math.max(0,Math.floor((now-_lastTick)/1000));
  if(delta>0){
    remaining=Math.max(0,remaining-delta);
    for(let i=0;i<delta;i++){
      players.forEach(p=>{
        if(p.active){
          p.seconds++; p.rotationTime++; if(firstHalf) p.part1++; else p.part2++;
          if(!p.isGK){
            p.fatigue += FATIGUE_K_UP * (1 - p.fatigue);
            if(p.fatigue>1) p.fatigue=1;
          }
        }else{
          p.secondsOut++; p.rotationOutTime++;
          if(!p.isGK){
            p.fatigue -= FATIGUE_K_DOWN * p.fatigue;
            if(p.fatigue<0) p.fatigue=0;
          }
        }
      });
    }
    _lastTick=now;
    updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
    if(remaining<=0) pauseTimer();
  }
}
function startTimer(){ if(running) return; running=true; _lastTick=Date.now(); clearInterval(timerInterval); timerInterval=setInterval(tick,250); saveData(); }
function pauseTimer(){ running=false; clearInterval(timerInterval); saveData(); }
function resetTimer(){
  pauseTimer();
  const m=parseInt(document.getElementById("setMinutes").value)||20;
  duration=m*60; remaining=duration; firstHalf=true;
  players.forEach(p=>{
    p.seconds=0; p.secondsOut=0; p.part1=0; p.part2=0; p.rotations=0; p.lastRotation=0;
    p.rotationTime=0; p.rotationOutTime=0; if(!p.isGK) p.fatigue=0;
    p.plusMinus=0; p.fouls=0; p.yc=false; p.rc=false;
  });
  timeline = []; tlSave(); tlRender();
  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== INTERVALO ===== */
function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;

  players.forEach(p => {
    p.rotationTime = 0;
    p.rotationOutTime = 0;
    if(!p.isGK) p.fatigue = Math.max(0, p.fatigue * 0.30);
  });

  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== INTERA√á√ÉO JOGADOR (limit 5 + eventos) ===== */
function onPlayerClick(id){
  if(pendingPlayerEvent){
    addPlayerEvent(pendingPlayerEvent, id);
    pendingPlayerEvent = null;
    updatePlayersUI();
    return;
  }
  // comportamento normal: entrar/sair
  const p=players.find(x=>x.id===id); if(!p) return;
  if(!p.active && activeCount() >= 5){ flashLimit(id); return; }
  p.active=!p.active;
  if(p.active){
    p.rotations++; p.startTime=Date.now(); p.rotationTime=0; p.rotationOutTime=0;
  }else{
    p.lastRotation=p.rotationTime; p.rotationTime=0; p.rotationOutTime=0;
  }
  updatePlayersUI(); updateSummary(); saveData();
}

function addPlayerEvent(type, playerId){
  const p = players.find(x=>x.id===playerId); if(!p) return;
  // Atualiza estado do jogador
  if(type==="FK_P") p.fouls++;
  if(type==="YC_P") p.yc = true;
  if(type==="RC_P") p.rc = true;

  // Guarda evento (s√≥ playerId; o nome √© resolvido dinamicamente)
  timeline.unshift({ t: Date.now(), clock: formatTime(remaining), type, playerId });
  tlSave(); tlRender(); updatePlayersUI(); saveData();
}

function setPending(type){
  pendingPlayerEvent = type; // ativa modo de sele√ß√£o
  updatePlayersUI();
}

/* ===== PERSIST√äNCIA ===== */
function saveData(){
  const data = {
    teamA: teamA.value||"", teamB: teamB.value||"",
    duration, remaining, firstHalf, running, theme,
    players, lastSaved: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  tlSave();
}
function loadData(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){ players=[]; ensurePlayerCount(14); updateTimerDisplay(); updateHalfBadge(); updateSummary(); tlLoad(); return; }
  const d=JSON.parse(raw);
  teamA.value=d.teamA||""; teamB.value=d.teamB||"";
  duration  = typeof d.duration  === "number" ? d.duration  : duration;
  remaining = typeof d.remaining === "number" ? d.remaining : remaining;
  firstHalf = typeof d.firstHalf === "boolean" ? d.firstHalf : firstHalf;
  running   = !!d.running;
  theme     = d.theme || theme;

  players = (Array.isArray(d.players)?d.players:[]).map((p,i)=>({
    ...PLAYER_DEFAULTS,
    id:p.id ?? (i+1),
    name:p.name || `Jogador ${p.id ?? (i+1)}`,
    ...p
  }));

  const lastSaved = typeof d.lastSaved === "number" ? d.lastSaved : Date.now();
  if(running){
    const e=Math.max(0,Math.floor((Date.now()-lastSaved)/1000));
    if(e>0){
      remaining=Math.max(0,remaining-e);
      players.forEach(p=>{
        if(p.active){ 
          p.seconds+=e; p.rotationTime+=e; if(firstHalf) p.part1+=e; else p.part2+=e;
          if(!p.isGK){
            p.fatigue += FATIGUE_K_UP * (1 - p.fatigue) * e;
            if(p.fatigue>1) p.fatigue=1;
          }
        }else{ 
          p.secondsOut+=e; p.rotationOutTime+=e;
          if(!p.isGK){
            p.fatigue -= FATIGUE_K_DOWN * p.fatigue * e;
            if(p.fatigue<0) p.fatigue=0;
          }
        }
      });
    }
  }
  if(players.length===0) ensurePlayerCount(14); else buildPlayersDOM();
  updatePlayersUI(); updateSummary(); updateTimerDisplay(); updateHalfBadge();
  if(running && remaining>0) startTimer();

  tlLoad();
}
window.addEventListener("beforeunload", saveData);
setInterval(saveData, 3000);

/* ===== HIST√ìRICO LOCAL ===== */
function getHistory(){ return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
function saveGameToHistory(){
  const snapshot = {
    when: new Date().toISOString(),
    teamA: (teamA.value||"").trim(),
    teamB: (teamB.value||"").trim(),
    duration,
    totals: players.map(p=>({
      id:p.id, name:p.name, isGK: !!p.isGK,
      seconds:p.seconds, secondsOut:p.secondsOut,
      rotations:p.rotations, part1:p.part1, part2:p.part2,
      workload:p.seconds - p.secondsOut,
      plusMinus:p.plusMinus||0, fouls:p.fouls||0, yc:!!p.yc, rc:!!p.rc
    })),
    events: timeline.slice(0, 300) // guarda √∫ltimos 300 eventos
  };
  const hist=getHistory(); hist.unshift(snapshot); setHistory(hist);
  renderHistoryList();
}
function renderHistoryList(){
  const list=document.getElementById("historyList");
  const hist=getHistory();
  if(hist.length===0){ list.innerHTML='<div class="hist-item">Sem jogos guardados.</div>'; return; }
  list.innerHTML="";
  hist.forEach((h,idx)=>{
    const div=document.createElement("div");
    const d=new Date(h.when);
    const title=`${h.teamA||'Equipa A'} vs ${h.teamB||'Equipa B'}`;
    div.className="hist-item";
    div.innerHTML=`<div class="row"><div>
        <div><strong>${title}</strong></div>
        <div class="meta">${d.toLocaleString()}</div>
      </div></div>
      <div class="hist-actions">
        <button onclick="exportCsv(${idx})">CSV</button>
        <button onclick="exportPngFromHistory(${idx})">PNG</button>
        <button onclick="deleteHistoryItem(${idx})" style="background:#a33">Apagar</button>
      </div>`;
    list.appendChild(div);
  });
}
function deleteHistoryItem(i){ const hist=getHistory(); hist.splice(i,1); setHistory(hist); renderHistoryList(); }
function clearHistory(){ setHistory([]); renderHistoryList(); }
function exportCsv(index){
  const h=getHistory()[index]; if(!h) return;
  const rows=[["Jogador","GR","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload","+/-","Faltas","YC","RC"]];
  h.totals.forEach(t=>{
    const total = t.part1 + t.part2;
    const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
    const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
    rows.push([
      t.name, t.isGK?"Sim":"N√£o",
      formatTime(t.part1), formatTime(t.part2),
      formatTime(total), formatTime(t.secondsOut),
      t.rotations, formatTime(avg), percent,
      (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m",
      t.plusMinus||0, t.fouls||0, t.yc?"Sim":"N√£o", t.rc?"Sim":"N√£o"
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const a=document.createElement("a");
  const ts=new Date(h.when).toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`Resumo_${(h.teamA||'EquipaA')}_vs_${(h.teamB||'EquipaB')}_${ts}.csv`;
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.click();
}

/* ===== PRINT ‚Üí PNG (tabela + timeline) ===== */
function printScreen(){ exportPngFromCurrent(); }

function exportPngFromCurrent(){
  const nameA=(document.getElementById("teamA").value || "Equipa A").trim();
  const nameB=(document.getElementById("teamB").value || "Equipa B").trim();
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = players.map(p=>{
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1) + "%";
    const workload = p.seconds - p.secondsOut;
    const workloadText = `${workload >= 0 ? "+" : ""}${(workload/60).toFixed(1)}m`;
    return [
      p.name + (p.isGK?' üß§':''), formatTime(p.part1), formatTime(p.part2),
      formatTime(total), formatTime(p.secondsOut),
      String(p.rotations), formatTime(avg), percent, workloadText
    ];
  });

  // timeline -> linhas de texto, com nomes din√¢micos
  const events = (timeline || []).map(ev=>{
    const base = `${ev.clock} ‚Ä¢ ${tlLabel(ev.type)}`;
    if(ev.type==="GF_A" || ev.type==="GA_A"){
      const names = (ev.activeIds||[]).map(id => (players.find(p=>p.id===id)?.name || `#${id}`) + (players.find(p=>p.id===id)?.isGK?' üß§':''));
      const extra = names.length ? ` ‚Äî Em campo: ${names.join(", ")}` : "";
      return base + extra;
    }
    if(ev.type.endsWith("_P")){
      const p = players.find(x=>x.id===ev.playerId);
      const nm = p ? p.name + (p.isGK?' üß§':'') : `#${ev.playerId||'?'}`;
      return `${ev.clock} ‚Ä¢ ${tlLabel(ev.type)} ‚Äî ${nm}`;
    }
    return base;
  });

  renderReportPng(`${nameA} vs ${nameB}`, headers, rows, events, `Resumo_${nameA}_vs_${nameB}`);
}

function exportPngFromHistory(index){
  const h=getHistory()[index]; if(!h) return;
  const nameA=h.teamA||"Equipa A", nameB=h.teamB||"Equipa B";
  const headers=["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = h.totals.map(t=>{
    const total = t.part1 + t.part2;
    const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
    const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
    const workloadText = (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m";
    return [
      t.name + (t.isGK?' üß§':''), formatTime(t.part1), formatTime(t.part2),
      formatTime(total), formatTime(t.secondsOut),
      String(t.rotations), formatTime(avg), percent, workloadText
    ];
  });

  const events = (h.events || []).map(ev=>{
    const base = `${ev.clock} ‚Ä¢ ${tlLabel(ev.type)}`;
    if(ev.type==="GF_A" || ev.type==="GA_A"){
      const names = (ev.activeIds||[]).map(id => {
        const t = h.totals.find(x=>x.id===id);
        return (t ? t.name : `#${id}`) + ((t&&t.isGK)?' üß§':'');
      });
      const extra = names.length ? ` ‚Äî Em campo: ${names.join(", ")}` : "";
      return base + extra;
    }
    if(ev.type.endsWith("_P")){
      const t = h.totals.find(x=>x.id===ev.playerId);
      const nm = t ? t.name + (t.isGK?' üß§':'') : `#${ev.playerId||'?'}`;
      return `${ev.clock} ‚Ä¢ ${tlLabel(ev.type)} ‚Äî ${nm}`;
    }
    return base;
  });

  renderReportPng(`${nameA} vs ${nameB}`, headers, rows, events, `Resumo_${nameA}_vs_${nameB}`);
}

function renderReportPng(title, headers, rows, events, basename){
  // ‚Äî‚Äî Layout base
  const colWidths = [280,120,120,150,150,90,100,90,140]; // por coluna
  const tableWidth = colWidths.reduce((a,b)=>a+b, 0);
  const margin=20, innerPad=12;
  const titleFont="bold 20px Arial, sans-serif";
  const headFont="bold 14px Arial, sans-serif";
  const rowFont="14px Arial, sans-serif";
  const smallFont="13px Arial, sans-serif";
  const rowH=34, headerH=36, titleH=28;

  // ‚Äî‚Äî Medir altura da tabela
  const tableCardW = tableWidth + innerPad*2;
  const tableCardH = innerPad + headerH + rows.length*rowH + innerPad;

  // ‚Äî‚Äî Preparar linhas da Timeline (com word-wrap)
  const timelineTitleH = 24;
  const timelineCardW = Math.max(tableCardW, 700);
  const timelineInnerW = timelineCardW - innerPad*2;
  const wrapLines = [];
  const canvasMeasure = document.createElement("canvas").getContext("2d");
  canvasMeasure.font = smallFont;

  function wrapTextToLines(text, maxWidth, ctx){
    const words = text.split(" ");
    let line="", out=[];
    for(const w of words){
      const test = line ? line + " " + w : w;
      if(ctx.measureText(test).width <= maxWidth){
        line = test;
      }else{
        if(line) out.push(line);
        line = w;
      }
    }
    if(line) out.push(line);
    return out;
  }

  const maxEvents = Math.min(events.length, 200);
  for(let i=0;i<maxEvents;i++){
    const ev = events[i];
    const lines = wrapTextToLines(ev, timelineInnerW - 8, canvasMeasure);
    wrapLines.push(...lines);
  }

  const lineH = 20;
  const timelineBodyH = wrapLines.length * lineH;
  const timelineCardH = innerPad + timelineTitleH + 6 + timelineBodyH + innerPad;

  // ‚Äî‚Äî Altura total do canvas
  const contentWidth = Math.max(tableCardW, timelineCardW);
  const canvasWidth = Math.max(contentWidth + margin*2, 900);
  const totalHeight = margin + titleH + 8
                    + innerPad + tableCardH + 16
                    + timelineCardH + margin;

  const canvas=document.createElement("canvas");
  canvas.width=canvasWidth; canvas.height=totalHeight;
  const ctx=canvas.getContext("2d");

  // ‚Äî‚Äî Fundo
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvasWidth,totalHeight);

  // ‚Äî‚Äî T√≠tulo
  ctx.fillStyle="#000"; ctx.font=titleFont; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(title, canvasWidth/2, margin + titleH/2);

  // ‚Äî‚Äî Cart√£o Tabela
  let cardX=(canvasWidth - tableCardW)/2, cardY=margin + titleH + 8;
  ctx.fillStyle="#fff"; ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
  const r=10;
  ctx.beginPath();
  ctx.moveTo(cardX + r, cardY);
  ctx.lineTo(cardX + tableCardW - r, cardY);
  ctx.quadraticCurveTo(cardX + tableCardW, cardY, cardX + tableCardW, cardY + r);
  ctx.lineTo(cardX + tableCardW, cardY + tableCardH - r);
  ctx.quadraticCurveTo(cardX + tableCardW, cardY + tableCardH, cardX + tableCardW - r, cardY + tableCardH);
  ctx.lineTo(cardX + r, cardY + tableCardH);
  ctx.quadraticCurveTo(cardX, cardY + tableCardH, cardX, cardY + tableCardH - r);
  ctx.lineTo(cardX, cardY + r);
  ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // ‚Äî‚Äî Cabe√ßalho da tabela
  let x=cardX + innerPad, y=cardY + innerPad;
  ctx.fillStyle="#eee"; ctx.fillRect(x - 1, y, tableWidth + 2, headerH);
  ctx.fillStyle="#000"; ctx.font=headFont; ctx.textAlign="left"; ctx.textBaseline="middle";
  let colX=x; headers.forEach((h,i)=>{ ctx.fillText(h, colX + 8, y + headerH/2); colX += colWidths[i]; });

  // linhas horizontais topo/abaixo do header
  ctx.strokeStyle="#999"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x + tableWidth, y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x,y + headerH); ctx.lineTo(x + tableWidth, y + headerH); ctx.stroke();

  // ‚Äî‚Äî Linhas da tabela
  ctx.font=rowFont; let rowY=y + headerH;
  for(let rI=0;rI<rows.length;rI++){
    const row=rows[rI];
    ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(x, rowY + rowH); ctx.lineTo(x + tableWidth, rowY + rowH); ctx.stroke();
    let cx=x;
    for(let c=0;c<row.length;c++){
      const cell=String(row[c] ?? "");
      const maxW = colWidths[c] - 14;
      ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.textBaseline="middle";
      ctx.save(); let text=cell;
      while(ctx.measureText(text).width > maxW){ if(text.length<=1) break; text = text.slice(0,-1); }
      if(text !== cell) text = text.slice(0,-1) + "‚Ä¶";
      ctx.fillText(text, cx + 7, rowY + rowH/2); ctx.restore();
      // linhas verticais
      ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(cx, rowY); ctx.lineTo(cx, rowY + rowH); ctx.stroke();
      cx += colWidths[c];
    }
    ctx.beginPath(); ctx.moveTo(x + tableWidth, rowY); ctx.lineTo(x + tableWidth, rowY + rowH); ctx.stroke();
    rowY += rowH;
  }
  // moldura exterior
  ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.strokeRect(x - 1, y, tableWidth + 2, headerH + rows.length*rowH);

  // ‚Äî‚Äî Cart√£o Timeline (abaixo da tabela)
  const timelineTitleH = 24;
  const tlCardX = (canvasWidth - Math.max(tableCardW, 700))/2;
  const tlCardW = Math.max(tableCardW, 700);
  const tlCardY = cardY + tableCardH + 16;
  // medir altura j√° calculada acima: usamos wrapLines
  const canvasMeasure2 = document.createElement("canvas").getContext("2d");
  canvasMeasure2.font = smallFont;
  const wrapLines = [];
  const timelineInnerW = tlCardW - innerPad*2;
  function wrapTextToLines2(text){ // rewrap com o novo W
    const words = text.split(" ");
    let line="", out=[];
    for(const w of words){
      const test = line ? line + " " + w : w;
      if(canvasMeasure2.measureText(test).width <= timelineInnerW - 8){ line = test; }
      else { if(line) out.push(line); line = w; }
    }
    if(line) out.push(line);
    return out;
  }
  const maxEvents = Math.min(events.length, 200);
  for(let i=0;i<maxEvents;i++){ wrapLines.push(...wrapTextToLines2(events[i])); }
  const lineH = 20;
  const tlBodyH = wrapLines.length * lineH;
  const tlCardH = innerPad + timelineTitleH + 6 + tlBodyH + innerPad;

  // cart√£o
  ctx.fillStyle="#fff"; ctx.strokeStyle="#ccc"; ctx.lineWidth=1;
  const r2=10;
  ctx.beginPath();
  ctx.moveTo(tlCardX + r2, tlCardY);
  ctx.lineTo(tlCardX + tlCardW - r2, tlCardY);
  ctx.quadraticCurveTo(tlCardX + tlCardW, tlCardY, tlCardX + tlCardW, tlCardY + r2);
  ctx.lineTo(tlCardX + tlCardW, tlCardY + tlCardH - r2);
  ctx.quadraticCurveTo(tlCardX + tlCardW, tlCardY + tlCardH, tlCardX + tlCardW - r2, tlCardY + tlCardH);
  ctx.lineTo(tlCardX + r2, tlCardY + tlCardH);
  ctx.quadraticCurveTo(tlCardX, tlCardY + tlCardH, tlCardX, tlCardY + tlCardH - r2);
  ctx.lineTo(tlCardX, tlCardY + r2);
  ctx.quadraticCurveTo(tlCardX, tlCardY, tlCardX + r2, tlCardY);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // t√≠tulo "Timeline"
  let tx = tlCardX + innerPad, ty = tlCardY + innerPad;
  ctx.font = headFont; ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.textBaseline="middle";
  ctx.fillText("Timeline", tx, ty + timelineTitleH/2);

  // linhas dos eventos
  ctx.font = smallFont; ctx.fillStyle="#000";
  let lineY = ty + timelineTitleH + 6;
  if(wrapLines.length === 0){
    ctx.fillText("‚Äî sem eventos ‚Äî", tx, lineY + lineH/2);
  }else{
    wrapLines.forEach(line=>{
      ctx.fillText(line, tx, lineY + lineH/2);
      lineY += lineH;
    });
  }

  // ‚Äî‚Äî Export
  const a=document.createElement("a");
  const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download=`${basename}_${ts}.png`;
  a.href=canvas.toDataURL("image/png");
  a.click();
}

/* ===== TEMA / FULLSCREEN ===== */
function toggleTheme(){
  const btn=themeToggle;
  document.body.classList.toggle("light-mode");
  theme=document.body.classList.contains("light-mode")?"light":"dark";
  btn.textContent=theme==="dark"?"üåô":"üåû";
  saveData();
}

/* ===== PAINEL DE NOMES (com GR) ===== */
const editPanel=document.getElementById("editPanel"), editList=document.getElementById("editList");
editNamesBtn.onclick=()=>{
  editList.innerHTML="";
  players.forEach(p=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <span style="color:#aaa;width:26px;text-align:right">${p.id}.</span>
      <input type="text" id="nameEdit${p.id}" value="${p.name}">
      <label><input type="checkbox" id="gkEdit${p.id}" ${p.isGK?'checked':''}> üß§ GR</label>
    `;
    editList.appendChild(row);
  });
  editPanel.classList.add("open");
};
closePanel.onclick=()=>editPanel.classList.remove("open");
saveNamesBtn.onclick=()=>{
  players.forEach(p=>{
    const v=document.getElementById("nameEdit"+p.id).value.trim();
    const gk=document.getElementById("gkEdit"+p.id).checked;
    if(v) p.name=v;
    p.isGK = !!gk;
    if(p.isGK){ p.fatigue=0; }
  });
  editPanel.classList.remove("open");
  buildPlayersDOM();
  updatePlayersUI(); updateSummary(); saveData();
};

/* ===== TIMELINE ===== */
function tlSave(){ localStorage.setItem(TL_KEY, JSON.stringify(timeline)); }
function tlLoad(){
  timeline = JSON.parse(localStorage.getItem(TL_KEY) || "[]");
  tlRender();
}
function tlLabel(type){
  const map = {
    GF_A: "Golo A", GA_A: "Golo Sofrido A",
    FK_P: "Falta", YC_P: "Amarelo", RC_P: "Vermelho",
    TO_A: "Time-out A"
  }; return map[type] || type;
}
function tlClass(type){
  if(type==="GF_A") return "tl-gf";
  if(type==="GA_A") return "tl-ga";
  if(type==="FK_P") return "tl-fk";
  if(type==="YC_P") return "tl-yc";
  if(type==="RC_P") return "tl-rc";
  if(type==="TO_A") return "tl-to";
  return "";
}
function tlAddTeam(type){
  // captura jogadores ativos (para golos)
  const activeIds = players.filter(p=>p.active).map(p=>p.id);
  // Atualiza +/- dos 5 em campo
  if(type==="GF_A"){ players.forEach(p=>{ if(p.active) p.plusMinus = (p.plusMinus||0) + 1; }); }
  if(type==="GA_A"){ players.forEach(p=>{ if(p.active) p.plusMinus = (p.plusMinus||0) - 1; }); }
  timeline.unshift({ t: Date.now(), clock: formatTime(remaining), type, activeIds });
  tlSave(); tlRender(); updateSummary(); saveData();
}
function tlRender(){
  const feed = document.getElementById("timelineFeed");
  if(!feed) return;
  feed.innerHTML = "";
  timeline.forEach(ev=>{
    const chip = document.createElement("div");
    chip.className = "tl-chip " + tlClass(ev.type);
    let text = `${ev.clock} ‚Ä¢ ${tlLabel(ev.type)}`;
    if(ev.type==="GF_A" || ev.type==="GA_A"){
      const names = (ev.activeIds||[]).map(id => (players.find(p=>p.id===id)?.name || `#${id}`) + (players.find(p=>p.id===id)?.isGK?' üß§':''));
      if(names.length) chip.title = "Em campo: " + names.join(", ");
    }
    if(ev.type.endsWith("_P") && ev.playerId){
      const p = players.find(x=>x.id===ev.playerId);
      const nm = p ? p.name + (p.isGK?' üß§':'') : `#${ev.playerId}`;
      text += ` ‚Äî ${nm}`;
    }
    chip.textContent = text;
    feed.appendChild(chip);
  });
}

/* Liga bot√µes timeline */
document.querySelectorAll("#timelineBar .tl-btn").forEach(btn=>{
  if(btn.classList.contains("tl-player")){
    btn.addEventListener("click", ()=> setPending(btn.dataset.type));
  }else{
    btn.addEventListener("click", ()=> tlAddTeam(btn.dataset.type));
  }
});
document.getElementById("tlClear").onclick = ()=>{
  if(confirm("Limpar timeline?")){ timeline = []; tlSave(); tlRender(); }
};

/* ===== HIST√ìRICO UI ===== */
const historyPanel=document.getElementById("historyPanel");
document.getElementById("historyBtn").onclick=()=>{ renderHistoryList(); historyPanel.classList.add("open"); };
document.getElementById("closeHistory").onclick=()=>historyPanel.classList.remove("open");
document.getElementById("saveGameBtn").onclick=saveGameToHistory;
document.getElementById("clearHistoryBtn").onclick=clearHistory;
document.getElementById("exportAllCsvBtn").onclick=()=>{
  const hist=getHistory(); if(hist.length===0) return;
  let csv="Data,EquipaA,EquipaB,Jogador,GR,1aParte,2aParte,Total,TempoFora,Rotacoes,Media,Percent,Workload,PlusMinus,Faltas,YC,RC\n";
  hist.forEach(h=>{
    const d=new Date(h.when).toISOString();
    h.totals.forEach(t=>{
      const total = t.part1 + t.part2;
      const avg = t.rotations > 0 ? Math.floor(total / t.rotations) : 0;
      const percent = ((total / (duration * 2)) * 100).toFixed(1) + "%";
      csv += [
        d, JSON.stringify(h.teamA||""), JSON.stringify(h.teamB||""),
        JSON.stringify(t.name), t.isGK?"Sim":"N√£o",
        formatTime(t.part1), formatTime(t.part2),
        formatTime(total), formatTime(t.secondsOut),
        t.rotations, formatTime(avg), percent,
        (t.workload>=0?"+":"")+(t.workload/60).toFixed(1)+"m",
        t.plusMinus||0, t.fouls||0, t.yc?"Sim":"N√£o", t.rc?"Sim":"N√£o"
      ].join(",") + "\n";
    });
  });
  const a=document.createElement("a"); a.download="historico_gamecontrol.csv";
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.click();
};

/* ===== BOT√ïES ===== */
document.getElementById("startBtn").onclick=startTimer;
document.getElementById("pauseBtn").onclick=pauseTimer;
document.getElementById("resetBtn").onclick=resetTimer;
document.getElementById("intervalBtn").onclick=intervalTimer;
document.getElementById("addBtn").onclick=()=>ensurePlayerCount(players.length+1);
document.getElementById("removeBtn").onclick=()=>{if(players.length>1){players.pop();buildPlayersDOM();updatePlayersUI();updateSummary();saveData();}}
document.getElementById("printBtn").onclick=printScreen;
document.getElementById("themeToggle").onclick=toggleTheme;
document.getElementById("fullscreenBtn").onclick=()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();};

/* ===== START ===== */
buildPlayersDOM();
updateTimerDisplay();
updateHalfBadge();
loadData();
</script>
</body>
</html>
