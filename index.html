<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Control</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0; background: #1e1e1e; color: #fff; text-align: center;
}
header {
  display: flex; align-items: center; justify-content: center;
  background: #2e2e2e; padding: 10px; position: relative;
}
header h1 {
  margin: 0 auto; font-size: 1.5em;
}
.controls {
  display: flex; justify-content: center; flex-wrap: wrap; gap: 6px;
  background: #2e2e2e; padding: 10px;
}
.controls button {
  padding: 6px 10px; border: none; border-radius: 5px;
  cursor: pointer; font-size: 14px; background: #444; color: #fff;
}
#timer {
  font-size: 3em; margin: 10px 0;
}
#players {
  display: flex; flex-wrap: wrap; justify-content: center;
  gap: 12px; padding: 10px;
}
.player {
  width: 150px; height: 130px; border-radius: 10px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  font-size: 18px; cursor: pointer; transition: all 0.3s;
}
.player.active { background: #2ecc71; color: #000; }
.player.inactive { background: #c0392b; color: #fff; }
.player .time { font-size: 20px; font-weight: bold; }
.summary {
  margin: 15px auto; border-collapse: collapse; width: 90%; max-width: 1000px;
}
.summary th, .summary td {
  border: 1px solid #555; padding: 6px; text-align: center;
}
.summary th { background: #333; }
.work-pos { color: #2ecc71; }
.work-neg { color: #e74c3c; }
.light-mode {
  background: #f4f4f4; color: #000;
}
.light-mode header { background: #ddd; }
.light-mode .controls { background: #ddd; }
.light-mode .player.active { background: #27ae60; color: #fff; }
.light-mode .player.inactive { background: #e74c3c; color: #fff; }
#teamInputs {
  display: flex; justify-content: center; align-items: center;
  gap: 10px; margin: 10px;
}
#teamInputs input {
  padding: 5px 10px; border-radius: 5px; border: none;
  font-size: 16px; text-align: center;
}
.top-buttons {
  position: absolute; right: 10px; top: 10px;
  display: flex; gap: 8px;
}
.top-buttons button {
  background: none; border: none; font-size: 22px; cursor: pointer; color: inherit;
}
</style>
</head>
<body>
<header>
  <h1>Game Control</h1>
  <div class="top-buttons">
    <button id="themeToggle">ðŸŒ™</button>
    <button id="fullscreenBtn">â›¶</button>
    <button id="printBtn">ðŸ“¸</button>
  </div>
</header>

<div id="teamInputs">
  <input id="teamA" placeholder="Equipa A">
  <span style="font-weight:bold;">vs</span>
  <input id="teamB" placeholder="Equipa B">
</div>

<div id="timer">20:00</div>

<div class="controls">
  <input id="setMinutes" type="number" value="20" min="1" style="width:60px;">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausar</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">âˆ’</button>
</div>

<div id="players"></div>

<table class="summary">
  <thead>
    <tr>
      <th>Jogador</th>
      <th>Tempo em Campo</th>
      <th>Tempo Fora</th>
      <th>RotaÃ§Ãµes</th>
      <th>MÃ©dia</th>
      <th>% Jogo</th>
      <th>Workload</th>
    </tr>
  </thead>
  <tbody id="summaryBody"></tbody>
</table>

<script>
let duration = 20 * 60;
let remaining = duration;
let lastSaveTime = Date.now();
let startTimestamp = null;
let timerInterval;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";

function formatTime(sec) {
  const s = Math.max(0, Math.abs(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
}

function updateTimerDisplay() {
  document.getElementById("timer").textContent = formatTime(remaining);
}

function tick() {
  remaining--;
  updateTimerDisplay();
  players.forEach(p => {
    if (p.active) {
      p.seconds++;
      if (firstHalf) p.part1++;
      else p.part2++;
    } else {
      p.secondsOut++;
    }
  });
  updateSummary();
  updatePlayersUI();
}

function startTimer() {
  if (running) return;
  running = true;
  startTimestamp = Date.now();
  timerInterval = setInterval(tick, 1000);
  saveData();
}

function pauseTimer() {
  running = false;
  clearInterval(timerInterval);
  saveData();
}

function resetTimer() {
  pauseTimer();
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;
  players.forEach(p => {
    p.seconds = 0; p.secondsOut = 0; p.part1=0; p.part2=0; p.rotations=0; p.lastRotation=0;
  });
  firstHalf = true;
  updateTimerDisplay();
  updateSummary();
  updatePlayersUI();
  saveData();
}

function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  remaining = parseInt(document.getElementById("setMinutes").value) * 60;
  updateTimerDisplay();
  saveData();
}

function togglePlayer(id) {
  const p = players.find(x => x.id === id);
  if (!p) return;
  p.active = !p.active;
  if (p.active) { p.startTime = Date.now(); p.rotations++; }
  else {
    const last = Math.floor((Date.now() - p.startTime)/1000);
    p.lastRotation = last;
  }
  updatePlayersUI();
  updateSummary();
  saveData();
}

function updatePlayersUI() {
  players.forEach(p => {
    const div = document.getElementById("player"+p.id);
    div.className = "player " + (p.active ? "active" : "inactive");
    div.querySelector(".time").textContent = p.active ? formatTime(p.seconds) : formatTime(p.secondsOut);
    div.querySelector(".last").textContent = !p.active && p.lastRotation>0 ? "Ãšltima rotaÃ§Ã£o: "+formatTime(p.lastRotation) : "";
  });
}

function createPlayers(count=14) {
  const container = document.getElementById("players");
  container.innerHTML="";
  players = [];
  for (let i=1;i<=count;i++){
    const p={id:i,name:"Jogador "+i,active:false,seconds:0,secondsOut:0,part1:0,part2:0,rotations:0,lastRotation:0,startTime:0};
    players.push(p);
    const div=document.createElement("div");
    div.id="player"+i;
    div.className="player inactive";
    div.innerHTML=`<strong>${p.name}</strong><div class="time">00:00</div><div class="last"></div>`;
    div.onclick=()=>togglePlayer(i);
    container.appendChild(div);
  }
  updatePlayersUI();
}

function updateSummary() {
  const tbody=document.getElementById("summaryBody");
  tbody.innerHTML="";
  players.forEach(p=>{
    const total=p.part1+p.part2;
    const avg=p.rotations>0?total/p.rotations:0;
    const percent=((total/(duration*(firstHalf?1:2)))*100).toFixed(1);
    const workload=p.seconds-p.secondsOut;
    const workClass=workload>=0?"work-pos":"work-neg";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.name}</td>
      <td>${formatTime(p.seconds)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td class="${workClass}">${workload>=0?"+":""}${(workload/60).toFixed(1)}m</td>`;
    tbody.appendChild(tr);
  });
}

function saveData() {
  const data={
    teamA:document.getElementById("teamA").value,
    teamB:document.getElementById("teamB").value,
    players,firstHalf,remaining,duration,theme,running,
    startTimestamp:running?Date.now():null,
    lastSaved:Date.now()
  };
  localStorage.setItem("gameControlData",JSON.stringify(data));
}

function loadData() {
  const data=JSON.parse(localStorage.getItem("gameControlData")||"null");
  if(!data){createPlayers();return;}
  document.getElementById("teamA").value=data.teamA||"";
  document.getElementById("teamB").value=data.teamB||"";
  duration=data.duration; remaining=data.remaining; firstHalf=data.firstHalf;
  theme=data.theme||"dark"; running=data.running||false;
  players=data.players||[]; createPlayers(players.length||14);
  players.forEach(p=>{const ref=document.getElementById("player"+p.id); if(ref) ref.querySelector("strong").textContent=p.name;});
  if(theme==="light") toggleTheme(false);
  updateSummary(); updatePlayersUI(); updateTimerDisplay();
  if(running){
    const elapsed=Math.floor((Date.now()-data.lastSaved)/1000);
    remaining-=elapsed;
    timerInterval=setInterval(tick,1000);
  }
}

function printScreen() {
  const header=`<h2 style="text-align:center;">${document.getElementById("teamA").value} vs ${document.getElementById("teamB").value}</h2>`;
  const table=document.querySelector(".summary").outerHTML;
  const win=window.open("","_blank","width=900,height=700");
  win.document.write(`<html><head><title>Game Control</title></head><body>${header}${table}</body></html>`);
  win.document.close(); win.print();
}

function toggleTheme(save=true){
  const body=document.body; const btn=document.getElementById("themeToggle");
  if(body.classList.contains("light-mode")){
    body.classList.remove("light-mode"); btn.textContent="ðŸŒ™"; theme="dark";
  } else {
    body.classList.add("light-mode"); btn.textContent="ðŸŒž"; theme="light";
  }
  if(save) saveData();
}

document.getElementById("startBtn").onclick=startTimer;
document.getElementById("pauseBtn").onclick=pauseTimer;
document.getElementById("resetBtn").onclick=resetTimer;
document.getElementById("intervalBtn").onclick=intervalTimer;
document.getElementById("printBtn").onclick=printScreen;
document.getElementById("themeToggle").onclick=()=>toggleTheme(true);
document.getElementById("fullscreenBtn").onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};
document.getElementById("addBtn").onclick=()=>{createPlayers(players.length+1);saveData();};
document.getElementById("removeBtn").onclick=()=>{if(players.length>1)createPlayers(players.length-1);saveData();};

setInterval(()=>{if(running) saveData();},3000);
window.onload=loadData;
</script>
</body>
</html>
