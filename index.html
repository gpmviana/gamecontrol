<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game Control</title>
<style>
  body{font-family:Arial, sans-serif;margin:0;background:#1e1e1e;color:#f5f5f5;text-align:center}
  header{display:flex;align-items:center;justify-content:center;background:#333;padding:10px 0;position:relative}
  header h1{margin:0;font-size:1.5em;text-align:center}
  .top-buttons{position:absolute;right:10px;top:8px;display:flex;gap:8px}
  .top-buttons button{background:none;border:none;font-size:22px;color:#fff;cursor:pointer}

  #teamInputs{display:flex;justify-content:center;align-items:center;gap:10px;margin:10px}
  #teamInputs input{padding:6px 10px;border-radius:6px;border:none;font-size:16px;text-align:center}

  /* Timer + badge da parte */
  .timer-row{
    display:flex;align-items:center;justify-content:center;gap:10px;
    margin:10px 0 0 0;
  }
  #timer{font-size:3em}
  .half-badge{
    display:inline-block; padding:4px 10px; border-radius:999px;
    background:#444; color:#fff; font-size:12px; letter-spacing:.3px;
  }

  .controls{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;background:#2e2e2e;padding:10px}
  .controls button{padding:6px 10px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer}

  /* === CAIXAS GRANDES (260x230) + m√°x 5 por linha === */
  #players{
    display:grid;
    grid-template-columns:repeat(5, minmax(0, 1fr));
    gap:18px;
    width:95%;
    max-width:1300px;
    margin:12px auto;
    justify-items:center;
  }
  .player{
    width:100%;
    max-width:260px;
    height:230px;
    border-radius:14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.2s;
    background:#c0392b; /* fora */
    color:#fff;
  }
  .player.active{background:#2ecc71;color:#000} /* dentro */
  .player strong{font-size:20px;margin-bottom:8px}
  .player .time{font-size:40px;font-weight:bold;line-height:1}
  .player .last{font-size:12px;opacity:.9;margin-top:6px}

  @media (max-width:1200px){#players{grid-template-columns:repeat(4,minmax(0,1fr));}}
  @media (max-width:900px){#players{grid-template-columns:repeat(3,minmax(0,1fr));}}
  @media (max-width:600px){#players{grid-template-columns:repeat(2,minmax(0,1fr));}}

  .summary{margin:15px auto;border-collapse:collapse;width:90%;max-width:1000px;background:#2b2b2b;border-radius:10px;padding:10px}
  .summary table{width:100%;border-collapse:collapse}
  .summary th,.summary td{border:1px solid #555;padding:6px;text-align:center}
  .summary th{background:#333}
  .work-pos{color:#2ecc71}.work-neg{color:#e74c3c}

  .light-mode{background:#f4f4f4;color:#000}
  .light-mode header{background:#ddd}
  .light-mode .controls{background:#ddd}
  .light-mode .player.active{background:#27ae60;color:#fff}
  .light-mode .player.inactive{background:#e74c3c;color:#fff}

  /* Painel lateral para editar nomes */
  #editPanel{
    position:fixed; right:-380px; top:25%;
    width:340px; height:50%;
    background:rgba(0,0,0,0.92);
    border-left:2px solid #555; border-radius:10px 0 0 10px;
    padding:15px; box-shadow:-4px 0 8px rgba(0,0,0,.4);
    transition:right .2s ease-in-out; z-index:999; overflow-y:auto;
  }
  #editPanel.open{ right:0; }
  #editPanel h3{ margin:0 0 10px 0; }
  #editPanel .close-btn{
    position:absolute; top:6px; right:8px; background:transparent; border:none;
    color:#fff; font-size:18px; cursor:pointer;
  }
  #editPanel input{
    width:100%; padding:6px; margin-bottom:8px; border-radius:6px; border:1px solid #777;
    background:#1f1f1f; color:#fff;
  }
  #editPanel .save-btn{
    width:100%; padding:8px; border:none; border-radius:6px;
    background:#0078d7; color:#fff; cursor:pointer; margin-top:8px;
  }
</style>
</head>
<body>
<header>
  <h1>Game Control</h1>
  <div class="top-buttons">
    <button id="themeToggle">üåô</button>
    <button id="fullscreenBtn">‚õ∂</button>
    <button id="editNamesBtn">üë•</button>
    <button id="printBtn">üì∏</button>
  </div>
</header>

<div id="teamInputs">
  <input id="teamA" placeholder="Equipa A" />
  <span style="font-weight:bold;">vs</span>
  <input id="teamB" placeholder="Equipa B" />
</div>

<div class="timer-row">
  <div id="timer">20:00</div>
  <span id="halfBadge" class="half-badge">1¬™ Parte</span>
</div>

<div class="controls">
  <input id="setMinutes" type="number" value="20" min="1" style="width:60px;">
  <button id="startBtn">Iniciar</button>
  <button id="pauseBtn">Pausar</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">‚àí</button>
</div>

<div id="players"></div>

<div class="summary">
  <h3>Resumo de Jogo</h3>
  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>Tempo em Campo</th>
        <th>Tempo Fora</th>
        <th>Rota√ß√µes</th>
        <th>M√©dia</th>
        <th>% Jogo</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>

<!-- Painel de edi√ß√£o de nomes -->
<div id="editPanel">
  <button class="close-btn" id="closePanel">‚ùå</button>
  <h3>Editar Jogadores</h3>
  <div id="editList"></div>
  <button class="save-btn" id="saveNamesBtn">Guardar Altera√ß√µes</button>
</div>

<script>
/* ===== ESTADO ===== */
let duration = 20*60;
let remaining = duration;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";
let timerInterval = null;
let _lastTick = null;
const STORAGE_KEY = "gameControlData_gcStable";

/* Campos padr√£o (inclui rota√ß√£o atual e tempo fora atual) */
const PLAYER_DEFAULTS = {
  id: 0, name: "",
  active: false,
  seconds: 0,        // total em campo (tabela)
  secondsOut: 0,     // total fora (tabela)
  part1: 0, part2: 0,
  rotations: 0,
  lastRotation: 0,   // dura√ß√£o da √∫ltima rota√ß√£o conclu√≠da
  startTime: 0,
  rotationTime: 0,   // tempo da rota√ß√£o atual (em campo)
  rotationOutTime: 0 // tempo fora atual desde que saiu
};

/* ===== UTIL ===== */
const pad = n => String(n).padStart(2,"0");
function formatTime(sec){sec=Math.max(0,Math.floor(sec));return `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;}
function updateTimerDisplay(){document.getElementById("timer").textContent = formatTime(remaining);}
function updateHalfBadge(){
  const el=document.getElementById("halfBadge");
  el.textContent = firstHalf ? "1¬™ Parte" : "2¬™ Parte";
}

/* ===== RENDER CAIXAS ===== */
function buildPlayersDOM(){
  const pDiv=document.getElementById("players");
  pDiv.innerHTML="";
  players.forEach(p=>{
    const d=document.createElement("div");
    d.id="player"+p.id;
    d.className="player "+(p.active?"active":"inactive");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime; // rota√ß√£o atual OU tempo fora atual
    d.innerHTML=`<strong>${p.name}</strong>
                 <div class="time">${formatTime(displaySec)}</div>
                 <div class="last">${!p.active&&p.lastRotation>0?"√ölt. rota√ß√£o: "+formatTime(p.lastRotation):""}</div>`;
    d.onclick=()=>togglePlayer(p.id);
    pDiv.appendChild(d);
  });
}
function updatePlayersUI(){
  players.forEach(p=>{
    const d=document.getElementById("player"+p.id);
    if(!d) return;
    d.className="player "+(p.active?"active":"inactive");
    const displaySec = p.active ? p.rotationTime : p.rotationOutTime;
    d.querySelector(".time").textContent = formatTime(displaySec);
    d.querySelector(".last").textContent = (!p.active && p.lastRotation>0) ? ("√ölt. rota√ß√£o: "+formatTime(p.lastRotation)) : "";
    d.querySelector("strong").textContent = p.name;
  });
}

/* ===== LIMITE/CONTAGEM DE JOGADORES (sem perder estado) ===== */
function ensurePlayerCount(n){
  while(players.length < n){
    const id = players.length ? Math.max(...players.map(x=>x.id))+1 : 1;
    players.push({
      ...PLAYER_DEFAULTS,
      id, name:"Jogador "+id
    });
  }
  while(players.length > n){ players.pop(); }
  buildPlayersDOM(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== TABELA ===== */
function updateSummary(){
  const tb=document.getElementById("summaryBody"); tb.innerHTML="";
  players.forEach(p=>{
    const total=p.part1+p.part2;
    const avg=p.rotations>0 ? Math.floor(total/p.rotations) : 0;
    const percent=((total/(duration*(firstHalf?1:2)))*100).toFixed(1);
    const workload=p.seconds-p.secondsOut;
    const cls=workload>=0?"work-pos":"work-neg";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.name}</td>
      <td>${formatTime(p.seconds)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td class="${cls}">${workload>=0?"+":""}${(workload/60).toFixed(1)}m</td>`;
    tb.appendChild(tr);
  });
}

/* ===== CRON√ìMETRO (conta rota√ß√£o atual ou tempo fora atual) ===== */
function tick(){
  const now=Date.now(); if(_lastTick===null)_lastTick=now;
  const delta=Math.max(0,Math.floor((now-_lastTick)/1000));
  if(delta>0){
    remaining=Math.max(0,remaining-delta);
    for(let i=0;i<delta;i++){
      players.forEach(p=>{
        if(p.active){
          p.seconds++;                // total em campo (tabela)
          p.rotationTime++;           // rota√ß√£o atual (caixa)
          if(firstHalf) p.part1++; else p.part2++;
        }else{
          p.secondsOut++;             // total fora (tabela)
          p.rotationOutTime++;        // fora atual (caixa)
        }
      });
    }
    _lastTick=now;
    updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
    if(remaining<=0) pauseTimer();
  }
}
function startTimer(){ if(running) return; running=true; _lastTick=Date.now(); clearInterval(timerInterval); timerInterval=setInterval(tick,250); saveData(); }
function pauseTimer(){ running=false; clearInterval(timerInterval); saveData(); }
function resetTimer(){
  pauseTimer();
  const m=parseInt(document.getElementById("setMinutes").value)||20;
  duration=m*60; remaining=duration; firstHalf=true;
  players.forEach(p=>{
    p.seconds=0; p.secondsOut=0; p.part1=0; p.part2=0; p.rotations=0; p.lastRotation=0;
    p.rotationTime=0; p.rotationOutTime=0;
  });
  updateTimerDisplay(); updateHalfBadge(); updatePlayersUI(); updateSummary(); saveData();
}

/* ===== INTERVALO (pausa, 2.¬™ parte, zera tempos das caixas, mant√©m totais) ===== */
function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;

  players.forEach(p => {
    p.rotationTime = 0;     // tempo da rota√ß√£o atual (em campo)
    p.rotationOutTime = 0;  // tempo fora atual (no banco)
  });

  updateTimerDisplay();
  updateHalfBadge();
  updatePlayersUI();
  updateSummary();
  saveData();
}

/* ===== INTERA√á√ÉO JOGADOR ===== */
function togglePlayer(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  p.active=!p.active;
  if(p.active){
    p.rotations++;
    p.startTime=Date.now();
    p.rotationTime=0;      // come√ßa do zero a rota√ß√£o atual
    p.rotationOutTime=0;   // p√°ra contagem do tempo fora
  }else{
    p.lastRotation=p.rotationTime;
    p.rotationTime=0;
    p.rotationOutTime=0;   // come√ßa a contar tempo fora atual do zero
  }
  updatePlayersUI(); updateSummary(); saveData();
}

/* ===== PERSIST√äNCIA ===== */
function saveData(){
  const data = {
    teamA: teamA.value||"",
    teamB: teamB.value||"",
    duration, remaining, firstHalf, running, theme,
    players,               // inclui rotationTime e rotationOutTime
    lastSaved: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadData(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){
    players=[]; ensurePlayerCount(14); updateTimerDisplay(); updateHalfBadge(); updateSummary(); return;
  }
  const d=JSON.parse(raw);
  teamA.value=d.teamA||""; teamB.value=d.teamB||"";
  duration  = typeof d.duration  === "number" ? d.duration  : duration;
  remaining = typeof d.remaining === "number" ? d.remaining : remaining;
  firstHalf = typeof d.firstHalf === "boolean" ? d.firstHalf : firstHalf;
  running   = !!d.running;
  theme     = d.theme || theme;

  players = (Array.isArray(d.players)?d.players:[]).map((p,i)=>({
    ...PLAYER_DEFAULTS,
    id: p.id ?? (i+1),
    name: p.name || `Jogador ${p.id ?? (i+1)}`,
    ...p
  }));

  const lastSaved = typeof d.lastSaved === "number" ? d.lastSaved : Date.now();
  if(running){
    const e=Math.max(0,Math.floor((Date.now()-lastSaved)/1000));
    if(e>0){
      remaining=Math.max(0,remaining-e);
      players.forEach(p=>{
        if(p.active){
          p.seconds+=e; p.rotationTime+=e;
          if(firstHalf) p.part1+=e; else p.part2+=e;
        }else{
          p.secondsOut+=e; p.rotationOutTime+=e;
        }
      });
    }
  }

  if(players.length===0) ensurePlayerCount(14); else buildPlayersDOM();
  updatePlayersUI(); updateSummary(); updateTimerDisplay(); updateHalfBadge();
  if(running && remaining>0) startTimer();
}
window.addEventListener("beforeunload", saveData);
setInterval(saveData, 3000);

/* ===== PRINT ‚Üí PNG (canvas) ===== */
function printScreen() {
  // --- Dados base ---
  const nameA = (document.getElementById("teamA").value || "Equipa A").trim();
  const nameB = (document.getElementById("teamB").value || "Equipa B").trim();
  const title = `${nameA} vs ${nameB}`;

  // Construir dados da tabela a partir do estado atual
  const headers = ["Jogador","Tempo em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = players.map(p => {
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1) + "%";
    const workload = p.seconds - p.secondsOut;
    const workloadText = `${workload >= 0 ? "+" : ""}${(workload/60).toFixed(1)}m`;
    return [
      p.name,
      formatTime(p.seconds),
      formatTime(p.secondsOut),
      String(p.rotations),
      formatTime(avg),
      percent,
      workloadText
    ];
  });

  // --- Layout do PNG ---
  const colWidths = [280, 150, 150, 90, 100, 90, 140];
  const tableWidth = colWidths.reduce((a,b)=>a+b, 0);

  const margin = 20;
  const titleFont = "bold 20px Arial, sans-serif";
  const headFont  = "bold 14px Arial, sans-serif";
  const rowFont   = "14px Arial, sans-serif";
  const rowH = 34;
  const headerH = 36;

  const titleH = 28;
  const innerPad = 10;
  const contentWidth = tableWidth + innerPad*2;

  const canvasWidth = Math.max(contentWidth + margin*2, 700);
  const canvasHeight =
    margin + titleH + 8 +
    innerPad + headerH + rows.length * rowH + innerPad +
    margin;

  const canvas = document.createElement("canvas");
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  const ctx = canvas.getContext("2d");

  // Fundo branco
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvasWidth, canvasHeight);

  // T√≠tulo
  ctx.fillStyle = "#000000";
  ctx.font = titleFont;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(title, canvasWidth/2, margin + titleH/2);

  // Cart√£o/tabela
  const cardX = (canvasWidth - contentWidth)/2;
  const cardY = margin + titleH + 8;
  const cardW = contentWidth;
  const cardH = innerPad + headerH + rows.length*rowH + innerPad;

  ctx.fillStyle = "#ffffff";
  ctx.strokeStyle = "#cccccc";
  ctx.lineWidth = 1;
  const r = 10;
  ctx.beginPath();
  ctx.moveTo(cardX + r, cardY);
  ctx.lineTo(cardX + cardW - r, cardY);
  ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + r);
  ctx.lineTo(cardX + cardW, cardY + cardH - r);
  ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - r, cardY + cardH);
  ctx.lineTo(cardX + r, cardY + cardH);
  ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - r);
  ctx.lineTo(cardX, cardY + r);
  ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // Cabe√ßalho
  let x = cardX + innerPad;
  let y = cardY + innerPad;

  ctx.fillStyle = "#eeeeee";
  ctx.fillRect(x - 1, y, tableWidth + 2, headerH);

  ctx.fillStyle = "#000000";
  ctx.font = headFont;
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";
  let colX = x;
  headers.forEach((h, i) => {
    ctx.fillText(h, colX + 8, y + headerH/2);
    colX += colWidths[i];
  });

  // Linhas entre header e corpo
  ctx.strokeStyle = "#999999";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + tableWidth, y);
  ctx.moveTo(x, y + headerH);
  ctx.lineTo(x + tableWidth, y + headerH);
  ctx.stroke();

  // Corpo
  ctx.font = rowFont;
  let rowY = y + headerH;
  for (let r = 0; r < rows.length; r++) {
    const row = rows[r];
    // grade horizontal
    ctx.strokeStyle = "#dddddd";
    ctx.beginPath();
    ctx.moveTo(x, rowY + rowH);
    ctx.lineTo(x + tableWidth, rowY + rowH);
    ctx.stroke();

    // c√©lulas
    let cx = x;
    for (let c = 0; c < row.length; c++) {
      const cell = String(row[c] ?? "");
      const maxW = colWidths[c] - 14;
      ctx.fillStyle = "#000000";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.save();
      let text = cell;
      while (ctx.measureText(text).width > maxW) {
        if (text.length <= 1) break;
        text = text.slice(0, -1);
      }
      if (text !== cell) text = text.slice(0, -1) + "‚Ä¶";
      ctx.fillText(text, cx + 7, rowY + rowH/2);
      ctx.restore();

      // linhas verticais
      ctx.strokeStyle = "#dddddd";
      ctx.beginPath();
      ctx.moveTo(cx, rowY);
      ctx.lineTo(cx, rowY + rowH);
      ctx.stroke();

      cx += colWidths[c];
    }
    // borda vertical final
    ctx.beginPath();
    ctx.moveTo(x + tableWidth, rowY);
    ctx.lineTo(x + tableWidth, rowY + rowH);
    ctx.stroke();

    rowY += rowH;
  }

  // Borda externa
  ctx.strokeStyle = "#999999";
  ctx.lineWidth = 1;
  ctx.strokeRect(x - 1, y, tableWidth + 2, headerH + rows.length*rowH);

  // Download PNG
  const a = document.createElement("a");
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download = `Resumo_${nameA}_vs_${nameB}_${ts}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
}

/* ===== TEMA / FULLSCREEN ===== */
function toggleTheme(){
  const btn=themeToggle;
  document.body.classList.toggle("light-mode");
  theme=document.body.classList.contains("light-mode")?"light":"dark";
  btn.textContent=theme==="dark"?"üåô":"üåû";
  saveData();
}

/* ===== PAINEL DE NOMES ===== */
const editPanel=document.getElementById("editPanel"), editList=document.getElementById("editList");
editNamesBtn.onclick=()=>{
  editList.innerHTML="";
  players.forEach(p=>{
    const row=document.createElement("div");
    row.innerHTML=`<label style="font-size:14px;display:block;text-align:left;margin:4px 0">
      ${p.id}. <input type="text" id="nameEdit${p.id}" value="${p.name}"></label>`;
    editList.appendChild(row);
  });
  editPanel.classList.add("open");
};
closePanel.onclick=()=>editPanel.classList.remove("open");
saveNamesBtn.onclick=()=>{
  players.forEach(p=>{
    const v=document.getElementById("nameEdit"+p.id).value.trim();
    if(v) p.name=v;
  });
  editPanel.classList.remove("open");
  updatePlayersUI(); updateSummary(); saveData();
};

/* ===== BOT√ïES ===== */
startBtn.onclick=startTimer;
pauseBtn.onclick=pauseTimer;
resetBtn.onclick=resetTimer;
intervalBtn.onclick=intervalTimer;
addBtn.onclick=()=>ensurePlayerCount(players.length+1);
removeBtn.onclick=()=>{if(players.length>1){players.pop();buildPlayersDOM();updatePlayersUI();updateSummary();saveData();}}
printBtn.onclick=printScreen;
themeToggle.onclick=toggleTheme;
fullscreenBtn.onclick=()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();};

/* ===== START ===== */
updateTimerDisplay();
updateHalfBadge();
loadData();
</script>
</body>
</html>
