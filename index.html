<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Control</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #1e1e1e;
    color: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    background: #333;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
  }
  header h1 {
    flex: 1;
    text-align: center;
    margin: 0;
  }
  .team-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 0;
  }
  .team-inputs input {
    padding: 5px;
    font-size: 16px;
    text-align: center;
  }
  .controls {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .controls button {
    padding: 8px 14px;
    font-size: 14px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
  }
  .timer {
    font-size: 70px;
    margin: 20px 0;
  }
  .players {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    width: 90%;
    max-width: 1200px;
    justify-items: center;
  }
  .player {
    background: #2e2e2e;
    border-radius: 15px;
    padding: 10px;
    text-align: center;
    width: 220px;
    height: 140px;
    transition: background-color 0.3s;
    cursor: pointer;
  }
  .player.active {
    background: #2b6d2b;
  }
  .player.inactive {
    background: #8b2e2e;
  }
  .player strong {
    display: block;
    margin-bottom: 5px;
    font-size: 18px;
  }
  .time {
    font-size: 32px;
    font-weight: bold;
  }
  .last {
    font-size: 12px;
    margin-top: 5px;
    color: #ddd;
  }
  .summary {
    margin-top: 25px;
    width: 90%;
    max-width: 900px;
    background: #2b2b2b;
    border-radius: 10px;
    padding: 10px;
  }
  .summary table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 6px;
    border-bottom: 1px solid #555;
    text-align: center;
  }
  .work-pos { color: #2ecc71; font-weight: bold; }
  .work-neg { color: #e74c3c; font-weight: bold; }
  .top-right-buttons {
    display: flex;
    gap: 10px;
  }
  .top-right-buttons button {
    background: transparent;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <header>
    <div class="top-right-buttons">
      <button id="themeToggle">ðŸŒ™</button>
      <button id="fullscreenBtn">â›¶</button>
      <button id="printBtn">ðŸ“¸</button>
    </div>
    <h1>Game Control</h1>
  </header>

  <div class="team-inputs">
    <input type="text" id="teamA" placeholder="Equipa A">
    <input type="text" id="teamB" placeholder="AdversÃ¡rio">
  </div>

  <div class="timer" id="timer">20:00</div>

  <div class="controls">
    <input type="number" id="setMinutes" value="20" min="1" style="width:60px;"> 
    <button id="startBtn">Iniciar</button>
    <button id="pauseBtn">Pausar</button>
    <button id="intervalBtn">Intervalo</button>
    <button id="resetBtn">Reset</button>
    <button id="addBtn">+</button>
    <button id="removeBtn">âˆ’</button>
  </div>

  <div class="players" id="players"></div>

  <div class="summary">
    <h3>Resumo de Jogo</h3>
    <table>
      <thead>
        <tr>
          <th>Jogador</th><th>Em Campo</th><th>Fora</th>
          <th>RotaÃ§Ãµes</th><th>MÃ©dia</th><th>% Jogo</th><th>Workload</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

<script>
let duration = 20 * 60;
let remaining = duration;
let timerInterval;
let running = false;
let firstHalf = true;
let players = [];
let theme = "dark";

/* ---------- FORMATAÃ‡ÃƒO ---------- */
function formatTime(sec) {
  const s = Math.max(0, Math.abs(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2, "0")}:${String(r).padStart(2, "0")}`;
}
function updateTimerDisplay() {
  document.getElementById("timer").textContent = formatTime(remaining);
}

/* ---------- TICK ---------- */
let _lastTick = null;
function tick() {
  const now = Date.now();
  if (_lastTick === null) _lastTick = now;
  const delta = Math.max(0, Math.floor((now - _lastTick) / 1000));
  if (delta > 0) {
    remaining = Math.max(0, remaining - delta);
    for (let i = 0; i < delta; i++) {
      players.forEach(p => {
        if (p.active) {
          p.seconds++;
          if (firstHalf) p.part1++; else p.part2++;
        } else {
          p.secondsOut++;
        }
      });
    }
    _lastTick = now;
    updateTimerDisplay();
    updateSummary();
    updatePlayersUI();
    saveData();
  }
  if (remaining <= 0) pauseTimer();
}

/* ---------- CONTROLOS ---------- */
function startTimer() {
  if (running) return;
  running = true;
  _lastTick = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(tick, 250);
  saveData();
}
function pauseTimer() {
  running = false;
  clearInterval(timerInterval);
  saveData();
}
function resetTimer() {
  pauseTimer();
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;
  duration = mins * 60;
  remaining = duration;
  players.forEach(p => {
    p.seconds = 0;
    p.secondsOut = 0;
    p.part1 = 0;
    p.part2 = 0;
    p.rotations = 0;
    p.lastRotation = 0;
  });
  firstHalf = true;
  updateTimerDisplay();
  updateSummary();
  updatePlayersUI();
  saveData();
}
function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  remaining = parseInt(document.getElementById("setMinutes").value) * 60;
  updateTimerDisplay();
  saveData();
}

/* ---------- JOGADORES ---------- */
function togglePlayer(id) {
  const p = players.find(x => x.id === id);
  if (!p) return;
  p.active = !p.active;
  if (p.active) {
    p.startTime = Date.now();
    p.rotations++;
  } else {
    const last = Math.floor((Date.now() - p.startTime) / 1000);
    p.lastRotation = last;
  }
  updatePlayersUI();
  updateSummary();
  saveData();
}
function updatePlayersUI() {
  players.forEach(p => {
    const div = document.getElementById("player" + p.id);
    div.className = "player " + (p.active ? "active" : "inactive");
    div.querySelector(".time").textContent = p.active
      ? formatTime(p.seconds)
      : formatTime(p.secondsOut);
    div.querySelector(".last").textContent =
      !p.active && p.lastRotation > 0
        ? "Ãšltima rotaÃ§Ã£o: " + formatTime(p.lastRotation)
        : "";
  });
}
function createPlayers(count = 14) {
  const container = document.getElementById("players");
  container.innerHTML = "";
  players = [];
  for (let i = 1; i <= count; i++) {
    const p = {
      id: i,
      name: "Jogador " + i,
      active: false,
      seconds: 0,
      secondsOut: 0,
      part1: 0,
      part2: 0,
      rotations: 0,
      lastRotation: 0,
      startTime: 0,
    };
    players.push(p);
    const div = document.createElement("div");
    div.id = "player" + i;
    div.className = "player inactive";
    div.innerHTML = `<strong>${p.name}</strong><div class="time">00:00</div><div class="last"></div>`;
    div.onclick = () => togglePlayer(i);
    container.appendChild(div);
  }
  updatePlayersUI();
}

/* ---------- TABELA ---------- */
function updateSummary() {
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = "";
  players.forEach(p => {
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? total / p.rotations : 0;
    const percent = ((total / (duration * (firstHalf ? 1 : 2))) * 100).toFixed(1);
    const workload = p.seconds - p.secondsOut;
    const workClass = workload >= 0 ? "work-pos" : "work-neg";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${formatTime(p.seconds)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td class="${workClass}">${workload >= 0 ? "+" : ""}${(workload / 60).toFixed(1)}m</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- PERSISTÃŠNCIA CORRIGIDA ---------- */
function saveData() {
  const data = {
    teamA: document.getElementById("teamA").value,
    teamB: document.getElementById("teamB").value,
    duration, remaining, firstHalf, running, theme, players,
    lastSaved: Date.now()
  };
  localStorage.setItem("gameControlData", JSON.stringify(data));
}
function loadData() {
  const raw = localStorage.getItem("gameControlData");
  if (!raw) return createPlayers();
  const data = JSON.parse(raw);
  document.getElementById("teamA").value = data.teamA || "";
  document.getElementById("teamB").value = data.teamB || "";
  duration = data.duration || duration;
  remaining = data.remaining || remaining;
  firstHalf = data.firstHalf;
  running = data.running;
  theme = data.theme || theme;
  players = data.players || [];
  const lastSaved = data.lastSaved || Date.now();
  if (running) {
    const elapsed = Math.floor((Date.now() - lastSaved) / 1000);
    if (elapsed > 0) {
      remaining = Math.max(0, remaining - elapsed);
      players.forEach(p => {
        if (p.active) {
          p.seconds += elapsed;
          if (firstHalf) p.part1 += elapsed; else p.part2 += elapsed;
        } else {
          p.secondsOut += elapsed;
        }
      });
    }
  }
  createPlayers(players.length || 14);
  players.forEach(p => {
    const ref = document.getElementById("player" + p.id);
    if (ref) ref.querySelector("strong").textContent = p.name;
  });
  updateSummary();
  updatePlayersUI();
  updateTimerDisplay();
  if (running && remaining > 0) startTimer();
}
window.addEventListener("beforeunload", saveData);
setInterval(saveData, 3000);

/* ---------- OUTROS BOTÃ•ES ---------- */
function printScreen() {
  const header = `<h2 style="text-align:center;">${document.getElementById("teamA").value} vs ${document.getElementById("teamB").value}</h2>`;
  const table = document.querySelector(".summary").innerHTML;
  const win = window.open("", "", "width=900,height=700");
  win.document.write(`<html><head><title>Game Control</title></head><body>${header}${table}</body></html>`);
  win.document.close();
  win.print();
}
function toggleTheme() {
  const btn = document.getElementById("themeToggle");
  document.body.classList.toggle("light-mode");
  theme = document.body.classList.contains("light-mode") ? "light" : "dark";
  btn.textContent = theme === "dark" ? "ðŸŒ™" : "ðŸŒž";
  saveData();
}
document.getElementById("startBtn").onclick = startTimer;
document.getElementById("pauseBtn").onclick = pauseTimer;
document.getElementById("resetBtn").onclick = resetTimer;
document.getElementById("intervalBtn").onclick = intervalTimer;
document.getElementById("printBtn").onclick = printScreen;
document.getElementById("themeToggle").onclick = toggleTheme;
document.getElementById("fullscreenBtn").onclick = () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};
document.getElementById("addBtn").onclick = () => { createPlayers(players.length + 1); saveData(); };
document.getElementById("removeBtn").onclick = () => { if (players.length > 1) createPlayers(players.length - 1); saveData(); };

window.onload = loadData;
</script>
</body>
</html>
