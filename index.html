<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#333333">

<title>Game Control</title>

<style>

body {
  margin: 0;
  padding: 0;
  background: #1b1b1b;
  color: #eee;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
}

body.light-mode {
  background: #f2f2f2;
  color: #222;
}

h1 {
  margin-top: 10px;
  font-size: 32px;
  text-align: center;
}

#topBar {
  width: 95%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 5px;
}

#teamInputs {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 22px;
}

#teamInputs input {
  padding: 6px 10px;
  font-size: 18px;
  border-radius: 6px;
  border: 1px solid #444;
  background: #222;
  color: #fff;
}
body.light-mode #teamInputs input {
  background: #fff;
  color: #000;
}

.scoreBubble {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  font-size: 20px;
  font-weight: 700;
  background: #333;
  color: #fff;
  border-radius: 8px;
  padding: 4px 8px;
}
body.light-mode .scoreBubble {
  background: #ddd;
  color: #222;
}

#rightButtons {
  display: flex;
  gap: 8px;
}

#rightButtons button {
  background: #3a3a3a;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-size: 18px;
}

body.light-mode #rightButtons button {
  background: #ddd;
  color: #111;
}

#timer {
  font-size: 80px;
  margin-top: 10px;
}

.controls {
  margin-top: 10px;
}
.controls button {
  padding: 8px 14px;
  font-size: 18px;
  border-radius: 6px;
  border: none;
  background: #444;
  color: #fff;
}
body.light-mode .controls button {
  background: #ddd;
  color: #111;
}

#players {
  display: grid;
  width: 95%;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  margin-top: 20px;
}

.player {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  border: 2px solid #444;
  cursor: pointer;
  position: relative;
  height: 180px;
}

body.light-mode .player {
  background: #fff;
  border-color: #bbb;
}

.player.active {
  background: #184d18;
  border-color: #2ecc71;
}

.player.inactive {
  background: #4a1a1a;
  border-color: #e74c3c;
}

.player strong {
  font-size: 20px;
  margin-bottom: 8px;
  display: block;
}

.player .time {
  font-size: 48px;
  font-weight: bold;
}

.player .last {
  margin-top: 6px;
  font-size: 14px;
  opacity: 0.8;
}

/* Fadiga */
.fatigueBar {
  position: absolute;
  bottom: 10px;
  left: 10px;
  height: 10px;
  width: calc(100% - 20px);
  border-radius: 6px;
  background: #222;
  overflow: hidden;
}
body.light-mode .fatigueBar {
  background: #ccc;
}

.fatigueFill {
  height: 100%;
  width: 0%;
  background: green;
  transition: width 0.3s linear, background 0.3s linear;
}

/* Tabela */
.summary {
  width: 95%;
  margin-top: 30px;
  background: #222;
  padding: 15px;
  border-radius: 12px;
}
body.light-mode .summary {
  background: #fff;
}

.summary table {
  width: 100%;
  border-collapse: collapse;
}
.summary th {
  text-align: left;
  padding: 8px;
  font-size: 16px;
  border-bottom: 2px solid #444;
}
body.light-mode .summary th {
  border-bottom-color: #bbb;
}

.summary td {
  padding: 8px;
  border-bottom: 1px solid #444;
}
body.light-mode .summary td {
  border-bottom-color: #ccc;
}

/* Timeline fixa */
#timelineBar {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #111;
  border-top: 2px solid #444;
  padding: 6px 10px;
  display: flex;
  gap: 10px;
  justify-content: center;
  z-index: 900;
}
body.light-mode #timelineBar {
  background: #eee;
  border-color: #bbb;
}

#timelineBar button {
  padding: 8px 10px;
  border: none;
  border-radius: 6px;
  background: #333;
  color: #fff;
  font-size: 18px;
}
body.light-mode #timelineBar button {
  background: #ccc;
  color: #111;
}

#timelineDetails {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.25s ease-out;
  width: 100%;
  background: #000a;
  backdrop-filter: blur(4px);
  padding: 0 20px;
}

#timelineList {
  padding-bottom: 20px;
  padding-top: 10px;
}

.timelineItem {
  margin-bottom: 8px;
  padding: 6px 10px;
  background: #222;
  border-radius: 8px;
  color: #eee;
  border-left: 4px solid #888;
}
body.light-mode .timelineItem {
  background: #f2f2f2;
  color: #111;
  border-left-color: #777;
}</style>
</head>
<body>

<h1 id="mainTitle">GAME CONTROL</h1>

<div id="topBar">

  <div id="teamInputs">
    <input id="teamA" placeholder="Equipa A">
    <span class="scoreBubble" id="scoreA">0</span>
    <span style="font-size:24px;font-weight:700;">-</span>
    <span class="scoreBubble" id="scoreB">0</span>
    <input id="teamB" placeholder="Equipa B">
  </div>

  <div id="rightButtons">
    <button id="themeToggle">ðŸŒ™</button>
    <button id="fullscreenBtn">â›¶</button>
    <button id="editNamesBtn">âœŽ</button>
    <button id="printBtn">ðŸ“¸</button>
  </div>

</div>

<div id="timer">20:00</div>

<div class="controls">
  <input type="number" id="setMinutes" value="20" style="width:60px;"> 
  <button id="startBtn">Start</button>
  <button id="pauseBtn">Pause</button>
  <button id="intervalBtn">Intervalo</button>
  <button id="resetBtn">Reset</button>
  <button id="addBtn">+</button>
  <button id="removeBtn">âˆ’</button>
</div>

<div id="players"></div>

<div class="summary">
  <h2>Resumo</h2>
  <table>
    <thead>
      <tr>
        <th>Jogador</th>
        <th>1Âª Parte</th>
        <th>2Âª Parte</th>
        <th>Total</th>
        <th>RotaÃ§Ãµes</th>
        <th>Ãšltima</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>


<!-- Timeline expandida -->
<div id="timelineDetails">
  <div id="timelineList"></div>
</div>

<!-- Timeline fixa -->
<div id="timelineBar">
  <button id="goloA">Golo A</button>
  <button id="goloB">Golo B</button>
  <button id="faltaBtn">Falta</button>
  <button id="amareloBtn">Amarelo</button>
  <button id="vermelhoBtn">Vermelho</button>
  <button id="toggleTimeline">â–¼</button>
</div>


<script>
// -------------------------------------------
// VARIÃVEIS PRINCIPAIS
// -------------------------------------------
let duration = 20 * 60;
let remaining = duration;
let timerInterval;
let running = false;
let firstHalf = true;

let players = [];
let timeline = [];

let scoreA = 0;
let scoreB = 0;

let editingNames = false;

let theme = "dark";


// -------------------------------------------
// FORMATAR TEMPO
// -------------------------------------------
function formatTime(sec) {
  const s = Math.max(0, Math.abs(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
}


// -------------------------------------------
// ATUALIZAR DISPLAY DO CRONÃ“METRO
// -------------------------------------------
function updateTimerDisplay() {
  document.getElementById("timer").textContent = formatTime(remaining);
}


// -------------------------------------------
// TICK DO CRONÃ“METRO
// -------------------------------------------
function tick() {
  remaining--;
  updateTimerDisplay();

  players.forEach(p => {
    if (p.active) {
      p.seconds++;
      if (firstHalf) p.part1++;
      else p.part2++;

      // fadiga aumenta
      p.fatigue = Math.min(1, p.fatigue + 0.0045);
    } else {
      // recuperaÃ§Ã£o mais rÃ¡pida
      p.fatigue = Math.max(0, p.fatigue - 0.01);
    }
  });

  updatePlayersUI();
  updateSummary();
  saveData();
}


// -------------------------------------------
// START / PAUSE / RESET / INTERVALO
// -------------------------------------------
function startTimer() {
  if (running) return;
  running = true;
  timerInterval = setInterval(tick, 1000);
}

function pauseTimer() {
  running = false;
  clearInterval(timerInterval);
}

function resetTimer() {
  pauseTimer();
  const mins = parseInt(document.getElementById("setMinutes").value) || 20;

  duration = mins * 60;
  remaining = duration;

  players.forEach(p => {
    p.seconds = 0;
    p.part1 = 0;
    p.part2 = 0;
    p.lastRotation = 0;
    p.startTime = 0;
    p.stint = 0;
  });

  firstHalf = true;
  updateTimerDisplay();
  updatePlayersUI();
  updateSummary();
  saveData();
}

function intervalTimer() {
  pauseTimer();
  firstHalf = false;
  players.forEach(p => p.stint = 0);
  remaining = parseInt(document.getElementById("setMinutes").value) * 60;
  updateTimerDisplay();
  saveData();
}


// -------------------------------------------
// CRIAR / ATUALIZAR CAIXAS
// -------------------------------------------
function createPlayers(count = 14) {

  const container = document.getElementById("players");
  container.innerHTML = "";

  if (players.length !== count) {
    players = [];
    for (let i = 1; i <= count; i++) {
      players.push({
        id: i,
        name: "Jogador " + i,
        active: false,
        seconds: 0,
        part1: 0,
        part2: 0,
        lastRotation: 0,
        startTime: 0,
        stint: 0,
        fatigue: 0,
        rotations: 0,
        isKeeper: false
      });
    }
  }

  players.forEach(p => {
    const div = document.createElement("div");
    div.id = "player" + p.id;
    div.className = "player " + (p.active ? "active" : "inactive");

    div.innerHTML = `
      <strong>${p.isKeeper ? "ðŸ§¤ " : ""}${p.name}</strong>
      <div class="time">${formatTime(p.stint)}</div>
      <div class="last">${p.lastRotation > 0 ? "Ãšltima: " + formatTime(p.lastRotation) : ""}</div>

      <div class="fatigueBar">
        <div class="fatigueFill" id="fatigue${p.id}"></div>
      </div>
    `;

    div.onclick = () => togglePlayer(p.id);
    container.appendChild(div);
  });

  updatePlayersUI();
}


// -------------------------------------------
// LIMITE DE 5 EM CAMPO
// -------------------------------------------
function togglePlayer(id) {

  const p = players.find(x => x.id === id);
  if (!p) return;

  // se estiver a entrar â†’ verificar limite de 5
  if (!p.active) {
    const ativos = players.filter(x => x.active).length;
    if (ativos >= 5) return; // BLOQUEIA
  }

  // SE ATIVAR
  if (!p.active) {
    if (p.startTime === 0) p.rotations++;
    p.startTime = Date.now();
    p.stint = 0;
  }

  // SE DESATIVAR
  else {
    const last = Math.floor((Date.now() - p.startTime) / 1000);
    p.lastRotation = last;
  }

  p.active = !p.active;

  updatePlayersUI();
  updateSummary();
  saveData();
}


// -------------------------------------------
// ATUALIZAR UI DAS CAIXAS
// -------------------------------------------
function updatePlayersUI() {

  players.forEach(p => {
    const div = document.getElementById("player" + p.id);
    if (!div) return;

    div.className = "player " + (p.active ? "active" : "inactive");

    // tempo em rotaÃ§Ã£o / tempo fora
    div.querySelector(".time").textContent = formatTime(p.stint);

    // Ãºltima rotaÃ§Ã£o
    div.querySelector(".last").textContent =
      p.lastRotation > 0 && !p.active
      ? "Ãšltima: " + formatTime(p.lastRotation)
      : "";

    // fadiga
    const f = div.querySelector(".fatigueFill");
    f.style.width = `${p.fatigue * 100}%`;

    if (p.fatigue < 0.33) f.style.background = "green";
    else if (p.fatigue < 0.66) f.style.background = "yellow";
    else f.style.background = "red";
  });
}


// -------------------------------------------
// RESUMO / TABELA
// -------------------------------------------
function updateSummary() {

  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = "";

  players.forEach(p => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${formatTime(p.part1)}</td>
      <td>${formatTime(p.part2)}</td>
      <td>${formatTime(p.part1 + p.part2)}</td>
      <td>${p.rotations}</td>
      <td>${p.lastRotation > 0 ? formatTime(p.lastRotation) : "-"}</td>
      <td>${(p.part1 + p.part2) - p.stint}</td>
    `;

    tbody.appendChild(tr);
  });
}


// -------------------------------------------
// TIMELINE
// -------------------------------------------
function addTimelineEvent(type, text) {
  timeline.push({ type, text, time: formatTime(duration - remaining) });
  saveData();
  renderTimeline();
}

function renderTimeline() {
  const list = document.getElementById("timelineList");
  list.innerHTML = "";

  timeline.forEach(ev => {
    const div = document.createElement("div");
    div.className = "timelineItem";
    div.textContent = `${ev.time} â€” ${ev.text}`;
    list.appendChild(div);
  });
}


// -------------------------------------------
// PRINT EM PNG
// -------------------------------------------
function printScreen() {

  const title = `${document.getElementById("teamA").value} vs ${document.getElementById("teamB").value}`;

  const tableHTML = document.querySelector(".summary").outerHTML;

  const w = window.open("", "", "width=900,height=700");
  w.document.write(`
    <html><head><title>${title}</title></head>
    <body>
      <h2 style="text-align:center;">${title}</h2>
      ${tableHTML}
    </body></html>
  `);

  w.document.close();
  w.print();
}


// -------------------------------------------
// EDITAR NOMES DOS JOGADORES
// -------------------------------------------
document.getElementById("editNamesBtn").onclick = () => {

  const newNames = prompt(
    "Introduz os nomes separados por vÃ­rgulas (ex: JoÃ£o,Marco,Duarte,...):",
    players.map(p => p.name).join(",")
  );

  if (!newNames) return;

  const arr = newNames.split(",").map(x => x.trim());

  arr.forEach((n, i) => {
    if (players[i]) players[i].name = n;
  });

  createPlayers(players.length);
  updateSummary();
  saveData();
};


// -------------------------------------------
// GUARDAR / CARREGAR
// -------------------------------------------
function saveData() {

  const data = {
    players,
    remaining,
    scoreA,
    scoreB,
    firstHalf,
    timeline,
    teamA: document.getElementById("teamA").value,
    teamB: document.getElementById("teamB").value,
    theme
  };

  localStorage.setItem("gameControlData", JSON.stringify(data));
}

function loadData() {

  const data = JSON.parse(localStorage.getItem("gameControlData") || "null");
  if (!data) return createPlayers();

  players = data.players || [];
  remaining = data.remaining || duration;
  scoreA = data.scoreA || 0;
  scoreB = data.scoreB || 0;
  firstHalf = data.firstHalf ?? true;
  timeline = data.timeline || [];

  document.getElementById("teamA").value = data.teamA || "";
  document.getElementById("teamB").value = data.teamB || "";

  document.getElementById("scoreA").textContent = scoreA;
  document.getElementById("scoreB").textContent = scoreB;

  createPlayers(players.length);
  renderTimeline();
  updateSummary();
  updateTimerDisplay();

  if (data.theme === "light") toggleTheme(false);
}


// -------------------------------------------
// TEMA
// -------------------------------------------
function toggleTheme(save = true) {
  const body = document.body;
  const btn = document.getElementById("themeToggle");

  if (body.classList.contains("light-mode")) {
    body.classList.remove("light-mode");
    btn.textContent = "ðŸŒ™";
    theme = "dark";
  } else {
    body.classList.add("light-mode");
    btn.textContent = "ðŸŒž";
    theme = "light";
  }

  if (save) saveData();
}


// -------------------------------------------
// FULLSCREEN (pseudo em mobile)
// -------------------------------------------
document.getElementById("fullscreenBtn").onclick = () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};


// -------------------------------------------
// GOLOS / EVENTOS
// -------------------------------------------
document.getElementById("goloA").onclick = () => {
  scoreA++;
  document.getElementById("scoreA").textContent = scoreA;
  addTimelineEvent("golo", "Golo â€” " + document.getElementById("teamA").value);
};

document.getElementById("goloB").onclick = () => {
  scoreB++;
  document.getElementById("scoreB").textContent = scoreB;
  addTimelineEvent("golo", "Golo â€” " + document.getElementById("teamB").value);
};

document.getElementById("faltaBtn").onclick = () => {
  addTimelineEvent("falta", "Falta");
};

document.getElementById("amareloBtn").onclick = () => {
  addTimelineEvent("amarelo", "CartÃ£o Amarelo");
};

document.getElementById("vermelhoBtn").onclick = () => {
  addTimelineEvent("vermelho", "CartÃ£o Vermelho");
};


// -------------------------------------------
// TIMELINE EXPANDIR
// -------------------------------------------
document.getElementById("toggleTimeline").onclick = () => {
  const det = document.getElementById("timelineDetails");
  if (det.style.maxHeight && det.style.maxHeight !== "0px") {
    det.style.maxHeight = "0px";
    document.getElementById("toggleTimeline").textContent = "â–¼";
  } else {
    det.style.maxHeight = "300px";
    document.getElementById("toggleTimeline").textContent = "â–²";
  }
};


// -------------------------------------------
// SCORE CLIQUE LONGO PARA EDITAR
// -------------------------------------------
document.getElementById("scoreA").onclick = () => {
  const v = prompt("Alterar golos A:", scoreA);
  if (v !== null) scoreA = parseInt(v) || 0;
  document.getElementById("scoreA").textContent = scoreA;
  saveData();
};

document.getElementById("scoreB").onclick = () => {
  const v = prompt("Alterar golos B:", scoreB);
  if (v !== null) scoreB = parseInt(v) || 0;
  document.getElementById("scoreB").textContent = scoreB;
  saveData();
};


// -------------------------------------------
// INICIAR BOTÃ•ES
// -------------------------------------------
document.getElementById("startBtn").onclick = startTimer;
document.getElementById("pauseBtn").onclick = pauseTimer;
document.getElementById("resetBtn").onclick = resetTimer;
document.getElementById("intervalBtn").onclick = intervalTimer;
document.getElementById("printBtn").onclick = printScreen;

document.getElementById("addBtn").onclick = () => {
  createPlayers(players.length + 1);
  saveData();
};

document.getElementById("removeBtn").onclick = () => {
  if (players.length > 1) {
    createPlayers(players.length - 1);
    saveData();
  }
};


// -------------------------------------------
// LOAD & AUTOSAVE
// -------------------------------------------
window.onload = loadData;
setInterval(() => { if (running) saveData(); }, 2000);

</script>

<!-- PWA SW REGISTRATION -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>

</body>
</html>
