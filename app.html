<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game Control</title>

<style>
  :root {
    --timeline-h: 54px;

    /* Paleta alinhada com a landing */
    --bg: #0d0d0d;
    --bg-elevated: #151515;
    --bg-elevated-soft: #1c1c1c;
    --border-soft: #2a2a2a;
    --border-strong: #3a3a3a;

    --accent-green: #40c463;
    --accent-green-soft: #2ecc71;
    --accent-red: #e74c3c;
    --accent-yellow: #f1c40f;
    --accent-blue: #4da3ff;

    --text-main: #f5f5f5;
    --text-soft: #cfcfcf;
  }

  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    margin:0;
    background:var(--bg);
    color:var(--text-main);
    text-align:center;
    padding-bottom: calc(var(--timeline-h) + 10px);
  }
  body.light-mode{
    background:#f5f5f5;
    color:#222;
  }

  /* HEADER */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:var(--bg-elevated);
    padding:10px 16px;
    box-sizing:border-box;
    border-bottom:1px solid var(--border-soft);
  }
  body.light-mode header{
    background:#f0f0f0;
    color:#111;
    border-bottom:1px solid #d0d0d0;
  }

  .header-left{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .header-logo{
    height:38px;
    width:auto;
    display:block;
  }

  .header-title{
    font-size:18px;
    font-weight:700;
    letter-spacing:.08em;
  }

  .top-buttons{
    display:flex;
    gap:8px;
  }
  .top-buttons button{
    background:transparent;
    border:1px solid rgba(255,255,255,0.14);
    border-radius:999px;
    font-size:18px;
    padding:5px 9px;
    color:var(--text-main);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:background 0.15s, border-color 0.15s, transform 0.05s;
  }
  .top-buttons button:hover{
    background:rgba(255,255,255,0.08);
    border-color:rgba(255,255,255,0.3);
  }
  .top-buttons button:active{
    transform:scale(0.95);
  }
  body.light-mode .top-buttons button{
    color:#222;
    border-color:rgba(0,0,0,0.12);
  }

  /* BOT√ÉO FLUTUANTE PLAY/PAUSE */
  #floatingPlayBtn{
    position:fixed;
    top:70px;
    right:16px;
    width:70px;
    height:70px;
    border-radius:50%;
    border:none;
    font-size:30px;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:1200;
    box-shadow:0 10px 28px rgba(0,0,0,0.6);
    transition:background 0.2s, box-shadow 0.2s, transform 0.08s;
  }
  #floatingPlayBtn.running{
    background:var(--accent-red);
    color:#fff;
    box-shadow:0 0 18px rgba(231,76,60,0.85);
  }
  #floatingPlayBtn.paused{
    background:var(--accent-green);
    color:#000;
    box-shadow:0 0 18px rgba(64,196,99,0.85);
  }
  #floatingPlayBtn:active{
    transform:scale(0.96);
  }

  /* EQUIPAS / RESULTADO */
  #teamInputs{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    margin:12px;
  }
  #teamInputs input{
    padding:7px 12px;
    border-radius:999px;
    border:1px solid var(--border-soft);
    font-size:15px;
    text-align:center;
    background:var(--bg-elevated-soft);
    color:var(--text-main);
    min-width:130px;
  }
  body.light-mode #teamInputs input{
    background:#ffffff;
    border-color:#cccccc;
    color:#111;
  }

  .scoreBubble{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:38px;
    height:38px;
    padding:0 10px;
    margin:0 4px;
    border-radius:999px;
    background:var(--bg-elevated-soft);
    border:1px solid var(--border-soft);
    color:var(--text-main);
    font-weight:800;
    font-size:20px;
  }
  body.light-mode .scoreBubble{
    background:#ffffff;
    border-color:#d0d0d0;
    color:#111;
  }

  /* TIMER + PARTE */
  .timer-row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin:6px 0 6px 0;
  }
  #timer{
    font-size:3.1em;
    letter-spacing:0.05em;
  }
  .half-badge{
    display:inline-block;
    padding:5px 14px;
    border-radius:999px;
    background:var(--bg-elevated-soft);
    border:1px solid var(--border-soft);
    color:var(--text-soft);
    font-size:12px;
    letter-spacing:.25em;
    text-transform:uppercase;
  }
  body.light-mode .half-badge{
    background:#e4e4e4;
    border-color:#cccccc;
    color:#111;
  }

  /* CONTROLOS DE TEMPO / JOGADORES */
  .controls{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:8px;
    background:var(--bg-elevated);
    padding:10px 12px;
    border-top:1px solid var(--border-soft);
    border-bottom:1px solid var(--border-soft);
  }
  body.light-mode .controls{
    background:#ececec;
    border-color:#d0d0d0;
  }
  .controls button{
    padding:7px 12px;
    border:none;
    border-radius:999px;
    background:var(--bg-elevated-soft);
    border:1px solid var(--border-soft);
    color:var(--text-main);
    cursor:pointer;
    font-size:13px;
    font-weight:500;
    letter-spacing:.04em;
    text-transform:uppercase;
    transition:background 0.15s, border-color 0.15s, transform 0.05s;
  }
  .controls button:hover{
    background:#222;
    border-color:#444;
  }
  .controls button:active{
    transform:scale(0.97);
  }

  /* Destaque Intervalo / Reset */
  #intervalBtn,
  #resetBtn{
    padding:8px 18px;
    font-size:13px;
    font-weight:600;
  }
  #intervalBtn{
    background:var(--accent-yellow);
    color:#111;
    border-color:#c8a70b;
  }
  #intervalBtn:hover{
    filter:brightness(1.02);
  }
  #resetBtn{
    background:var(--accent-red);
    color:#fff;
    border-color:#b13b2e;
  }
  #resetBtn:hover{
    filter:brightness(1.02);
  }

  body.light-mode .controls button{
    background:#f6f6f6;
    border-color:#cccccc;
    color:#222;
  }

  .controls input{
    padding:6px 8px;
    border-radius:999px;
    border:1px solid var(--border-soft);
    text-align:center;
    background:var(--bg-elevated-soft);
    color:var(--text-main);
    width:60px;
    font-size:13px;
  }
  body.light-mode .controls input{
    background:#ffffff;
    border-color:#cccccc;
    color:#111;
  }

  /* GRELHA DOS JOGADORES */
  #players{
    display:grid;
    grid-template-columns:repeat(5,minmax(0,1fr));
    gap:10px;
    width:100%;
    margin:10px 0 18px 0;
    padding:0 10px;
    box-sizing:border-box;
    justify-items:center;
  }
  @media (max-width:1200px){
    #players{grid-template-columns:repeat(4,minmax(0,1fr));}
  }
  @media (max-width:900px){
    #players{grid-template-columns:repeat(3,minmax(0,1fr));}
  }
  @media (max-width:600px){
    #players{grid-template-columns:repeat(2,minmax(0,1fr));}
  }

  .player{
    width:100%;
    height:104px;
    border-radius:14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:0.18s;
    background:#141414;
    color:var(--text-main);
    position:relative;
    overflow:hidden;
    box-sizing:border-box;
    border:1px solid var(--border-soft);
    box-shadow:0 8px 20px rgba(0,0,0,0.45);
  }
  .player.active{
    background:linear-gradient(135deg,#151b15,#111);
    border-color:var(--accent-green-soft);
    box-shadow:0 0 0 1px rgba(46,204,113,0.35), 0 10px 26px rgba(0,0,0,0.6);
  }
  .player.inactive{
    background:linear-gradient(135deg,#1b1313,#111);
    border-color:rgba(231,76,60,0.7);
    box-shadow:0 0 0 1px rgba(231,76,60,0.25), 0 8px 20px rgba(0,0,0,0.55);
  }

  .player strong{
    font-size:12px;
    margin-bottom:3px;
    padding:0 3px;
  }
  .player .time{
    font-size:20px;
    font-weight:700;
    line-height:1;
  }
  .player .last{
    font-size:9px;
    opacity:.85;
    margin-top:2px;
  }

  .gk-icon{
    position:absolute;
    top:6px;
    left:6px;
    width:22px;
    height:22px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.55);
    font-size:13px;
    border:1px solid rgba(255,255,255,0.25);
  }

  .fatigue-container{
    position:absolute;
    left:8px;
    right:8px;
    bottom:7px;
    height:5px;
    border-radius:999px;
    background:rgba(255,255,255,0.12);
    overflow:hidden;
  }
  .fatigue-bar{
    height:100%;
    width:0%;
    border-radius:999px;
    background:var(--accent-green-soft);
    transition:width 0.2s linear, background 0.2s linear;
  }

  .player.limit{
    outline:3px solid rgba(255,77,77,0.9);
    box-shadow:0 0 0 3px rgba(255,77,77,0.45);
  }

  /* RESUMO */
  .summary{
    width:90%;
    max-width:1100px;
    margin:10px auto 30px auto;
    padding:0;
    background:var(--bg-elevated);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.65);
    overflow:hidden;
    border:1px solid var(--border-soft);
  }
  body.light-mode .summary{
    background:#ffffff;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
    border-color:#d0d0d0;
  }
  .summary h3{
    margin:0;
    padding:12px 16px;
    background:var(--bg-elevated-soft);
    border-bottom:1px solid var(--border-soft);
    text-align:left;
    font-size:15px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  body.light-mode .summary h3{
    background:#f0f0f0;
    border-bottom:1px solid #cccccc;
    color:#111;
  }
  .summary table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    font-size:13px;
  }
  .summary thead th{
    position:sticky;
    top:0;
    background:#232323;
    z-index:1;
    text-transform:uppercase;
    font-size:11px;
    letter-spacing:.3px;
    color:#dddddd;
    border-bottom:1px solid var(--border-soft);
    padding:9px 10px;
  }
  body.light-mode .summary thead th{
    background:#f5f5f5;
    color:#222;
    border-bottom:1px solid #dddddd;
  }
  .summary tbody td{
    padding:8px 10px;
    border-bottom:1px solid #2a2a2a;
  }
  body.light-mode .summary tbody td{
    border-bottom:1px solid #e0e0e0;
  }
  .summary tbody tr:nth-child(even){
    background:rgba(255,255,255,0.03);
  }
  body.light-mode .summary tbody tr:nth-child(even){
    background:#fafafa;
  }
  .summary tbody tr:hover{
    background:rgba(255,255,255,0.06);
  }
  body.light-mode .summary tbody tr:hover{
    background:#f2f2f2;
  }
  .summary td:nth-child(1){
    text-align:left;
    font-weight:600;
  }

  .pill{
    display:inline-block;
    padding:3px 9px;
    border-radius:999px;
    font-weight:700;
    font-size:11px;
  }
  .pill.work-pos{
    color:var(--accent-green-soft);
    background:rgba(46,204,113,.12);
    border:1px solid rgba(46,204,113,.4);
  }
  .pill.work-neg{
    color:var(--accent-red);
    background:rgba(231,76,60,.12);
    border:1px solid rgba(231,76,60,.4);
  }

  /* BADGES NO CART√ÉO DO JOGADOR */
  .card-badges{
    position:absolute;
    top:6px;
    right:6px;
    display:flex;
    gap:4px;
    align-items:center;
  }
  .badge-fouls{
    min-width:16px;
    height:17px;
    border-radius:999px;
    background:#222;
    color:#fff;
    font-size:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 5px;
    border:1px solid rgba(255,255,255,0.18);
  }
  .badge-yc, .badge-rc, .badge-goal, .badge-assist{
    border-radius:3px;
    border:1px solid rgba(0,0,0,.5);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    padding:0 5px;
    height:16px;
    line-height:1;
    white-space:nowrap;
  }
  .badge-yc{
    background:#f1c40f;
    color:#000;
    padding:0 3px;
    min-width:10px;
  }
  .badge-rc{
    background:#e74c3c;
    color:#fff;
    padding:0 3px;
    min-width:10px;
  }
  .badge-goal{
    background:var(--accent-green-soft);
    color:#000;
  }
  .badge-assist{
    background:var(--accent-blue);
    color:#fff;
  }

  /* Painel editar nomes */
  #editPanel{
    position:fixed;
    right:-420px;
    top:20%;
    width:380px;
    height:60%;
    background:rgba(10,10,10,0.97);
    border-left:1px solid var(--border-soft);
    border-radius:14px 0 0 14px;
    padding:15px;
    box-shadow:-10px 0 26px rgba(0,0,0,.7);
    transition:right .2s;
    z-index:999;
    overflow-y:auto;
  }
  #editPanel.open{ right:0; }
  #editPanel .close-btn{
    position:absolute;
    top:6px;
    right:8px;
    background:transparent;
    border:none;
    color:#fff;
    font-size:18px;
    cursor:pointer;
  }
  #editPanel h3{
    margin:0 0 10px 0;
    font-size:15px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  #editPanel .row{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
  }
  #editPanel .row span{
    width:24px;
    text-align:right;
    color:#ccc;
    font-size:13px;
  }
  #editPanel .row input[type="text"]{
    flex:1;
    padding:6px;
    border-radius:6px;
    border:1px solid #555;
    background:#1f1f1f;
    color:#fff;
    font-size:13px;
  }
  #editPanel .row label{
    display:flex;
    align-items:center;
    gap:4px;
    color:#ddd;
    font-size:13px;
  }
  #editPanel .save-btn{
    width:100%;
    padding:8px;
    border:none;
    border-radius:999px;
    background:var(--accent-blue);
    color:#fff;
    cursor:pointer;
    margin-top:8px;
    font-weight:600;
    letter-spacing:.05em;
    text-transform:uppercase;
  }

  /* Painel Presets */
  #presetsPanel{
    position:fixed;
    right:-420px;
    top:10%;
    width:380px;
    height:80%;
    background:rgba(10,10,10,0.97);
    border-left:1px solid var(--border-soft);
    border-radius:14px 0 0 14px;
    padding:15px;
    box-shadow:-10px 0 26px rgba(0,0,0,.7);
    transition:right .2s;
    z-index:999;
    overflow-y:auto;
  }
  #presetsPanel.open{ right:0; }
  #presetsPanel .close-btn{
    position:absolute;
    top:6px;
    right:8px;
    background:transparent;
    border:none;
    color:#fff;
    font-size:18px;
    cursor:pointer;
  }

  /* Painel Gest√£o de Cargas */
  #loadPanel{
    position:fixed;
    left:-420px;
    top:10%;
    width:380px;
    height:80%;
    background:rgba(10,10,10,0.97);
    border-right:1px solid var(--border-soft);
    border-radius:0 14px 14px 0;
    padding:15px;
    box-shadow:10px 0 26px rgba(0,0,0,.7);
    transition:left .2s;
    z-index:999;
    overflow-y:auto;
  }
  #loadPanel.open{ left:0; }
  #loadPanel .close-btn{
    position:absolute;
    top:6px;
    right:8px;
    background:transparent;
    border:none;
    color:#fff;
    font-size:18px;
    cursor:pointer;
  }
  #loadPanel h3{
    margin:0 0 10px 0;
    font-size:15px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  .load-row{
    display:flex;
    flex-direction:column;
    padding:6px 8px;
    border-radius:10px;
    margin-bottom:6px;
    background:#151515;
    border:1px solid #3a3a3a;
    text-align:left;
    font-size:13px;
  }
  .load-row strong{
    font-size:13px;
  }
  .load-meta{
    display:flex;
    justify-content:space-between;
    margin-top:2px;
    font-size:12px;
  }
  .load-tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:600;
  }
  .load-pos{
    background:rgba(46,204,113,.15);
    color:var(--accent-green-soft);
    border:1px solid rgba(46,204,113,.6);
  }
  .load-neg{
    background:rgba(231,76,60,.15);
    color:var(--accent-red);
    border:1px solid rgba(231,76,60,.6);
  }
  .fat-low{
    color:var(--accent-green-soft);
  }
  .fat-mid{
    color:var(--accent-yellow);
  }
  .fat-high{
    color:var(--accent-red);
  }

  /* Timeline fixa em baixo */
  #timelineBar{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    height:var(--timeline-h);
    background:rgba(10,10,10,0.98);
    border-top:1px solid var(--border-soft);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    z-index:900;
    backdrop-filter:blur(10px);
  }
  body.light-mode #timelineBar{
    background:#f0f0f0;
    border-top:1px solid #ccc;
  }
  .tl-btn{
    border:none;
    border-radius:999px;
    padding:6px 11px;
    font-size:13px;
    cursor:pointer;
    background:#222;
    color:#fff;
    display:flex;
    align-items:center;
    gap:5px;
    border:1px solid #3b3b3b;
    transition:background 0.15s, border-color 0.15s, transform 0.05s;
  }
  .tl-btn:hover{
    background:#2b2b2b;
    border-color:#525252;
  }
  .tl-btn:active{
    transform:scale(0.97);
  }
  body.light-mode .tl-btn{
    background:#666;
    color:#fff;
    border-color:#777;
  }
  .tl-btn span.icon{font-size:16px;}
  .tl-btn span.label{font-size:12px;}

  /* Piscar quando estamos a escolher jogador (golo / falta / cart√£o / assist√™ncia) */
  @keyframes selectBlink{
    0%,100%{ outline-color:#fff; opacity:1; }
    50%{ outline-color:transparent; opacity:0.65; }
  }
  .player.selectEvent{
    outline:3px dashed #fff;
    outline-offset:-3px;
    animation:selectBlink 1s infinite;
  }

  /* Assinatura @gpmviana */
  #brandSignature{
    position:fixed;
    bottom:-5px;
    right:12px;
    z-index:9999;
    pointer-events:none;
  }
  #brandSignature img{
    height:65px;
    opacity:0.7;
    display:none;
    user-select:none;
  }
  body:not(.light-mode) #brandSignature .sig-on-dark{
    display:block;
  }
  body.light-mode #brandSignature .sig-on-light{
    display:block;
  }

  /* LOGIN SCREEN */
  #loginScreen{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(circle at top, #333 0, #111 55%);
    z-index:1500;
  }
  #loginCard{
    background:#1f1f1f;
    padding:24px 26px;
    border-radius:14px;
    box-shadow:0 18px 45px rgba(0,0,0,0.65);
    min-width:280px;
    max-width:340px;
    display:flex;
    flex-direction:column;
    gap:10px;
    text-align:left;
    border:1px solid #333;
  }
  #loginTitle{
    font-size:19px;
    font-weight:700;
    margin:0;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  #loginSubtitle{
    font-size:12px;
    color:#ccc;
    margin:0 0 4px 0;
  }
  .login-label{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#bbbbbb;
    margin-top:6px;
  }
  #loginScreen input{
    padding:8px 10px;
    border-radius:6px;
    border:1px solid #444;
    background:#2b2b2b;
    color:#fff;
    width:100%;
    box-sizing:border-box;
    font-size:13px;
  }
  #loginScreen input::placeholder{
    color:#777;
  }
  #loginScreen button{
    margin-top:10px;
    padding:9px 14px;
    border:none;
    border-radius:999px;
    background:var(--accent-blue);
    color:#fff;
    cursor:pointer;
    font-weight:600;
    width:100%;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  #loginScreen button:hover{
    filter:brightness(1.05);
  }
  #loginError{
    color:#ff5555;
    font-size:11px;
    min-height:16px;
  }
  body.light-mode #loginCard{
    background:#ffffff;
    color:#111;
  }
  body.light-mode #loginScreen input{
    background:#f3f3f3;
    border-color:#cccccc;
    color:#111;
  }
  body.light-mode #loginScreen button{
    background:#005ea6;
  }
</style>

<!-- üîê Firebase Auth -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCPiS92A0ZUNaCl4clAkxBbYFQrgJDSiUY",
    authDomain: "gamecontrol-futsal.firebaseapp.com",
    projectId: "gamecontrol-futsal",
    storageBucket: "gamecontrol-futsal.firebasestorage.app",
    messagingSenderId: "717212104958",
    appId: "1:717212104958:web:36fe7465fb405722c30daf",
    measurementId: "G-LQFHN83HQ0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  window.addEventListener("DOMContentLoaded", () => {
    const loginScreen   = document.getElementById("loginScreen");
    const appWrapper    = document.getElementById("appWrapper");
    const loginEmail    = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginBtn      = document.getElementById("loginBtn");
    const loginError    = document.getElementById("loginError");
    const logoutBtn     = document.getElementById("logoutBtn");

    if(loginBtn){
      loginBtn.addEventListener("click", async () => {
        loginError.textContent = "";
        const email = (loginEmail.value || "").trim();
        const pass  = loginPassword.value || "";
        if(!email || !pass){
          loginError.textContent = "Preenche email e password.";
          return;
        }
        try{
          await signInWithEmailAndPassword(auth, email, pass);
        }catch(err){
          console.error(err);
          loginError.textContent = "Login inv√°lido. Verifica os dados.";
        }
      });
    }

    if(logoutBtn){
      logoutBtn.addEventListener("click", async () => {
        try{
          await signOut(auth);
        }catch(err){
          console.error(err);
        }
      });
    }

    onAuthStateChanged(auth, user => {
      const logged = !!user;
      if(logged){
        loginScreen.style.display = "none";
        appWrapper.style.display  = "block";
        if(logoutBtn) logoutBtn.style.display = "inline-flex";
      }else{
        loginScreen.style.display = "flex";
        appWrapper.style.display  = "none";
        if(logoutBtn) logoutBtn.style.display = "none";
      }
    });
  });
</script>
</head>

<body>
<header>
  <div class="header-left">
    <img src="logo-gc.png" alt="Game Control" class="header-logo">
    <span class="header-title">GAME CONTROL</span>
  </div>

  <div class="top-buttons">
    <button id="themeToggle" title="Tema">üåô</button>
    <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
    <button id="loadPanelBtn" title="Gest√£o de Cargas">‚ö°</button>
    <button id="editNamesBtn" title="Editar nomes">üë•</button>
    <button id="presetsBtn" title="Presets">üíæ</button>
    <button id="printBtn" title="Exportar PNG">üì∏</button>
    <button id="logoutBtn" title="Sair" style="display:none;">üö™</button>
  </div>
</header>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginCard">
    <h2 id="loginTitle">Login Game Control</h2>
    <p id="loginSubtitle">Acede ao teu painel de gest√£o de jogo.</p>

    <label class="login-label" for="loginEmail">Email</label>
    <input id="loginEmail" type="email" placeholder="exemplo@club.pt" autocomplete="username" />

    <label class="login-label" for="loginPassword">Password</label>
    <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />

    <button id="loginBtn">Entrar</button>
    <p id="loginError"></p>
  </div>
</div>

<!-- APP -->
<div id="appWrapper" style="display:none;">

  <button id="floatingPlayBtn" class="paused" title="Iniciar / Pausar">‚èµ</button>

  <div id="teamInputs">
    <span class="scoreBubble" id="scoreA">0</span>
    <input id="teamA" placeholder="Equipa A" />
    <span style="font-weight:bold;">vs</span>
    <input id="teamB" placeholder="Equipa B" />
    <span class="scoreBubble" id="scoreB">0</span>
  </div>

  <div class="timer-row">
    <div id="timer">20:00</div>
    <span id="halfBadge" class="half-badge">1¬™ Parte</span>
  </div>

  <div class="controls">
    <input id="setMinutes" type="number" value="20" min="1">
    <button id="intervalBtn">Intervalo</button>
    <button id="resetBtn">Reset</button>
    <button id="addBtn">+</button>
    <button id="removeBtn">‚àí</button>
  </div>

  <div id="players"></div>

  <div class="summary" id="summaryCard">
    <h3>Resumo de Jogo</h3>
    <table>
      <thead>
        <tr>
          <th>Jogador</th>
          <th>1¬™ Parte</th>
          <th>2¬™ Parte</th>
          <th>Total em Campo</th>
          <th>Tempo Fora</th>
          <th>Rota√ß√µes</th>
          <th>M√©dia</th>
          <th>% Jogo</th>
          <th>Workload</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <!-- Painel Editar nomes -->
  <div id="editPanel">
    <button class="close-btn" id="closePanel">‚ùå</button>
    <h3>Editar Jogadores</h3>
    <div id="editList"></div>
    <button class="save-btn" id="saveNamesBtn">Guardar Altera√ß√µes</button>
  </div>

  <!-- Painel Presets -->
  <div id="presetsPanel">
    <button class="close-btn" id="closePresets">‚ùå</button>
    <h3 style="margin:0 0 10px 0;">Presets de Plantel</h3>
    <div style="display:flex; gap:6px; margin-bottom:8px;">
      <input id="presetName" placeholder="Nome do preset" style="flex:1;padding:6px;border-radius:6px;border:1px solid #777;background:#1f1f1f;color:#fff"/>
      <button id="savePresetBtn" style="padding:6px 10px;border:none;border-radius:6px;background:#0078d7;color:#fff;cursor:pointer">Guardar</button>
    </div>
    <div>
      <h4 style="margin:10px 0 6px 0;">Carregar</h4>
      <div id="presetList"></div>
    </div>
  </div>

  <!-- Painel Gest√£o de Cargas -->
  <div id="loadPanel">
    <button class="close-btn" id="closeLoad">‚ùå</button>
    <h3>Gest√£o de Cargas</h3>
    <p style="font-size:12px;color:#ccc;margin:0 0 8px 0;">
      Workload = tempo em campo ‚àí tempo ideal (se todos jogassem igual).
    </p>
    <div id="loadList"></div>
  </div>

  <!-- Assinatura -->
  <div id="brandSignature">
    <img src="signature-light.png" class="sig-on-dark" alt="@gpmviana">
    <img src="signature-dark.png" class="sig-on-light" alt="@gpmviana">
  </div>

  <!-- Timeline -->
  <div id="timelineBar">
    <button class="tl-btn" data-type="GF_A">
      <span class="icon">‚öΩ</span><span class="label">Golo +</span>
    </button>
    <button class="tl-btn" data-type="GA_A">
      <span class="icon">‚öΩ</span><span class="label">Golo ‚àí</span>
    </button>
    <button class="tl-btn tl-player" data-type="FK_P">
      <span class="icon">‚ùå</span><span class="label">Falta</span>
    </button>
    <button class="tl-btn tl-player" data-type="YC_P">
      <span class="icon">üü®</span><span class="label">Amarelo</span>
    </button>
    <button class="tl-btn tl-player" data-type="RC_P">
      <span class="icon">üü•</span><span class="label">Vermelho</span>
    </button>
    <button class="tl-btn" id="tlClearBtn">
      <span class="icon">üßπ</span><span class="label">Limpar</span>
    </button>
  </div>

</div> <!-- fim appWrapper -->

<script>
let duration = 20 * 60;
let remaining = duration;
let timerInterval = null;
let running = false;
let firstHalf = true;

let players = [];
let theme = "dark";
const maxOnField = 5;
let scoreA = 0;
let scoreB = 0;
let pendingPlayerEvent = null;
let pendingAssistForGoal = null;
let pendingGoalScorer = null;

let timeline = [];

const STORAGE_KEY = "gameControl_withWorkloadGestao_v2";
const PRESETS_KEY = "gc_presets_v1";

const floatingPlayBtn = document.getElementById("floatingPlayBtn");

function pad(n){return String(n).padStart(2,"0");}
function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${pad(m)}:${pad(s)}`;
}

function updateTimerDisplay(){
  document.getElementById("timer").textContent = formatTime(remaining);
}
function updateHalfBadge(){
  document.getElementById("halfBadge").textContent = firstHalf ? "1¬™ Parte" : "2¬™ Parte";
}
function updateScoreUI(){
  document.getElementById("scoreA").textContent = scoreA;
  document.getElementById("scoreB").textContent = scoreB;
}

function updateFloatingPlayBtn(){
  if(!floatingPlayBtn) return;
  if(running){
    floatingPlayBtn.classList.remove("paused");
    floatingPlayBtn.classList.add("running");
    floatingPlayBtn.textContent = "‚è∏";
  }else{
    floatingPlayBtn.classList.remove("running");
    floatingPlayBtn.classList.add("paused");
    floatingPlayBtn.textContent = "‚èµ";
  }
}

function tick(){
  if(remaining <= 0){
    pauseTimer();
    return;
  }
  remaining--;
  players.forEach(p=>{
    if(p.active){
      p.seconds++;
      p.rotationSecondsCurrent++;
      if(firstHalf) p.part1++;
      else p.part2++;
      if(!p.isGK){
        p.fatigue += 0.01 * (1 - p.fatigue);
      }
    }else{
      p.secondsOut++;
      p.rotationSecondsOut++;
      if(!p.isGK){
        p.fatigue -= 0.02 * p.fatigue;
      }
    }
    if(!p.isGK){
      if(p.fatigue < 0) p.fatigue = 0;
      if(p.fatigue > 1) p.fatigue = 1;
    }
  });
  updateTimerDisplay();
  updatePlayersUI();
  updateSummary();
  saveData();
}

function startTimer(){
  if(running) return;
  running = true;
  clearInterval(timerInterval);
  timerInterval = setInterval(tick,1000);
  updateFloatingPlayBtn();
}

function pauseTimer(){
  running = false;
  clearInterval(timerInterval);
  updateFloatingPlayBtn();
  saveData();
}

function resetTimer(){
  pauseTimer();
  const mins = parseInt(document.getElementById("setMinutes").value)||20;
  duration = mins * 60;
  remaining = duration;
  firstHalf = true;
  scoreA = 0;
  scoreB = 0;
  timeline = [];
  pendingAssistForGoal = null;
  pendingGoalScorer = null;
  pendingPlayerEvent = null;
  players.forEach(p=>{
    p.seconds = 0;
    p.secondsOut = 0;
    p.part1 = 0;
    p.part2 = 0;
    p.rotations = 0;
    p.rotationSecondsCurrent = 0;
    p.rotationSecondsOut = 0;
    p.lastRotation = 0;
    if(!p.isGK) p.fatigue = 0;
    p.active = false;
    p.fouls = 0;
    p.yc = false;
    p.rc = false;
    p.goals = 0;
    p.assists = 0;
  });
  updateTimerDisplay();
  updateHalfBadge();
  updatePlayersUI();
  updateSummary();
  updateScoreUI();
  updateFloatingPlayBtn();
  saveData();
}

function intervalTimer(){
  pauseTimer();
  firstHalf = false;
  pendingAssistForGoal = null;
  pendingGoalScorer = null;
  pendingPlayerEvent = null;
  const mins = parseInt(document.getElementById("setMinutes").value)||20;
  duration = mins * 60;
  remaining = duration;
  players.forEach(p=>{
    p.rotationSecondsCurrent = 0;
    p.rotationSecondsOut = 0;
    if(!p.isGK){
      p.fatigue *= 0.3;
    }
  });
  updateTimerDisplay();
  updateHalfBadge();
  updatePlayersUI();
  updateSummary();
  saveData();
}

function fatigueColor(f){
  if(f >= 0.7) return "#e74c3c";
  if(f >= 0.4) return "#f1c40f";
  return "#2ecc71";
}

function buildPlayersDOM(){
  const container = document.getElementById("players");
  container.innerHTML = "";
  players.forEach(p=>{
    const div = document.createElement("div");
    div.id = "player"+p.id;
    div.className = "player " + (p.active ? "active" : "inactive");
    const foulsHTML = p.fouls>0 ? `<span class="badge-fouls" title="Faltas">${p.fouls}</span>` : "";
    const ycHTML = p.yc ? `<span class="badge-yc" title="Amarelo"></span>` : "";
    const rcHTML = p.rc ? `<span class="badge-rc" title="Vermelho"></span>` : "";
    const goalHTML = p.goals>0 ? `<span class="badge-goal" title="Golos">‚öΩ${p.goals>1 ? "√ó"+p.goals : ""}</span>` : "";
    const assistHTML = p.assists>0 ? `<span class="badge-assist" title="Assist√™ncias">üë£${p.assists>1 ? "√ó"+p.assists : ""}</span>` : "";
    div.innerHTML = `
      <div class="gk-icon" style="display:${p.isGK?"flex":"none"}">üß§</div>
      <div class="card-badges">${foulsHTML}${ycHTML}${rcHTML}${goalHTML}${assistHTML}</div>
      <strong class="name">${p.name}</strong>
      <div class="time">00:00</div>
      <div class="last"></div>
      ${p.isGK ? "" : `<div class="fatigue-container"><div class="fatigue-bar" id="fatigue${p.id}"></div></div>`}
    `;
    div.onclick = ()=>togglePlayer(p.id);
    container.appendChild(div);
  });
  updatePlayersUI();
}

function updatePlayersUI(){
  players.forEach(p=>{
    const el = document.getElementById("player"+p.id);
    if(!el) return;
    const selecting = pendingPlayerEvent || pendingAssistForGoal || pendingGoalScorer;
    el.className = "player " + (p.active ? "active" : "inactive") + (selecting ? " selectEvent" : "");
    const timeEl = el.querySelector(".time");
    const lastEl = el.querySelector(".last");
    const nameEl = el.querySelector(".name");
    if(nameEl) nameEl.textContent = p.name;
    const displaySec = p.active ? p.rotationSecondsCurrent : p.rotationSecondsOut;
    timeEl.textContent = formatTime(displaySec);
    lastEl.textContent = (!p.active && p.lastRotation>0) ? ("√ölt. rota√ß√£o: " + formatTime(p.lastRotation)) : "";
    if(!p.isGK){
      const fb = document.getElementById("fatigue"+p.id);
      if(fb){
        fb.style.width = Math.round(p.fatigue*100) + "%";
        fb.style.background = fatigueColor(p.fatigue);
      }
    }
    const badges = el.querySelector(".card-badges");
    if(badges){
      badges.innerHTML =
        (p.fouls>0 ? `<span class="badge-fouls" title="Faltas">${p.fouls}</span>` : "") +
        (p.yc ? `<span class="badge-yc" title="Amarelo"></span>` : "") +
        (p.rc ? `<span class="badge-rc" title="Vermelho"></span>` : "") +
        (p.goals>0 ? `<span class="badge-goal" title="Golos">‚öΩ${p.goals>1 ? "√ó"+p.goals : ""}</span>` : "") +
        (p.assists>0 ? `<span class="badge-assist" title="Assist√™ncias">üë£${p.assists>1 ? "√ó"+p.assists : ""}</span>` : "");
    }
  });
}

function ensurePlayerCount(n){
  const old = players || [];
  players = [];
  for(let i=1;i<=n;i++){
    const prev = old[i-1];
    players.push({
      id:i,
      name: prev ? prev.name : ("Jogador "+i),
      active: prev ? !!prev.active : false,
      isGK: prev ? !!prev.isGK : (i===1),
      seconds: prev ? (prev.seconds||0) : 0,
      secondsOut: prev ? (prev.secondsOut||0) : 0,
      part1: prev ? (prev.part1||0) : 0,
      part2: prev ? (prev.part2||0) : 0,
      rotations: prev ? (prev.rotations||0) : 0,
      rotationSecondsCurrent: prev ? (prev.rotationSecondsCurrent||0) : 0,
      rotationSecondsOut: prev ? (prev.rotationSecondsOut||0) : 0,
      lastRotation: prev ? (prev.lastRotation||0) : 0,
      fatigue: prev && !prev.isGK ? (prev.fatigue||0) : 0,
      fouls: prev ? (prev.fouls||0) : 0,
      yc: prev ? !!prev.yc : false,
      rc: prev ? !!prev.rc : false,
      goals: prev ? (prev.goals||0) : 0,
      assists: prev ? (prev.assists||0) : 0
    });
  }
  buildPlayersDOM();
  updateSummary();
  saveData();
}

function activeCount(){
  return players.reduce((a,p)=>a+(p.active?1:0),0);
}

function flashLimit(id){
  const el = document.getElementById("player"+id);
  if(!el) return;
  el.classList.add("limit");
  setTimeout(()=>el.classList.remove("limit"),600);
}

function addTimelineEvent(ev){
  timeline.push(ev);
}

function addPlayerEvent(type, playerId){
  const p = players.find(x=>x.id===playerId);
  if(!p) return;

  if(type==="FK_P") p.fouls = (p.fouls||0) + 1;
  if(type==="YC_P") p.yc = true;
  if(type==="RC_P") p.rc = true;

  const half = firstHalf ? 1 : 2;
  const clock = formatTime(remaining);
  addTimelineEvent({
    type,
    half,
    clock,
    playerId,
    ts: Date.now()
  });

  updatePlayersUI();
  updateSummary();
  saveData();
}

/* Fluxo Golo + (marcador ‚Üí assist√™ncia opcional) */
function startGoalFlow(){
  pendingPlayerEvent = null;
  pendingAssistForGoal = null;
  pendingGoalScorer = {
    type: "GF_A",
    half: firstHalf ? 1 : 2,
    clock: formatTime(remaining),
    activeIds: players.filter(p=>p.active).map(p=>p.id),
    ts: Date.now()
  };
  updatePlayersUI();
}

function togglePlayer(id){
  // 1) Escolher marcador de golo
  if(pendingGoalScorer){
    const ev = pendingGoalScorer;
    const scorer = players.find(x=>x.id===id);
    if(scorer){
      scorer.goals = (scorer.goals||0)+1;
      ev.playerId = id;
      ev.description = `Golo: ${scorer.name}`;
    }
    scoreA++;
    addTimelineEvent(ev);
    pendingGoalScorer = null;

    // Agora escolhemos assist√™ncia (opcional)
    pendingAssistForGoal = ev;
    updateScoreUI();
    updatePlayersUI();
    updateSummary();
    saveData();
    return;
  }

  // 2) Escolher assist√™ncia
  if(pendingAssistForGoal){
    const ev = pendingAssistForGoal;
    const scorerId = ev.playerId;

    // Se clicar outra vez no marcador ‚Üí sem assist√™ncia
    if(id === scorerId){
      pendingAssistForGoal = null;
      updatePlayersUI();
      updateSummary();
      saveData();
      return;
    }

    const pAssist = players.find(x=>x.id===id);
    if(pAssist){
      pAssist.assists = (pAssist.assists||0)+1;
      ev.assistPlayerId = id;
      const scorer = players.find(x=>x.id===ev.playerId);
      ev.description = `Golo: ${scorer?scorer.name:"#"+ev.playerId} (assist√™ncia: ${pAssist.name})`;
    }
    pendingAssistForGoal = null;
    updatePlayersUI();
    updateSummary();
    saveData();
    return;
  }

  // 3) Falta / cart√£o em jogador
  if(pendingPlayerEvent){
    addPlayerEvent(pendingPlayerEvent, id);
    pendingPlayerEvent = null;
    updatePlayersUI();
    return;
  }

  // 4) Troca normal (conta rota√ß√£o quando entra)
  const p = players.find(x=>x.id===id);
  if(!p) return;
  const currently = activeCount();

  if(!p.active && currently >= maxOnField){
    flashLimit(id);
    return;
  }

  if(p.active){
    p.active = false;
    p.lastRotation = p.rotationSecondsCurrent;
    p.rotationSecondsCurrent = 0;
    p.rotationSecondsOut = 0;
  } else {
    p.active = true;
    p.rotations++;
    p.rotationSecondsCurrent = 0;
    p.rotationSecondsOut = 0;
  }

  updatePlayersUI();
  updateSummary();
  saveData();
}

/* Workload inteligente */
function computeGameTime(){
  if(players.length===0) return 0;
  return players.reduce((max,p)=>{
    const t = (p.seconds||0)+(p.secondsOut||0);
    return t>max?t:max;
  },0);
}

function computeIdealPerPlayer(gameTime){
  if(players.length===0) return 0;
  return gameTime * (maxOnField / players.length);
}

function computePlayerWorkload(p, gameTime, idealPerPlayer){
  if(gameTime <= 0) return 0;
  return (p.seconds || 0) - idealPerPlayer;
}

function updateSummary(){
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = "";

  const gameTime = computeGameTime();
  const ideal = computeIdealPerPlayer(gameTime);

  players.forEach(p=>{
    const total = p.part1 + p.part2;
    const avg = p.rotations > 0 ? Math.floor(total / p.rotations) : 0;
    const percent = gameTime>0 ? ((p.seconds / gameTime)*100).toFixed(1) : "0.0";
    const wlSec = computePlayerWorkload(p, gameTime, ideal);
    const wlMin = wlSec / 60;
    const wClass = wlMin >= 0 ? "work-pos" : "work-neg";
    const wTxt = `${wlMin>=0?"+":""}${wlMin.toFixed(1)}m`;

    const extra = [];
    if(p.goals>0) extra.push(`‚öΩ ${p.goals}`);
    if(p.assists>0) extra.push(`üë£ ${p.assists}`);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}${p.isGK?' üß§':''}${extra.length?(" ¬∑ "+extra.join(" ")):''}</td>
      <td>${formatTime(p.part1)}</td>
      <td>${formatTime(p.part2)}</td>
      <td>${formatTime(total)}</td>
      <td>${formatTime(p.secondsOut)}</td>
      <td>${p.rotations}</td>
      <td>${formatTime(avg)}</td>
      <td>${percent}%</td>
      <td><span class="pill ${wClass}">${wTxt}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

/* Tema / fullscreen */
function toggleTheme(){
  document.body.classList.toggle("light-mode");
  theme = document.body.classList.contains("light-mode") ? "light" : "dark";
  document.getElementById("themeToggle").textContent = theme==="dark" ? "üåô" : "üåû";
  saveData();
}
function toggleFullscreen(){
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

/* Painel editar nomes */
const editPanel = document.getElementById("editPanel");
const editList = document.getElementById("editList");

function openEditPanel(){
  editList.innerHTML = "";
  players.forEach(p=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <span>${p.id}.</span>
      <input type="text" id="nameEdit${p.id}" value="${p.name}">
      <label><input type="checkbox" id="gkEdit${p.id}" ${p.isGK?"checked":""}/> üß§ GR</label>
    `;
    editList.appendChild(row);
  });
  editPanel.classList.add("open");
}
function closeEditPanel(){
  editPanel.classList.remove("open");
}
function saveNamesFromPanel(){
  players.forEach(p=>{
    const v = document.getElementById("nameEdit"+p.id).value.trim();
    const gk = document.getElementById("gkEdit"+p.id).checked;
    if(v) p.name = v;
    p.isGK = !!gk;
    if(p.isGK) p.fatigue = 0;
  });
  closeEditPanel();
  buildPlayersDOM();
  updateSummary();
  saveData();
}

/* Painel Gest√£o de Cargas */
const loadPanel = document.getElementById("loadPanel");
const loadList = document.getElementById("loadList");

function openLoadPanel(){
  renderLoadPanel();
  loadPanel.classList.add("open");
}
function closeLoadPanel(){
  loadPanel.classList.remove("open");
}
function renderLoadPanel(){
  loadList.innerHTML = "";
  const gameTime = computeGameTime();
  const ideal = computeIdealPerPlayer(gameTime);

  const sorted = [...players].sort((a,b)=> (b.seconds||0)-(a.seconds||0));

  sorted.forEach(p=>{
    const wlSec = computePlayerWorkload(p, gameTime, ideal);
    const wlMin = wlSec/60;
    const totalSec = (p.seconds||0);
    const fad = p.fatigue || 0;
    let fadClass="fat-low", fadTxt="Fadiga baixa";
    if(fad>=0.7){ fadClass="fat-high"; fadTxt="Fadiga alta"; }
    else if(fad>=0.4){ fadClass="fat-mid"; fadTxt="Fadiga m√©dia"; }

    const div = document.createElement("div");
    div.className = "load-row";
    div.innerHTML = `
      <strong>${p.name}${p.isGK?' üß§':''}</strong>
      <div class="load-meta">
        <span>Em campo: <strong>${formatTime(totalSec)}</strong></span>
        <span class="${fadClass}">${fadTxt}</span>
      </div>
      <div class="load-meta">
        <span>Ideal: ${gameTime>0 ? formatTime(ideal) : "00:00"}</span>
        <span>
          <span class="load-tag ${wlMin>=0?'load-pos':'load-neg'}">
            ${wlMin>=0?"+":""}${wlMin.toFixed(1)}m
          </span>
        </span>
      </div>
    `;
    loadList.appendChild(div);
  });
}

/* Presets */
function getPresets(){
  return JSON.parse(localStorage.getItem(PRESETS_KEY) || "{}");
}
function setPresets(obj){
  localStorage.setItem(PRESETS_KEY, JSON.stringify(obj));
}
function renderPresetList(){
  const list = document.getElementById("presetList");
  const all = getPresets();
  const keys = Object.keys(all);
  if(keys.length===0){
    list.innerHTML = '<div style="color:#ccc">Sem presets.</div>';
    return;
  }
  list.innerHTML = "";
  keys.forEach(name=>{
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "6px";
    row.style.marginBottom = "6px";
    row.innerHTML = `
      <div style="flex:1;background:#1f1f1f;border:1px solid #444;border-radius:6px;padding:6px;color:#fff;">${name}</div>
      <button data-name="${name}" class="btnLoad" style="padding:6px 8px;border:none;border-radius:6px;background:#444;color:#fff;cursor:pointer;font-size:12px">Carregar</button>
      <button data-name="${name}" class="btnDel" style="padding:6px 8px;border:none;border-radius:6px;background:#a33;color:#fff;cursor:pointer;font-size:12px">Apagar</button>
    `;
    list.appendChild(row);
  });
  list.querySelectorAll(".btnLoad").forEach(b=>b.onclick=()=>loadPreset(b.dataset.name));
  list.querySelectorAll(".btnDel").forEach(b=>b.onclick=()=>{
    const all = getPresets();
    delete all[b.dataset.name];
    setPresets(all);
    renderPresetList();
  });
}
function savePreset(){
  const nm = (document.getElementById("presetName").value || "").trim();
  if(!nm){
    alert("D√° um nome ao preset.");
    return;
  }
  const data = {
    size: players.length,
    roster: players.map(p=>({ name: p.name, isGK: !!p.isGK }))
  };
  const all = getPresets();
  all[nm] = data;
  setPresets(all);
  renderPresetList();
  alert("Preset guardado.");
}
function loadPreset(name){
  const all = getPresets();
  const p = all[name];
  if(!p) return;
  ensurePlayerCount(p.size || 14);
  players.forEach((pl,i)=>{
    const src = p.roster[i];
    if(!src) return;
    pl.name = src.name || pl.name;
    pl.isGK = !!src.isGK;
    if(pl.isGK) pl.fatigue = 0;
  });
  buildPlayersDOM();
  updateSummary();
  saveData();
  alert("Preset carregado.");
}

/* Persist√™ncia */
function saveData(){
  const data = {
    teamA: document.getElementById("teamA").value || "",
    teamB: document.getElementById("teamB").value || "",
    duration,
    remaining,
    firstHalf,
    theme,
    players,
    scoreA,
    scoreB,
    timeline
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    players = [];
    for(let i=1;i<=14;i++){
      players.push({
        id:i,
        name:"Jogador "+i,
        active:false,
        isGK:(i===1),
        seconds:0,
        secondsOut:0,
        part1:0,
        part2:0,
        rotations:0,
        rotationSecondsCurrent:0,
        rotationSecondsOut:0,
        lastRotation:0,
        fatigue:0,
        fouls:0,
        yc:false,
        rc:false,
        goals:0,
        assists:0
      });
    }
    buildPlayersDOM();
    updateTimerDisplay();
    updateHalfBadge();
    updateSummary();
    updateScoreUI();
    updateFloatingPlayBtn();
    return;
  }
  try{
    const d = JSON.parse(raw);
    document.getElementById("teamA").value = d.teamA || "";
    document.getElementById("teamB").value = d.teamB || "";
    duration = typeof d.duration==="number" ? d.duration : duration;
    remaining = typeof d.remaining==="number" ? d.remaining : remaining;
    firstHalf = typeof d.firstHalf==="boolean" ? d.firstHalf : true;
    theme = d.theme || "dark";
    scoreA = typeof d.scoreA==="number" ? d.scoreA : 0;
    scoreB = typeof d.scoreB==="number" ? d.scoreB : 0;
    timeline = Array.isArray(d.timeline) ? d.timeline : [];

    players = (Array.isArray(d.players)?d.players:[]).map((p,i)=>({
      id: p.id ?? (i+1),
      name: p.name || ("Jogador "+(p.id ?? (i+1))),
      active: !!p.active,
      isGK: !!p.isGK,
      seconds: p.seconds || 0,
      secondsOut: p.secondsOut || 0,
      part1: p.part1 || 0,
      part2: p.part2 || 0,
      rotations: p.rotations || 0,
      rotationSecondsCurrent: p.rotationSecondsCurrent || 0,
      rotationSecondsOut: p.rotationSecondsOut || 0,
      lastRotation: p.lastRotation || 0,
      fatigue: p.isGK ? 0 : (p.fatigue || 0),
      fouls: p.fouls || 0,
      yc: p.yc || false,
      rc: p.rc || false,
      goals: p.goals || 0,
      assists: p.assists || 0
    }));

    if(players.length===0){
      for(let i=1;i<=14;i++){
        players.push({
          id:i,
          name:"Jogador "+i,
          active:false,
          isGK:(i===1),
          seconds:0,
          secondsOut:0,
          part1:0,
          part2:0,
          rotations:0,
          rotationSecondsCurrent:0,
          rotationSecondsOut:0,
          lastRotation:0,
          fatigue:0,
          fouls:0,
          yc:false,
          rc:false,
          goals:0,
          assists:0
        });
      }
    }

    buildPlayersDOM();
    updateTimerDisplay();
    updateHalfBadge();
    updateSummary();
    updateScoreUI();

    if(theme==="light"){
      document.body.classList.add("light-mode");
      document.getElementById("themeToggle").textContent = "üåû";
    }
    updateFloatingPlayBtn();
  }catch(e){
    console.error(e);
    localStorage.removeItem(STORAGE_KEY);
    loadData();
  }
}

/* Export PNG ‚Äì igual √† tua l√≥gica, com timeline e golos/assist√™ncias */
function exportPng(){
  const teamA = (document.getElementById("teamA").value||"Equipa A").trim();
  const teamB = (document.getElementById("teamB").value||"Equipa B").trim();
  const title = `${teamA} ${scoreA}‚Äì${scoreB} ${teamB}`;

  const headers = ["Jogador","1¬™ Parte","2¬™ Parte","Total em Campo","Tempo Fora","Rota√ß√µes","M√©dia","% Jogo","Workload"];
  const rows = [];
  const gameTime = computeGameTime();
  const ideal = computeIdealPerPlayer(gameTime);

  players.forEach(p=>{
    const total = p.part1 + p.part2;
    const avg = p.rotations>0 ? Math.floor(total/p.rotations) : 0;
    const percent = gameTime>0 ? ((p.seconds / gameTime)*100).toFixed(1)+"%" : "0.0%";
    const wlSec = computePlayerWorkload(p, gameTime, ideal);
    const wlMin = wlSec/60;
    const wTxt = `${wlMin>=0?"+":""}${wlMin.toFixed(1)}m`;
    const extra = [];
    if(p.goals>0) extra.push(`‚öΩ ${p.goals}`);
    if(p.assists>0) extra.push(`üë£ ${p.assists}`);

    rows.push([
      p.name+(p.isGK?' üß§':'')+(extra.length?(" ¬∑ "+extra.join(" ")): ""),
      formatTime(p.part1),
      formatTime(p.part2),
      formatTime(total),
      formatTime(p.secondsOut),
      String(p.rotations),
      formatTime(avg),
      percent,
      wTxt
    ]);
  });

  const timelineLines = timeline
    .sort((a,b)=>a.ts-b.ts)
    .map(ev=>{
      const halfTxt = ev.half === 1 ? "1¬™" : "2¬™";
      const baseTime = ev.clock || formatTime(remaining);
      let desc = "";
      if(ev.type === "GF_A"){
        desc = "Golo a favor";
      } else if(ev.type === "GA_A"){
        desc = "Golo sofrido";
      } else if(ev.type === "FK_P"){
        desc = "Falta";
      } else if(ev.type === "YC_P"){
        desc = "Cart√£o amarelo";
      } else if(ev.type === "RC_P"){
        desc = "Cart√£o vermelho";
      }
      if(ev.playerId){
        const p = players.find(x=>x.id===ev.playerId);
        if(p) desc += ` ‚Äì ${p.name}`;
      }
      if(ev.assistPlayerId){
        const a = players.find(x=>x.id===ev.assistPlayerId);
        if(a) desc += ` (assist√™ncia: ${a.name})`;
      }
      let onFieldText = "";
      if(ev.activeIds && Array.isArray(ev.activeIds) && ev.activeIds.length){
        const names = ev.activeIds.map(id=>{
          const pl = players.find(x=>x.id===id);
          return pl ? pl.name : `#${id}`;
        });
        onFieldText = ` | Em campo: ${names.join(", ")}`;
      }
      return `${halfTxt} parte ¬∑ ${baseTime} ‚Äì ${desc}${onFieldText}`;
    });

  const colWidths = [260,100,100,140,140,90,100,90,120];
  const tableWidth = colWidths.reduce((a,b)=>a+b,0);
  const margin = 20;
  const rowH = 32, headerH = 36;
  const titleH = 30;
  const padding = 12;
  const timelineBlockH = timelineLines.length ? (24 + timelineLines.length * 18) : 0;
  const tableHeight = padding + headerH + rows.length*rowH + padding;
  const contentWidth = tableWidth + padding*2;
  const cardHeight = tableHeight + (timelineBlockH ? (timelineBlockH + 16) : 0);
  const canvasW = Math.max(900, contentWidth + margin*2);
  const canvasH = margin + titleH + 10 + cardHeight + margin;

  const canvas = document.createElement("canvas");
  canvas.width = canvasW;
  canvas.height = canvasH;
  const ctx = canvas.getContext("2d");

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvasW,canvasH);

  ctx.fillStyle = "#000";
  ctx.font = "bold 22px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(title, canvasW/2, margin + titleH/2);

  const cardX = (canvasW - contentWidth)/2;
  const cardY = margin + titleH + 10;

  ctx.fillStyle = "#ffffff";
  ctx.strokeStyle = "#cccccc";
  ctx.lineWidth = 1;
  const r = 10;
  ctx.beginPath();
  ctx.moveTo(cardX+r,cardY);
  ctx.lineTo(cardX+contentWidth-r,cardY);
  ctx.quadraticCurveTo(cardX+contentWidth,cardY,cardX+contentWidth,cardY+r);
  ctx.lineTo(cardX+contentWidth,cardY+cardHeight-r);
  ctx.quadraticCurveTo(cardX+contentWidth,cardY+cardHeight,cardX+contentWidth-r,cardY+cardHeight);
  ctx.lineTo(cardX+r,cardY+cardHeight);
  ctx.quadraticCurveTo(cardX,cardY+cardHeight,cardX,cardY+cardHeight-r);
  ctx.lineTo(cardX,cardY+r);
  ctx.quadraticCurveTo(cardX,cardY,cardX+r,cardY);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  let x = cardX+padding;
  let y = cardY+padding;

  ctx.fillStyle = "#eeeeee";
  ctx.fillRect(x-1,y,tableWidth+2,headerH);
  ctx.fillStyle = "#000";
  ctx.font = "bold 14px Arial";
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";
  let cx = x;
  headers.forEach((h,i)=>{
    ctx.fillText(h, cx+6, y+headerH/2);
    cx += colWidths[i];
  });
  ctx.strokeStyle = "#cccccc";
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.lineTo(x+tableWidth,y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x,y+headerH);
  ctx.lineTo(x+tableWidth,y+headerH);
  ctx.stroke();

  ctx.font = "13px Arial";
  let rowY = y+headerH;
  rows.forEach(row=>{
    ctx.strokeStyle = "#e0e0e0";
    ctx.beginPath();
    ctx.moveTo(x,rowY+rowH);
    ctx.lineTo(x+tableWidth,rowY+rowH);
    ctx.stroke();

    let cxx = x;
    row.forEach((cell,i)=>{
      const text = String(cell);
      ctx.fillStyle = "#000";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      const maxW = colWidths[i]-10;
      let t = text;
      while(ctx.measureText(t).width > maxW && t.length>1){
        t = t.slice(0,-1);
      }
      if(t!==text) t = t.slice(0,-1)+"‚Ä¶";
      ctx.fillText(t, cxx+5, rowY+rowH/2);
      ctx.strokeStyle="#ececec";
      ctx.beginPath();
      ctx.moveTo(cxx,rowY);
      ctx.lineTo(cxx,rowY+rowH);
      ctx.stroke();
      cxx += colWidths[i];
    });
    ctx.beginPath();
    ctx.moveTo(x+tableWidth,rowY);
    ctx.lineTo(x+tableWidth,rowY+rowH);
    ctx.stroke();

    rowY += rowH;
  });

  if(timelineLines.length){
    const tlStartY = rowY + 16;
    ctx.font = "bold 14px Arial";
    ctx.fillStyle = "#000";
    ctx.fillText("Eventos de jogo (timeline)", x, tlStartY);
    ctx.font = "12px Arial";
    let ly = tlStartY + 18;
    timelineLines.forEach(line=>{
      ctx.fillText(line, x, ly);
      ly += 16;
    });
  }

  const a = document.createElement("a");
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.download = `Resumo_${teamA.replace(/\s+/g,"_")}_vs_${teamB.replace(/\s+/g,"_")}_${ts}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
}

/* Timeline ‚Äì equipa */
function handleTeamEvent(type){
  const half = firstHalf ? 1 : 2;
  const clock = formatTime(remaining);
  const activeIds = players.filter(p=>p.active).map(p=>p.id);

  if(type==="GF_A") scoreA++;
  if(type==="GA_A") scoreB++;

  const ev = {
    type,
    half,
    clock,
    activeIds,
    ts: Date.now()
  };

  addTimelineEvent(ev);
  updateScoreUI();
  saveData();
}

function setPendingEvent(type){
  pendingPlayerEvent = type;
  pendingGoalScorer = null;
  pendingAssistForGoal = null;
  updatePlayersUI();
}

/* Limpar tudo */
document.getElementById("tlClearBtn").onclick = ()=>{
  if(!confirm("Limpar marcador, faltas/cart√µes, golos/assist√™ncias e timeline?")) return;
  scoreA = 0;
  scoreB = 0;
  timeline = [];
  pendingAssistForGoal = null;
  pendingGoalScorer = null;
  pendingPlayerEvent = null;
  players.forEach(p=>{
    p.fouls = 0;
    p.yc = false;
    p.rc = false;
    p.goals = 0;
    p.assists = 0;
  });
  updateScoreUI();
  updatePlayersUI();
  updateSummary();
  saveData();
};

/* Liga√ß√µes de bot√µes base */
document.getElementById("resetBtn").onclick = resetTimer;
document.getElementById("intervalBtn").onclick = intervalTimer;
document.getElementById("addBtn").onclick = ()=>ensurePlayerCount(players.length+1);
document.getElementById("removeBtn").onclick = ()=>{ if(players.length>1) ensurePlayerCount(players.length-1); };
document.getElementById("themeToggle").onclick = toggleTheme;
document.getElementById("fullscreenBtn").onclick = toggleFullscreen;
document.getElementById("printBtn").onclick = exportPng;

document.getElementById("editNamesBtn").onclick = openEditPanel;
document.getElementById("closePanel").onclick = closeEditPanel;
document.getElementById("saveNamesBtn").onclick = saveNamesFromPanel;

const presetsPanel = document.getElementById("presetsPanel");
document.getElementById("presetsBtn").onclick = ()=>{
  renderPresetList();
  presetsPanel.classList.add("open");
  if(floatingPlayBtn) floatingPlayBtn.style.display = "none";
};
document.getElementById("closePresets").onclick = ()=>{
  presetsPanel.classList.remove("open");
  if(floatingPlayBtn) floatingPlayBtn.style.display = "block";
};
document.getElementById("savePresetBtn").onclick = savePreset;

document.getElementById("loadPanelBtn").onclick = ()=>{
  openLoadPanel();
  if(floatingPlayBtn) floatingPlayBtn.style.display = "none";
};
document.getElementById("closeLoad").onclick = ()=>{
  closeLoadPanel();
  if(floatingPlayBtn) floatingPlayBtn.style.display = "block";
};

/* Timeline buttons */
document.querySelectorAll("#timelineBar .tl-btn").forEach(btn=>{
  const type = btn.dataset.type;
  if(!type) return;
  if(btn.classList.contains("tl-player")){
    btn.addEventListener("click", ()=>{
      setPendingEvent(type);
    });
  }else{
    btn.addEventListener("click", ()=>{
      if(type === "GF_A"){
        startGoalFlow();
      }else{
        handleTeamEvent(type);
      }
    });
  }
});

/* Bot√£o flutuante */
if(floatingPlayBtn){
  floatingPlayBtn.onclick = ()=>{
    if(running) pauseTimer();
    else startTimer();
  };
}

window.addEventListener("beforeunload", saveData);
setInterval(saveData, 5000);

/* Boot */
loadData();
updateTimerDisplay();
updateHalfBadge();
updateScoreUI();
updateFloatingPlayBtn();
</script>
</body>
</html>
